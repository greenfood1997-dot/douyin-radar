<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŠ–éŸ³çˆ†æ¬¾é›·è¾¾ v4.0 Â· çœŸå®æ•°æ®ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0c0e14;
  --surface: #13151f;
  --surface2: #1a1d2a;
  --surface3: #212436;
  --border: #2a2d3e;
  --accent: #ff3355;
  --accent2: #00d4ff;
  --accent3: #7c3aed;
  --gold: #f59e0b;
  --green: #10b981;
  --text: #e8eaf0;
  --muted: #6b7280;
  --ink: #f0f2f8;
}

*{margin:0;padding:0;box-sizing:border-box;}

body {
  font-family:'Noto Sans SC',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

/* Animated mesh bg */
body::before {
  content:'';
  position:fixed;inset:0;
  background:
    radial-gradient(ellipse 800px 600px at 0% 0%, rgba(255,51,85,0.07) 0%,transparent 60%),
    radial-gradient(ellipse 600px 500px at 100% 100%, rgba(0,212,255,0.06) 0%,transparent 60%),
    radial-gradient(ellipse 500px 400px at 50% 50%, rgba(124,58,237,0.04) 0%,transparent 60%);
  pointer-events:none;z-index:0;
}

/* ====== HEADER ====== */
header {
  background:rgba(13,15,21,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:0 32px;
  height:60px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:12px;}
.logo-mark{
  width:34px;height:34px;
  background:linear-gradient(135deg,var(--accent),#ff6b35);
  border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;box-shadow:0 0 20px rgba(255,51,85,0.3);
}
.logo-text{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;letter-spacing:2px;}
.logo-badge{
  font-size:9px;letter-spacing:1px;font-family:'IBM Plex Mono',monospace;
  background:rgba(255,51,85,0.15);border:1px solid rgba(255,51,85,0.3);
  color:var(--accent);padding:2px 8px;border-radius:3px;
}
.header-center{display:flex;align-items:center;gap:6px;}
.nav-tab{
  padding:6px 16px;border-radius:6px;font-size:12px;font-weight:500;
  cursor:pointer;transition:all 0.15s;color:var(--muted);border:1px solid transparent;
}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{background:var(--surface2);border-color:var(--border);color:var(--text);}
.header-right{display:flex;align-items:center;gap:16px;}
.status-pill{
  display:flex;align-items:center;gap:6px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:20px;padding:5px 14px;font-size:11px;
  font-family:'IBM Plex Mono',monospace;color:var(--muted);
}
.pulse-dot{
  width:7px;height:7px;border-radius:50%;background:var(--green);
  animation:pulse 2s infinite;
}
.pulse-dot.red{background:var(--accent);}
.pulse-dot.yellow{background:var(--gold);}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,0.4);}50%{opacity:0.6;box-shadow:0 0 0 4px rgba(16,185,129,0);}}

/* ====== MAIN TABS ====== */
#view-monitor,#view-track,#view-analyze,#view-report,#view-account{display:none;}
#view-monitor.active,#view-track.active,#view-analyze.active,#view-report.active,#view-account.active{display:block;}

/* ====== LAYOUT ====== */
.page{
  max-width:1440px;margin:0 auto;
  padding:24px 32px;
  position:relative;z-index:1;
}

/* ====== SECTION HEADER ====== */
.section-hd{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:20px;
}
.section-title{
  font-size:16px;font-weight:700;
  display:flex;align-items:center;gap:8px;
}
.section-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.section-label{
  font-family:'IBM Plex Mono',monospace;
  font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--muted);margin-bottom:14px;
  display:flex;align-items:center;gap:8px;
}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ====== CARDS ====== */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:14px;overflow:hidden;
}
.card-hd{
  padding:16px 20px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.card-title{font-size:13px;font-weight:700;}
.card-body{padding:18px 20px;}

/* ====== MONITOR VIEW ====== */
.monitor-top{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;margin-bottom:20px;
}
.metric-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:18px 20px;
  position:relative;overflow:hidden;
  transition:border-color 0.2s;
}
.metric-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.metric-card.red::before{background:linear-gradient(90deg,var(--accent),transparent);}
.metric-card.blue::before{background:linear-gradient(90deg,var(--accent2),transparent);}
.metric-card.purple::before{background:linear-gradient(90deg,var(--accent3),transparent);}
.metric-card.gold::before{background:linear-gradient(90deg,var(--gold),transparent);}
.metric-lbl{font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;font-family:'IBM Plex Mono',monospace;}
.metric-val{font-size:26px;font-weight:900;font-family:'IBM Plex Mono',monospace;}
.metric-val.red{color:var(--accent);}
.metric-val.blue{color:var(--accent2);}
.metric-val.purple{color:var(--accent3);}
.metric-val.gold{color:var(--gold);}
.metric-change{font-size:11px;color:var(--green);margin-top:5px;}
.metric-change.down{color:var(--accent);}

.monitor-grid{
  display:grid;
  grid-template-columns:1fr 340px;
  gap:16px;
}

/* Live feed */
.live-header{
  display:flex;align-items:center;gap:10px;margin-bottom:4px;
}
.live-badge{
  display:flex;align-items:center;gap:5px;
  background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.25);
  border-radius:4px;padding:3px 10px;
  font-size:10px;font-weight:700;color:var(--accent);
  font-family:'IBM Plex Mono',monospace;letter-spacing:1px;
}

.feed-list{max-height:480px;overflow-y:auto;}
.feed-list::-webkit-scrollbar{width:3px;}
.feed-list::-webkit-scrollbar-track{background:transparent;}
.feed-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.feed-item{
  display:flex;gap:12px;align-items:flex-start;
  padding:12px 20px;border-bottom:1px solid rgba(42,45,62,0.5);
  cursor:pointer;transition:background 0.15s;
  animation:slideIn 0.35s ease forwards;opacity:0;
}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px);}to{opacity:1;transform:none;}}
.feed-item:hover{background:var(--surface2);}
.feed-item.new-item{animation:newEntry 0.5s ease forwards;}
@keyframes newEntry{
  0%{background:rgba(255,51,85,0.15);opacity:0;transform:translateY(-4px);}
  30%{background:rgba(255,51,85,0.08);}
  100%{background:transparent;opacity:1;transform:none;}
}

.feed-rank{
  width:26px;height:26px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;
  flex-shrink:0;margin-top:1px;
}
.r1{background:rgba(245,158,11,0.15);color:var(--gold);border:1px solid rgba(245,158,11,0.25);}
.r2{background:rgba(148,163,184,0.1);color:#94a3b8;}
.r3{background:rgba(205,100,60,0.1);color:#cd643c;}
.rn{background:var(--surface2);color:var(--muted);}

.feed-thumb{
  width:46px;height:62px;border-radius:6px;
  background:var(--surface2);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;position:relative;overflow:hidden;
}
.feed-thumb-overlay{
  position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,51,85,0.25),rgba(0,212,255,0.15));
}

.feed-info{flex:1;min-width:0;}
.feed-title{
  font-size:12px;font-weight:500;line-height:1.5;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
  margin-bottom:5px;
}
.feed-stats{display:flex;gap:10px;font-size:10px;color:var(--muted);}
.feed-heat{margin-top:5px;display:flex;align-items:center;gap:6px;}
.heat-bar{flex:1;height:2px;background:var(--surface3);border-radius:2px;overflow:hidden;}
.heat-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1s ease;}
.heat-num{font-size:9px;color:var(--accent);font-family:'IBM Plex Mono',monospace;min-width:24px;}

.feed-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.trend-up{color:var(--green);font-size:10px;font-weight:700;}
.trend-dn{color:var(--accent);font-size:10px;font-weight:700;}
.new-tag{
  font-size:9px;background:rgba(255,51,85,0.1);
  border:1px solid rgba(255,51,85,0.25);color:var(--accent);
  border-radius:3px;padding:1px 5px;font-family:'IBM Plex Mono',monospace;
}

/* Alert panel */
.alert-list{display:flex;flex-direction:column;gap:10px;}
.alert-item{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:12px 14px;
  border-left:3px solid var(--accent);
  animation:fadeIn 0.3s ease;
}
.alert-item.blue{border-left-color:var(--accent2);}
.alert-item.gold{border-left-color:var(--gold);}
.alert-item.green{border-left-color:var(--green);}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}} @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.alert-type{font-size:9px;letter-spacing:2px;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-bottom:5px;}
.alert-text{font-size:12px;line-height:1.6;color:var(--text);}
.alert-time{font-size:10px;color:var(--muted);margin-top:4px;font-family:'IBM Plex Mono',monospace;}

/* Monitor controls */
.monitor-ctrl{display:flex;gap:10px;align-items:center;}
.interval-select{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;padding:6px 12px;color:var(--text);
  font-size:12px;outline:none;cursor:pointer;
  font-family:'Noto Sans SC',sans-serif;
}
.btn{
  padding:7px 16px;border-radius:6px;border:1px solid transparent;
  font-size:12px;font-weight:600;cursor:pointer;
  font-family:'Noto Sans SC',sans-serif;transition:all 0.15s;
}
.btn-red{background:var(--accent);color:white;}
.btn-red:hover{opacity:0.85;}
.btn-ghost{background:var(--surface2);border-color:var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--accent2);}
.btn-sm{padding:5px 12px;font-size:11px;}

/* ====== TRACK VIEW ====== */
.track-grid-full{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:12px;margin-bottom:20px;
}
.track-card{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:12px;padding:16px;cursor:pointer;
  transition:all 0.2s;text-align:center;position:relative;
  overflow:hidden;
}
.track-card::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,51,85,0.08),rgba(0,212,255,0.05));
  opacity:0;transition:opacity 0.2s;
}
.track-card:hover::before{opacity:1;}
.track-card:hover{border-color:rgba(255,51,85,0.4);transform:translateY(-2px);}
.track-card.selected{border-color:var(--accent);background:rgba(255,51,85,0.08);}
.track-card.selected::before{opacity:1;}
.track-emoji{font-size:28px;margin-bottom:8px;}
.track-name{font-size:13px;font-weight:700;margin-bottom:4px;}
.track-heat{
  font-size:10px;color:var(--muted);
  font-family:'IBM Plex Mono',monospace;
}
.track-heat-bar{
  height:3px;border-radius:3px;margin-top:8px;
  background:var(--surface2);overflow:hidden;
}
.track-heat-fill{height:100%;border-radius:3px;}
.track-check{
  position:absolute;top:8px;right:8px;
  width:18px;height:18px;border-radius:50%;
  background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-size:10px;color:white;opacity:0;transition:opacity 0.2s;
}
.track-card.selected .track-check{opacity:1;}

.track-compare{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:20px;margin-top:16px;
}
.compare-bars{display:flex;flex-direction:column;gap:12px;margin-top:12px;}
.compare-row{display:flex;align-items:center;gap:12px;}
.compare-name{font-size:12px;min-width:80px;color:var(--text);}
.compare-bar{flex:1;height:24px;background:var(--surface2);border-radius:4px;overflow:hidden;position:relative;}
.compare-fill{
  height:100%;border-radius:4px;
  display:flex;align-items:center;padding-left:8px;
  font-size:10px;font-weight:700;color:white;
  transition:width 1s ease;
}
.compare-score{font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--muted);min-width:36px;text-align:right;}

/* Multi-select info bar */
.track-selected-bar{
  background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.2);
  border-radius:8px;padding:12px 16px;
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;
}
.track-selected-chips{display:flex;gap:6px;flex-wrap:wrap;}
.selected-chip{
  background:rgba(255,51,85,0.12);border:1px solid rgba(255,51,85,0.25);
  border-radius:4px;padding:3px 10px;font-size:11px;color:var(--accent);
  display:flex;align-items:center;gap:5px;
}
.selected-chip .rm{cursor:pointer;opacity:0.6;}
.selected-chip .rm:hover{opacity:1;}

/* ====== ANALYZE VIEW ====== */
.analyze-layout{
  display:grid;
  grid-template-columns:1fr 380px;
  gap:16px;
  min-height:calc(100vh - 200px);
}

.step-wizard{
  display:flex;gap:0;
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;overflow:hidden;margin-bottom:16px;
}
.wizard-step{
  flex:1;padding:12px 16px;font-size:12px;
  display:flex;align-items:center;gap:8px;
  color:var(--muted);cursor:pointer;
  border-right:1px solid var(--border);transition:all 0.15s;
}
.wizard-step:last-child{border-right:none;}
.wizard-step.active{background:rgba(255,51,85,0.08);color:var(--accent);}
.wizard-step.done{color:var(--green);}
.wizard-num{
  width:20px;height:20px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:700;font-family:'IBM Plex Mono',monospace;
  background:var(--surface2);border:1px solid var(--border);flex-shrink:0;
}
.wizard-step.active .wizard-num{background:var(--accent);color:white;border-color:var(--accent);}
.wizard-step.done .wizard-num{background:var(--green);color:white;border-color:var(--green);}

.source-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.source-card{
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:10px;padding:14px;cursor:pointer;
  transition:all 0.15s;text-align:center;
}
.source-card:hover{border-color:var(--accent2);}
.source-card.active{border-color:var(--accent2);background:rgba(0,212,255,0.06);}
.source-icon{font-size:22px;margin-bottom:6px;}
.source-name{font-size:12px;font-weight:700;}
.source-desc{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.5;}

.guide-box{
  background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.15);
  border-radius:8px;padding:14px 18px;margin-top:12px;
}
.guide-title{font-size:12px;font-weight:700;color:var(--accent2);margin-bottom:10px;}
.guide-step{display:flex;gap:10px;align-items:flex-start;font-size:12px;color:var(--text);line-height:1.6;margin-bottom:7px;}
.guide-num{
  width:18px;height:18px;background:var(--accent2);color:black;
  border-radius:50%;font-size:9px;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;
}

.paste-area{
  width:100%;min-height:160px;
  background:var(--surface2);border:1.5px dashed var(--border);
  border-radius:8px;padding:14px;color:var(--text);
  font-family:'Noto Sans SC',sans-serif;font-size:13px;
  outline:none;resize:vertical;line-height:1.7;
  transition:border-color 0.2s;
}
.paste-area:focus{border-color:var(--accent2);border-style:solid;}
.paste-area::placeholder{color:var(--muted);}

/* ====== REPORT VIEW ====== */
.report-layout{
  display:grid;grid-template-columns:280px 1fr;gap:16px;
}
.report-sidebar{display:flex;flex-direction:column;gap:10px;}
.report-item{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:12px 14px;cursor:pointer;
  transition:all 0.15s;
}
.report-item:hover{border-color:var(--border);background:var(--surface2);}
.report-item.active{border-color:var(--accent);background:rgba(255,51,85,0.06);}
.report-item-track{font-size:12px;font-weight:700;margin-bottom:3px;}
.report-item-meta{font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}

.report-main{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.report-main-hd{
  padding:20px 24px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.report-content{padding:24px;}

/* ====== AI SIDEBAR ====== */
.ai-sidebar{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;display:flex;flex-direction:column;
  height:calc(100vh - 200px);overflow:hidden;
}
.ai-hd{
  padding:16px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
.ai-title{font-size:13px;font-weight:700;}
.ai-chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.ai-chat::-webkit-scrollbar{width:3px;}
.ai-chat::-webkit-scrollbar-thumb{background:var(--border);}
.msg-ai .msg-lbl{font-size:9px;letter-spacing:2px;color:var(--accent2);font-family:'IBM Plex Mono',monospace;margin-bottom:5px;}
.msg-ai .msg-bubble{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:2px 10px 10px 10px;padding:12px 14px;
  font-size:12px;line-height:1.8;color:var(--text);
}
.msg-user .msg-lbl{font-size:9px;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:5px;text-align:right;}
.msg-user .msg-bubble{
  background:var(--surface3);border:1px solid var(--border);
  border-radius:10px 2px 10px 10px;padding:12px 14px;
  font-size:12px;line-height:1.8;color:var(--text);
}
.loading-bubble{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:2px 10px 10px 10px;padding:14px;
  display:flex;gap:5px;align-items:center;
}
.ld{width:6px;height:6px;border-radius:50%;background:var(--accent2);animation:ld 1.2s infinite;}
.ld:nth-child(2){animation-delay:0.2s;}.ld:nth-child(3){animation-delay:0.4s;}
@keyframes ld{0%,80%,100%{transform:scale(0.5);opacity:0.3}40%{transform:scale(1);opacity:1}}

.quick-tags{display:flex;flex-wrap:wrap;gap:5px;padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.qtag{
  padding:4px 10px;border-radius:4px;font-size:10px;
  border:1px solid var(--border);cursor:pointer;transition:all 0.15s;
  color:var(--muted);background:var(--surface2);
}
.qtag:hover{border-color:var(--accent2);color:var(--accent2);}

.chat-bottom{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.chat-input{
  flex:1;background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;padding:9px 12px;color:var(--text);
  font-size:12px;font-family:'Noto Sans SC',sans-serif;
  outline:none;resize:none;height:40px;transition:border-color 0.2s;
}
.chat-input:focus{border-color:var(--accent2);}
.send-btn{
  width:40px;height:40px;background:var(--accent);border:none;
  border-radius:6px;color:white;font-size:14px;cursor:pointer;
  flex-shrink:0;transition:opacity 0.15s;
}
.send-btn:hover{opacity:0.8;}

/* ====== EMPTY / MISC ====== */
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:32px;margin-bottom:12px;opacity:0.4;}
.empty-text{font-size:12px;line-height:1.8;}

.tag{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 10px;border-radius:4px;font-size:10px;
  background:rgba(255,51,85,0.08);color:var(--accent);
  border:1px solid rgba(255,51,85,0.2);
}
.tag.blue{background:rgba(0,212,255,0.08);color:var(--accent2);border-color:rgba(0,212,255,0.2);}
.tag.green{background:rgba(16,185,129,0.08);color:var(--green);border-color:rgba(16,185,129,0.2);}

.divider{height:1px;background:var(--border);margin:16px 0;}

/* Scrollbar global */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

@media(max-width:900px){
  .monitor-grid,.analyze-layout,.report-layout{grid-template-columns:1fr;}
  .monitor-top{grid-template-columns:repeat(2,1fr);}
  .page{padding:16px;}
  header{padding:0 16px;}
  .track-grid-full{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}
}

/* ====== AUTH OVERLAY ====== */
#authOverlay {
  position:fixed;inset:0;z-index:9999;
  background:#0c0e14;
  display:flex;align-items:center;justify-content:center;
}
#authOverlay::before {
  content:'';position:fixed;inset:0;
  background:
    radial-gradient(ellipse 800px 600px at 0% 0%, rgba(255,51,85,0.1) 0%,transparent 60%),
    radial-gradient(ellipse 600px 500px at 100% 100%, rgba(0,212,255,0.08) 0%,transparent 60%);
  pointer-events:none;
}
.auth-box {
  position:relative;z-index:1;width:100%;max-width:420px;
  background:rgba(19,21,31,0.97);border:1px solid #2a2d3e;
  border-radius:20px;padding:40px 36px;
  box-shadow:0 24px 80px rgba(0,0,0,0.6);margin:20px;
}
.auth-logo{text-align:center;margin-bottom:28px;}
.auth-logo-icon{width:52px;height:52px;background:linear-gradient(135deg,#ff3355,#7c3aed);border-radius:14px;display:inline-flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;}
.auth-logo-title{font-size:20px;font-weight:800;color:#f0f2f8;}
.auth-logo-sub{font-size:11px;color:#6b7280;margin-top:4px;}
.auth-tabs{display:flex;background:#13151f;border:1px solid #2a2d3e;border-radius:10px;padding:4px;margin-bottom:24px;gap:4px;}
.auth-tab{flex:1;padding:9px;border:none;background:transparent;color:#6b7280;font-size:13px;font-weight:600;cursor:pointer;border-radius:7px;transition:all 0.2s;font-family:'Noto Sans SC',sans-serif;}
.auth-tab.active{background:linear-gradient(135deg,#ff3355,#c42d48);color:#fff;}
.auth-method-tabs{display:flex;gap:8px;margin-bottom:20px;}
.auth-method-tab{flex:1;padding:8px;border:1px solid #2a2d3e;background:transparent;color:#6b7280;font-size:11px;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.2s;font-family:'Noto Sans SC',sans-serif;text-align:center;}
.auth-method-tab.active{border-color:#ff3355;color:#ff3355;background:rgba(255,51,85,0.08);}
.auth-field{margin-bottom:14px;}
.auth-field label{display:block;font-size:11px;font-weight:700;color:#9ca3af;margin-bottom:6px;}
.auth-field input{width:100%;padding:11px 14px;background:#1a1d2a;border:1px solid #2a2d3e;border-radius:9px;color:#e8eaf0;font-size:13px;outline:none;transition:border-color 0.2s;font-family:'Noto Sans SC',sans-serif;}
.auth-field input:focus{border-color:#ff3355;}
.auth-field input::placeholder{color:#4b5563;}
.auth-sms-row{display:flex;gap:8px;}
.auth-sms-row input{flex:1;}
.auth-send-code{padding:11px 14px;background:#1a1d2a;border:1px solid #2a2d3e;border-radius:9px;color:#00d4ff;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all 0.2s;font-family:'Noto Sans SC',sans-serif;}
.auth-send-code:hover{border-color:#00d4ff;background:rgba(0,212,255,0.08);}
.auth-send-code:disabled{color:#4b5563;border-color:#2a2d3e;cursor:not-allowed;}
.auth-btn{width:100%;padding:13px;margin-top:8px;background:linear-gradient(135deg,#ff3355,#c42d48);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:800;cursor:pointer;transition:opacity 0.2s;font-family:'Noto Sans SC',sans-serif;}
.auth-btn:hover{opacity:0.88;}
.auth-btn:disabled{opacity:0.5;cursor:not-allowed;}
.auth-error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:11px;padding:9px 12px;border-radius:8px;margin-bottom:12px;display:none;}
.auth-success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#34d399;font-size:11px;padding:9px 12px;border-radius:8px;margin-bottom:12px;display:none;}
.auth-footer{text-align:center;margin-top:20px;font-size:11px;color:#4b5563;}
.auth-footer a{color:#ff3355;cursor:pointer;}
</style>
</head>
<body>

<!-- ====== AUTH OVERLAY ====== -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon">ğŸ¯</div>
      <div class="auth-logo-title">DOUYIN RADAR</div>
      <div class="auth-logo-sub">æŠ–éŸ³çˆ†æ¬¾é›·è¾¾ Â· ç™»å½•åå¼€å§‹ä½¿ç”¨</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchAuthMode('login')">ç™»å½•</button>
      <button class="auth-tab" id="tabRegister" onclick="switchAuthMode('register')">æ³¨å†Œ</button>
    </div>
    <div class="auth-method-tabs">
      <button class="auth-method-tab active" id="methodEmail" onclick="switchMethod('email')">ğŸ“§ é‚®ç®±</button>
      <button class="auth-method-tab" id="methodPhone" onclick="switchMethod('phone')">ğŸ“± æ‰‹æœºå·</button>
    </div>
    <div id="authError" class="auth-error"></div>
    <div id="authSuccess" class="auth-success"></div>
    <div id="emailForm">
      <div class="auth-field" id="usernameField" style="display:none;">
        <label>æ˜µç§°ï¼ˆé€‰å¡«ï¼‰</label>
        <input type="text" id="inputUsername" placeholder="ä½ çš„æ˜µç§°" />
      </div>
      <div class="auth-field">
        <label>é‚®ç®±</label>
        <input type="email" id="inputEmail" placeholder="your@email.com" />
      </div>
      <div class="auth-field">
        <label>å¯†ç </label>
        <input type="password" id="inputPassword" placeholder="è‡³å°‘6ä½å¯†ç " />
      </div>
      <button class="auth-btn" id="emailSubmitBtn" onclick="handleEmailAuth()">ç™»å½•</button>
    </div>
    <div id="phoneForm" style="display:none;">
      <div class="auth-field">
        <label>æ‰‹æœºå·</label>
        <div class="auth-sms-row">
          <input type="tel" id="inputPhone" placeholder="+86 13800138000" />
          <button class="auth-send-code" id="sendCodeBtn" onclick="sendSmsCode()">å‘é€éªŒè¯ç </button>
        </div>
      </div>
      <div class="auth-field" id="codeField" style="display:none;">
        <label>éªŒè¯ç </label>
        <input type="text" id="inputCode" placeholder="6ä½éªŒè¯ç " maxlength="6" />
      </div>
      <button class="auth-btn" id="phoneSubmitBtn" onclick="handlePhoneAuth()" style="display:none;">éªŒè¯å¹¶ç™»å½•</button>
    </div>
    <div class="auth-footer">ç™»å½•å³åŒæ„ <a>ç”¨æˆ·åè®®</a> å’Œ <a>éšç§æ”¿ç­–</a></div>
  </div>
</div>


<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">ğŸ¯</div>
    <div>
      <div class="logo-text">DOUYIN RADAR</div>
    </div>
    <div class="logo-badge">v4.0</div>
  </div>
  <div class="header-center">
    <div class="nav-tab active" onclick="switchView('monitor',this)">ğŸ“¡ å®æ—¶ç›‘æµ‹</div>
    <div class="nav-tab" onclick="switchView('track',this)">ğŸ èµ›é“é€‰å–</div>
    <div class="nav-tab" onclick="switchView('analyze',this)">ğŸ’¥ çˆ†æ¬¾æ‹†è§£</div>
    <div class="nav-tab" onclick="switchView('account',this)">ğŸ‘¤ è´¦å·ç›‘æµ‹</div>
  </div>
  <div class="header-right">
    <div class="status-pill">
      <div class="pulse-dot" id="monStatusDot"></div>
      <span id="monStatusText">ç›‘æµ‹å°±ç»ª</span>
    </div>
    <button onclick="openDataSourceModal()" id="dsStatusBtn"
      style="padding:5px 12px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);border-radius:6px;font-size:10px;color:#818cf8;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
      ğŸ“¡ æ•°æ®æº
    </button>
    <div class="status-pill" style="font-size:10px;" id="clockPill">--:--:--</div>
  </div>
</header>

<!-- ========== VIEW: MONITOR ========== -->
<div id="view-monitor" class="active">
<div class="page">

  <!-- Top metrics -->
  <div class="monitor-top">
    <div class="metric-card red">
      <div class="metric-lbl">ä»Šæ—¥çˆ†æ¬¾æ•°</div>
      <div class="metric-val red" id="mTotal">0</div>
      <div class="metric-change" id="mTotalChange">â†‘ å®æ—¶è¿½è¸ªä¸­</div>
    </div>
    <div class="metric-card blue">
      <div class="metric-lbl">ç›‘æµ‹èµ›é“</div>
      <div class="metric-val blue" id="mTrackCount" style="font-size:20px;padding-top:4px">â€”</div>
      <div class="metric-change">å·²æ¿€æ´»èµ›é“</div>
    </div>
    <div class="metric-card purple">
      <div class="metric-lbl">å¹³å‡çƒ­åº¦æŒ‡æ•°</div>
      <div class="metric-val purple" id="mAvgHeat">â€”</div>
      <div class="metric-change" id="mHeatChange">AI å®æ—¶è®¡ç®—</div>
    </div>
    <div class="metric-card gold">
      <div class="metric-lbl">ä¸‹æ¬¡åˆ·æ–°</div>
      <div class="metric-val gold" id="mCountdown" style="font-size:20px;padding-top:4px">â€”</div>
      <div class="metric-change">è‡ªåŠ¨ç›‘æµ‹å‘¨æœŸ</div>
    </div>
  </div>

  <div class="monitor-grid">
    <!-- Live feed -->
    <div class="card">
      <div class="card-hd">
        <div>
          <div class="live-header">
            <div style="display:flex;align-items:center;gap:8px;"><div class="card-title">ğŸ”¥ çˆ†æ¬¾è§†é¢‘å®æ—¶æ¦œ</div><span id="dataSourceBadge" style="font-size:9px;background:#1a1d2a;color:#9ca3af;border:1px solid #2a2d3e;border-radius:4px;padding:2px 7px;font-family:'IBM Plex Mono',monospace;">æ¼”ç¤ºæ•°æ®</span></div>
            <div class="live-badge"><div class="pulse-dot" style="width:5px;height:5px;animation:pulse 1s infinite;"></div>LIVE</div>
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">å½“å‰èµ›é“ï¼š<span id="liveTrackLabel" style="color:var(--accent2)">æœªé€‰æ‹©</span></div>
        </div>
        <div class="monitor-ctrl">
          <select class="interval-select" id="intervalSelect" onchange="updateInterval()">
            <option value="30">æ¯30ç§’</option>
            <option value="60" selected>æ¯1åˆ†é’Ÿ</option>
            <option value="300">æ¯5åˆ†é’Ÿ</option>
            <option value="600">æ¯10åˆ†é’Ÿ</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="manualRefresh()">â†» åˆ·æ–°</button>
          <button class="btn btn-red btn-sm" id="monToggleBtn" onclick="toggleMonitor()">â–¶ å¼€å§‹ç›‘æµ‹</button>
        </div>
      </div>

      <!-- Filter bar -->
      <div style="display:flex;gap:6px;padding:12px 20px;border-bottom:1px solid var(--border);overflow-x:auto;">
        <button class="btn btn-red btn-sm" onclick="setFeedFilter(this,'all')" id="ff-all">å…¨éƒ¨</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'new')" id="ff-new">ğŸ†• æ–°è¿›æ¦œ</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'rising')" id="ff-rising">ğŸš€ æ€¥é€Ÿä¸Šå‡</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'hot')" id="ff-hot">ğŸ”¥ æŒç»­çˆ†æ¬¾</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'ai')" id="ff-ai">âœ¨ AIç²¾é€‰</button>
      </div>

      <div class="feed-list" id="feedList">
        <div class="empty">
          <div class="empty-icon">ğŸ“¡</div>
          <div class="empty-text">è¯·å…ˆåœ¨ã€Œèµ›é“é€‰å–ã€ä¸­<br>é€‰æ‹©ä½ è¦ç›‘æµ‹çš„èµ›é“<br>ç„¶åç‚¹å‡»ã€Œå¼€å§‹ç›‘æµ‹ã€</div>
        </div>
      </div>
    </div>

    <!-- Right: alerts + stats -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <!-- Alert panel -->
      <div class="card">
        <div class="card-hd">
          <div class="card-title">âš¡ å®æ—¶é¢„è­¦</div>
          <span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;" id="alertCount">0 æ¡</span>
        </div>
        <div class="card-body" style="padding:12px;">
          <div class="alert-list" id="alertList">
            <div class="empty" style="padding:24px;">
              <div class="empty-icon" style="font-size:24px;">ğŸ””</div>
              <div class="empty-text">æš‚æ— é¢„è­¦</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trend mini chart -->
      <div class="card">
        <div class="card-hd"><div class="card-title">ğŸ“ˆ çƒ­åº¦è¶‹åŠ¿ï¼ˆä»Šæ—¥ï¼‰</div></div>
        <div class="card-body">
          <canvas id="trendChart" height="100" style="width:100%;"></canvas>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <span style="font-size:10px;color:var(--muted)">00:00</span>
            <span style="font-size:10px;color:var(--muted)">12:00</span>
            <span style="font-size:10px;color:var(--muted)">ç°åœ¨</span>
          </div>
        </div>
      </div>

      <!-- Track heat ranking -->
      <div class="card">
        <div class="card-hd"><div class="card-title">ğŸ† èµ›é“çƒ­åº¦æ’è¡Œ</div></div>
        <div class="card-body" id="trackHeatRank">
          <div class="empty" style="padding:20px;"><div class="empty-text">é€‰æ‹©èµ›é“åæ˜¾ç¤º</div></div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- ========== VIEW: TRACK ========== -->
<div id="view-track">
<div class="page">

  <div class="section-hd">
    <div>
      <div class="section-title">ğŸ èµ›é“é€‰å–ä¸­å¿ƒ</div>
      <div class="section-sub">å¯å¤šé€‰èµ›é“åŒæ—¶ç›‘æµ‹ï¼Œæ”¯æŒè‡ªå®šä¹‰èµ›é“å’Œæ¨ªå‘å¯¹æ¯”</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost" onclick="clearAllTracks()">æ¸…ç©ºé€‰æ‹©</button>
      <button class="btn btn-red" onclick="confirmTracks()">âœ“ ç¡®è®¤é€‰å–å¹¶å¼€å§‹ç›‘æµ‹</button>
    </div>
  </div>

  <!-- Selected bar -->
  <div class="track-selected-bar" id="selectedBar" style="display:none;">
    <div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">å·²é€‰èµ›é“ï¼ˆæœ€å¤š5ä¸ªï¼‰</div>
      <div class="track-selected-chips" id="selectedChips"></div>
    </div>
    <button class="btn btn-red btn-sm" onclick="confirmTracks()">å¼€å§‹ç›‘æµ‹ â†’</button>
  </div>

  <div class="section-label">çƒ­é—¨èµ›é“ Â· ç‚¹å‡»é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰</div>
  <div class="track-grid-full" id="trackGrid"></div>

  <!-- Custom track -->
  <div class="section-label" style="margin-top:8px;">è‡ªå®šä¹‰èµ›é“</div>
  <div style="display:flex;gap:10px;margin-bottom:24px;">
    <input type="text" id="customTrackInput" placeholder="è¾“å…¥èµ›é“åç§°ï¼Œå¦‚ï¼šèŒåœºå¹²è´§ã€æ‰‹å·¥DIYã€å›½é£å¤é£..." style="flex:1;max-width:340px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 14px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;outline:none;" />
    <button class="btn btn-ghost" onclick="addCustomTrack()">+ æ·»åŠ è‡ªå®šä¹‰</button>
  </div>

  <!-- Compare panel -->
  <div class="track-compare" id="comparePanel" style="display:none;">
    <div class="section-label">èµ›é“çƒ­åº¦å¯¹æ¯”</div>
    <div class="compare-bars" id="compareBars"></div>
  </div>

</div>
</div>

<!-- ========== VIEW: ANALYZE (çˆ†æ¬¾æ‹†è§£) ========== -->
<div id="view-analyze">
<div class="page">

  <!-- çˆ†æ¬¾æ‹†è§£ ä¸»æ ‡é¢˜ -->
  <div class="section-hd" style="margin-bottom:16px;">
    <div>
      <div class="section-title">ğŸ’¥ çˆ†æ¬¾æ‹†è§£å·¥ä½œå°</div>
      <div class="section-sub">ç²˜è´´æŠ–éŸ³é“¾æ¥ â†’ AIæ™ºèƒ½æ‹†è§£ç»“æ„ â†’ é€‰å“å¡«å…… â†’ ä¸€é”®ç”Ÿæˆè„šæœ¬</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="dsAiBadge" style="font-size:10px;padding:4px 12px;border-radius:20px;background:rgba(124,58,237,0.12);border:1px solid rgba(124,58,237,0.3);color:#a78bfa;font-family:'IBM Plex Mono',monospace;">
        âš¡ DeepSeek ç®—åŠ›
      </div>
      <button class="btn btn-ghost btn-sm" onclick="openDsKeyModal()">ğŸ”‘ é…ç½®DeepSeek Key</button>
    </div>
  </div>

  <!-- è¿›åº¦æ­¥éª¤æ¡ -->
  <div class="step-wizard" style="margin-bottom:20px;">
    <div class="wizard-step active" id="ws1"><div class="wizard-num" id="wn1">1</div>ç²˜è´´æŠ–éŸ³é“¾æ¥</div>
    <div class="wizard-step" id="ws2"><div class="wizard-num" id="wn2">2</div>AIæ‹†è§£ç»“æ„</div>
    <div class="wizard-step" id="ws3"><div class="wizard-num" id="wn3">3</div>é€‰æ‹©äº§å“</div>
    <div class="wizard-step" id="ws4"><div class="wizard-num" id="wn4">4</div>ç”Ÿæˆè„šæœ¬</div>
  </div>

  <div class="analyze-layout">
    <!-- å·¦ä¾§ä¸»å·¥ä½œåŒº -->
    <div>

      <!-- STEP 1: è¾“å…¥é“¾æ¥ -->
      <div id="az-step1">
        <div class="card" style="margin-bottom:14px;">
          <div class="card-hd">
            <div class="card-title">ğŸ”— ç²˜è´´æŠ–éŸ³çˆ†æ¬¾é“¾æ¥</div>
            <span class="tag blue">æ”¯æŒè§†é¢‘åˆ†äº«é“¾æ¥</span>
          </div>
          <div class="card-body">
            <div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);border-radius:8px;padding:10px 14px;font-size:11px;color:var(--accent2);margin-bottom:14px;line-height:1.8;">
              ğŸ“± æ‰“å¼€æŠ–éŸ³ï¼Œæ‰¾åˆ°ä½ æƒ³æ‹†è§£çš„çˆ†æ¬¾è§†é¢‘ï¼Œç‚¹å‡»ã€Œåˆ†äº«ã€â†’ã€Œå¤åˆ¶é“¾æ¥ã€ï¼Œç²˜è´´åˆ°ä¸‹æ–¹
            </div>
            <div style="display:flex;gap:10px;align-items:flex-start;">
              <input type="text" id="douyinUrlInput"
                placeholder="https://v.douyin.com/xxxxx/ æˆ–å®Œæ•´é“¾æ¥..."
                style="flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;outline:none;transition:border-color 0.2s;"
                onfocus="this.style.borderColor='var(--accent2)'" onblur="this.style.borderColor='var(--border)'"
              />
              <button class="btn btn-red" onclick="startBreakdown()" style="padding:12px 24px;white-space:nowrap;">
                ğŸš€ AIæ‹†è§£
              </button>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
              <span style="font-size:11px;color:var(--muted);">æˆ–ç›´æ¥ç²˜è´´è§†é¢‘æ ‡é¢˜/æè¿°æ–‡å­—ï¼š</span>
            </div>
            <textarea id="douyinTextInput" class="paste-area" style="min-height:100px;margin-top:8px;"
              placeholder="ä¹Ÿå¯ä»¥ç›´æ¥æŠŠè§†é¢‘æ ‡é¢˜ã€æ–‡æ¡ˆã€è¯„è®ºåŒºçˆ†æ¬¾è¯„è®ºç­‰æ–‡å­—ç²˜è´´è¿›æ¥ï¼ŒAIä¼šè‡ªåŠ¨åˆ†æçˆ†æ¬¾ç»“æ„..."></textarea>
          </div>
        </div>
      </div>

      <!-- STEP 2: æ‹†è§£ç»“æœ -->
      <div id="az-step2" style="display:none;">
        <div class="card" style="margin-bottom:14px;">
          <div class="card-hd">
            <div class="card-title">ğŸ§¬ çˆ†æ¬¾ç»“æ„æ‹†è§£æŠ¥å‘Š</div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" onclick="backToStep1()">â† é‡æ–°è¾“å…¥</button>
              <button class="btn btn-red btn-sm" onclick="copyStructure()">ğŸ“‹ ä¸€é”®å¤åˆ»ç»“æ„</button>
            </div>
          </div>
          <div id="breakdownResult" class="card-body" style="font-size:13px;line-height:1.9;"></div>
        </div>

        <!-- çˆ†æ¬¾ç»“æ„å¯è§†åŒ–å¡ç‰‡ -->
        <div id="structureCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:14px;"></div>

        <div style="text-align:center;margin-bottom:6px;">
          <button class="btn btn-red" onclick="goToProductSelect()" style="padding:12px 36px;font-size:14px;">
            ğŸ›ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æˆ‘çš„äº§å“ â†’
          </button>
        </div>
      </div>

      <!-- STEP 3: é€‰å“ -->
      <div id="az-step3" style="display:none;">
        <div class="card" style="margin-bottom:14px;">
          <div class="card-hd">
            <div class="card-title">ğŸ›ï¸ é€‰æ‹©ä½ çš„äº§å“</div>
            <button class="btn btn-ghost btn-sm" onclick="backToStep2()">â† è¿”å›æ‹†è§£ç»“æœ</button>
          </div>
          <div class="card-body">
            <div style="font-size:12px;color:var(--muted);margin-bottom:12px;">åŸºäºçˆ†æ¬¾ç»“æ„ï¼ŒAIä¼šæœç´¢æ­¤äº§å“çš„æ ¸å¿ƒå–ç‚¹ï¼Œå¹¶è‡ªåŠ¨å¡«å……åˆ°è„šæœ¬æ¡†æ¶ä¸­</div>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;">
              <input type="text" id="productInput"
                placeholder="è¾“å…¥äº§å“åç§°ï¼Œå¦‚ï¼šä¹³é…¸èŒé¢è†œã€ç©ºæ°”ç‚¸é”…ã€æ¤ç‰©è›‹ç™½å¥¶..."
                style="flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:11px 14px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;"
                onfocus="this.style.borderColor='var(--accent2)'" onblur="this.style.borderColor='var(--border)'"
              />
              <button class="btn btn-red" onclick="searchProductSellPoints()" style="white-space:nowrap;padding:11px 20px;">
                ğŸ” æœç´¢å–ç‚¹
              </button>
            </div>

            <!-- å¿«æ·é€‰å“æ ‡ç­¾ -->
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;">
              <span style="font-size:11px;color:var(--muted);">å¿«é€Ÿé€‰æ‹©ï¼š</span>
              <span class="qtag" onclick="quickProduct('é˜²æ™’éœœ')">é˜²æ™’éœœ</span>
              <span class="qtag" onclick="quickProduct('æ´—å‘æ°´')">æ´—å‘æ°´</span>
              <span class="qtag" onclick="quickProduct('é¢è†œ')">é¢è†œ</span>
              <span class="qtag" onclick="quickProduct('å‡è‚¥èŒ¶')">å‡è‚¥èŒ¶</span>
              <span class="qtag" onclick="quickProduct('ç©ºæ°”ç‚¸é”…')">ç©ºæ°”ç‚¸é”…</span>
              <span class="qtag" onclick="quickProduct('è“ç‰™è€³æœº')">è“ç‰™è€³æœº</span>
              <span class="qtag" onclick="quickProduct('è¿åŠ¨å†…è¡£')">è¿åŠ¨å†…è¡£</span>
              <span class="qtag" onclick="quickProduct('å„¿ç«¥é›¶é£Ÿ')">å„¿ç«¥é›¶é£Ÿ</span>
            </div>

            <!-- äº§å“å–ç‚¹å±•ç¤º -->
            <div id="productSellPoints" style="display:none;">
              <div style="font-size:11px;color:var(--accent2);font-family:'IBM Plex Mono',monospace;letter-spacing:1px;margin-bottom:10px;">â–¸ AI å…¨ç½‘æœç´¢åˆ°çš„æ ¸å¿ƒå–ç‚¹</div>
              <div id="sellPointsList"></div>
              <div style="margin-top:16px;text-align:center;">
                <button class="btn btn-red" onclick="generateScript()" style="padding:12px 40px;font-size:14px;">
                  âœ¨ ä¸€é”®ç”Ÿæˆè„šæœ¬ â†’
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 4: è„šæœ¬è¾“å‡º -->
      <div id="az-step4" style="display:none;">
        <div class="card">
          <div class="card-hd">
            <div class="card-title">ğŸ“ çˆ†æ¬¾è§†é¢‘è„šæœ¬</div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" onclick="backToStep3()">â† æ›´æ¢äº§å“</button>
              <button class="btn btn-ghost btn-sm" onclick="copyScript()">ğŸ“‹ å¤åˆ¶è„šæœ¬</button>
              <button class="btn btn-ghost btn-sm" onclick="exportReport()">â¬‡ ä¸‹è½½</button>
              <button class="btn btn-red btn-sm" onclick="saveReport()">ğŸ’¾ ä¿å­˜</button>
            </div>
          </div>
          <div id="scriptOutput" class="card-body" style="font-size:13px;line-height:2;"></div>
        </div>
      </div>

    </div>

    <!-- å³ä¾§ AI ä¾§è¾¹æ  -->
    <div class="ai-sidebar">
      <div class="ai-hd">
        <div>
          <div class="ai-title">ğŸ¤– DeepSeek AI åŠ©æ‰‹</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">çˆ†æ¬¾æ‹†è§£ Â· éšæ—¶æé—®</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="clearChat()">æ¸…ç©º</button>
      </div>
      <div class="ai-chat" id="aiChat">
        <div class="empty">
          <div class="empty-icon">ğŸ’¥</div>
          <div class="empty-text">ç²˜è´´é“¾æ¥å<br>AIè‡ªåŠ¨å¼€å§‹æ‹†è§£</div>
        </div>
      </div>
      <div class="quick-tags">
        <span class="qtag" onclick="quickAsk('è¿™ä¸ªçˆ†æ¬¾çš„æƒ…ç»ªé’©å­æ˜¯ä»€ä¹ˆï¼Ÿ')">æƒ…ç»ªé’©å­</span>
        <span class="qtag" onclick="quickAsk('å¸®æˆ‘ä¼˜åŒ–å¼€å¤´3ç§’çš„é»„é‡‘é’©å­')">ä¼˜åŒ–å¼€å¤´</span>
        <span class="qtag" onclick="quickAsk('è¿™ä¸ªç»“æ„é€‚åˆå“ªäº›äº§å“ç±»ç›®ï¼Ÿ')">é€‚åˆå“ç±»</span>
        <span class="qtag" onclick="quickAsk('å¸®æˆ‘å†™3ä¸ªä¸åŒé£æ ¼çš„çˆ†æ¬¾æ ‡é¢˜')">çˆ†æ¬¾æ ‡é¢˜</span>
        <span class="qtag" onclick="quickAsk('è¿™ä¸ªè§†é¢‘çš„è¯„è®ºåŒºäº’åŠ¨ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ')">äº’åŠ¨ç­–ç•¥</span>
        <span class="qtag" onclick="quickAsk('åŸºäºç°æœ‰ç»“æ„ï¼Œç»™æˆ‘10ä¸ªé€‰é¢˜æ–¹å‘')">é€‰é¢˜æ–¹å‘</span>
      </div>
      <div class="chat-bottom">
        <textarea class="chat-input" id="chatInput" placeholder="é—®AIä»»ä½•é—®é¢˜..." onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" onclick="sendMsg()">â¤</button>
      </div>
    </div>
  </div>

</div>
</div>

<!-- DeepSeek Key é…ç½®å¼¹çª— -->
<div id="dsKeyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
  <div style="background:#fff;border-radius:18px;padding:28px;width:92%;max-width:480px;box-shadow:0 24px 60px rgba(0,0,0,0.25);">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-size:16px;font-weight:800;color:#111827;">âš¡ é…ç½® DeepSeek API</div>
        <div style="font-size:11px;color:#9ca3af;margin-top:3px;">æ¥å…¥ DeepSeek å¼€æ”¾å¹³å°ç®—åŠ›ï¼Œé©±åŠ¨çˆ†æ¬¾æ‹†è§£åŠŸèƒ½</div>
      </div>
      <button onclick="document.getElementById('dsKeyModal').style.display='none'" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:22px;">âœ•</button>
    </div>
    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px;color:#0369a1;line-height:1.8;">
      <strong>è·å–æ­¥éª¤ï¼š</strong><br>
      1. æ‰“å¼€ <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color:#0ea5e9;font-weight:600;">platform.deepseek.com</a> â†’ API Keys<br>
      2. ç‚¹å‡»ã€Œåˆ›å»º API Keyã€â†’ å¤åˆ¶ï¼ˆ<code style="background:#e0f2fe;padding:1px 4px;border-radius:3px;">sk-...</code> å¼€å¤´ï¼‰<br>
      3. ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†
    </div>
    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:6px;">DeepSeek API Key</div>
      <input id="deepseekKeyInput" type="password" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        style="width:100%;background:#f9fafb;border:1.5px solid #e5e7eb;border-radius:8px;padding:11px 14px;font-family:monospace;font-size:12px;color:#111827;outline:none;box-sizing:border-box;"
        onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#e5e7eb'"
      />
    </div>
    <div id="dsKeyError" style="display:none;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;"></div>
    <div id="dsKeySuccess" style="display:none;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;"></div>
    <div style="display:flex;gap:8px;">
      <button onclick="saveDeepseekKey()" style="flex:1;padding:12px;background:#7c3aed;border:none;border-radius:9px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;">
        âœ… ä¿å­˜å¹¶å¯ç”¨
      </button>
      <button onclick="clearDeepseekKey()" style="padding:12px 16px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9px;color:#6b7280;font-size:12px;cursor:pointer;">
        æ¸…é™¤
      </button>
    </div>
    <div style="font-size:10px;color:#9ca3af;margin-top:10px;text-align:center;">Key ä»…å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ ä»»ä½•æœåŠ¡å™¨</div>
  </div>
</div>

<!-- ========== VIEW: REPORT ========== -->
<div id="view-report">
<div class="page">
  <div class="section-hd">
    <div>
      <div class="section-title">ğŸ“‹ å†å²åˆ†ææŠ¥å‘Š</div>
      <div class="section-sub">å·²ä¿å­˜çš„åˆ†æè®°å½•ï¼Œéšæ—¶å›é¡¾</div>
    </div>
    <button class="btn btn-ghost" onclick="switchView('analyze',document.querySelectorAll('.nav-tab')[2])">+ æ–°å»ºåˆ†æ</button>
  </div>
  <div class="report-layout">
    <div class="report-sidebar" id="reportSidebar">
      <div class="empty" style="padding:32px 0;"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">æš‚æ— ä¿å­˜çš„æŠ¥å‘Š<br>å®Œæˆåˆ†æåç‚¹å‡»ã€Œä¿å­˜ã€</div></div>
    </div>
    <div class="report-main" id="reportMain">
      <div class="empty" style="padding:80px 0;"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">é€‰æ‹©å·¦ä¾§æŠ¥å‘ŠæŸ¥çœ‹è¯¦æƒ…</div></div>
    </div>
  </div>
</div>
</div>

<!-- ========== VIEW: ACCOUNT è´¦å·ç›‘æµ‹ ========== -->
<div id="view-account">
<div class="page">

  <div class="section-hd" style="margin-bottom:20px;">
    <div>
      <div class="section-title">ğŸ‘¤ è´¦å·ç›‘æµ‹ä¸­å¿ƒ</div>
      <div class="section-sub">æ·»åŠ æŠ–éŸ³è´¦å·ï¼Œè®¾å®šçˆ†æ¬¾é˜ˆå€¼ï¼Œå®æ—¶æ£€æµ‹çˆ†æ¬¾å†…å®¹å¹¶å¼¹çª—æé†’</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="accMonBadge" style="font-size:10px;padding:4px 12px;border-radius:20px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981;font-family:'IBM Plex Mono',monospace;">
        â— 0 è´¦å·ç›‘æµ‹ä¸­
      </div>
      <button class="btn btn-red" onclick="openAddAccountModal()">+ æ·»åŠ è´¦å·</button>
    </div>
  </div>

  <!-- å…¨å±€çˆ†æ¬¾é˜ˆå€¼è®¾ç½® -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-hd">
      <div class="card-title">âš™ï¸ å…¨å±€ç›‘æµ‹è®¾ç½®</div>
    </div>
    <div class="card-body" style="display:flex;gap:24px;align-items:center;flex-wrap:wrap;">
      <div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">é»˜è®¤çˆ†æ¬¾æŒ‡æ•°é˜ˆå€¼</div>
        <div style="display:flex;align-items:center;gap:10px;">
          <input type="range" id="globalThreshold" min="50" max="99" value="80"
            style="width:160px;accent-color:var(--accent);" oninput="updateGlobalThresholdLabel(this.value)">
          <span id="globalThresholdLabel" style="font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--accent);font-weight:700;min-width:36px;">80</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px;">è¶…è¿‡æ­¤æ•°å€¼æ—¶è§¦å‘çˆ†æ¬¾å¼¹çª—æé†’</div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">æ£€æµ‹é—´éš”</div>
        <select id="accIntervalSelect" class="interval-select">
          <option value="60">æ¯1åˆ†é’Ÿ</option>
          <option value="300" selected>æ¯5åˆ†é’Ÿ</option>
          <option value="600">æ¯10åˆ†é’Ÿ</option>
          <option value="1800">æ¯30åˆ†é’Ÿ</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-red" onclick="startAccMonitor()">â–¶ å¯åŠ¨æ‰€æœ‰è´¦å·ç›‘æµ‹</button>
        <button class="btn btn-ghost" onclick="stopAccMonitor()">â¸ åœæ­¢</button>
      </div>
      <div style="margin-left:auto;">
        <div style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;" id="accCountdown">æœªå¯åŠ¨</div>
      </div>
    </div>
  </div>

  <!-- è´¦å·åˆ—è¡¨ -->
  <div class="section-label">å·²æ·»åŠ è´¦å·</div>
  <div id="accountList">
    <div class="empty" style="padding:60px 0;text-align:center;">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ‘¤</div>
      <div style="font-size:14px;color:var(--muted);">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è´¦å·<br>ç‚¹å‡»å³ä¸Šè§’ã€Œ+ æ·»åŠ è´¦å·ã€å¼€å§‹ç›‘æµ‹</div>
    </div>
  </div>

  <!-- çˆ†æ¬¾åŠ¨æ€è®°å½• -->
  <div class="section-label" style="margin-top:20px;">ğŸ“¢ çˆ†æ¬¾åŠ¨æ€è®°å½•</div>
  <div class="card">
    <div class="card-hd">
      <div class="card-title">æœ€è¿‘æ£€æµ‹åˆ°çš„çˆ†æ¬¾å†…å®¹</div>
      <button class="btn btn-ghost btn-sm" onclick="clearAccAlerts()">æ¸…ç©ºè®°å½•</button>
    </div>
    <div class="card-body" id="accAlertLog" style="max-height:340px;overflow-y:auto;padding:0;">
      <div class="empty" style="padding:32px;"><div class="empty-icon">ğŸ””</div><div class="empty-text">å¯åŠ¨ç›‘æµ‹åï¼Œçˆ†æ¬¾å†…å®¹å°†åœ¨æ­¤è®°å½•</div></div>
    </div>
  </div>

</div>
</div>

<script>
// ============ è´¦å·ç›‘æµ‹æ¨¡å— ============
let accountList = JSON.parse(localStorage.getItem('acc_list') || '[]');
let accMonitorInterval = null;
let accCountdownTimer = null;
let accMonitorRunning = false;
let accCountdown = 300;
let accAlerts = [];

function saveAccountList() {
  localStorage.setItem('acc_list', JSON.stringify(accountList));
}

function openAddAccountModal() {
  document.getElementById('addAccModal').style.display = 'flex';
  document.getElementById('accUrlInput').value = '';
  document.getElementById('accNickInput').value = '';
  document.getElementById('accThreshInput').value = parseInt(document.getElementById('globalThreshold').value) || 80;
  document.getElementById('addAccError').style.display = 'none';
}

function closeAddAccountModal() {
  document.getElementById('addAccModal').style.display = 'none';
}

function addAccount() {
  const url = document.getElementById('accUrlInput').value.trim();
  const nick = document.getElementById('accNickInput').value.trim();
  const thresh = parseInt(document.getElementById('accThreshInput').value) || 80;
  const errEl = document.getElementById('addAccError');

  if (!url && !nick) {
    errEl.style.display = 'block';
    errEl.textContent = 'è¯·è‡³å°‘å¡«å†™è´¦å·é“¾æ¥æˆ–æ˜µç§°ï¼';
    return;
  }

  // è§£æè´¦å·ID
  let accountId = '';
  let displayUrl = url;
  if (url.includes('douyin.com/user/')) {
    accountId = url.split('douyin.com/user/')[1].split('?')[0].split('/')[0];
  } else if (url.includes('@')) {
    accountId = url.split('@')[1].split('?')[0];
  } else if (url) {
    accountId = url;
  } else {
    accountId = 'custom_' + Date.now();
    displayUrl = '';
  }

  if (accountList.find(a => a.id === accountId)) {
    errEl.style.display = 'block';
    errEl.textContent = 'è¯¥è´¦å·å·²æ·»åŠ è¿‡äº†';
    return;
  }

  const account = {
    id: accountId,
    nick: nick || accountId,
    url: displayUrl,
    threshold: thresh,
    enabled: true,
    addedAt: new Date().toLocaleString('zh-CN'),
    lastCheck: null,
    latestVideos: [],
    viralCount: 0,
    avatar: ['ğŸ¬','ğŸ“±','ğŸŒŸ','ğŸ­','ğŸ’«','ğŸ”¥','âš¡','ğŸ¯'][Math.floor(Math.random()*8)],
  };

  accountList.push(account);
  saveAccountList();
  renderAccountList();
  closeAddAccountModal();
  showToast(`âœ… å·²æ·»åŠ ã€Œ${account.nick}ã€ï¼Œå¯åŠ¨ç›‘æµ‹åå¼€å§‹æ£€æµ‹`);
}

function removeAccount(id) {
  accountList = accountList.filter(a => a.id !== id);
  saveAccountList();
  renderAccountList();
  updateAccBadge();
  showToast('è´¦å·å·²ç§»é™¤');
}

function toggleAccount(id) {
  const acc = accountList.find(a => a.id === id);
  if (!acc) return;
  acc.enabled = !acc.enabled;
  saveAccountList();
  renderAccountList();
  updateAccBadge();
}

function updateAccountThreshold(id, val) {
  const acc = accountList.find(a => a.id === id);
  if (!acc) return;
  acc.threshold = parseInt(val);
  saveAccountList();
  document.getElementById('thresh-label-' + id).textContent = val;
}

function updateGlobalThresholdLabel(val) {
  document.getElementById('globalThresholdLabel').textContent = val;
}

function renderAccountList() {
  const container = document.getElementById('accountList');
  if (!container) return;
  if (accountList.length === 0) {
    container.innerHTML = `<div class="empty" style="padding:60px 0;text-align:center;">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ‘¤</div>
      <div style="font-size:14px;color:var(--muted);">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è´¦å·<br>ç‚¹å‡»å³ä¸Šè§’ã€Œ+ æ·»åŠ è´¦å·ã€å¼€å§‹ç›‘æµ‹</div>
    </div>`;
    return;
  }
  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-bottom:4px;">` +
    accountList.map(acc => `
    <div style="background:var(--surface);border:1px solid ${acc.enabled ? 'var(--border)' : '#1e2030'};border-radius:14px;overflow:hidden;opacity:${acc.enabled?1:0.55};transition:all 0.2s;${acc.enabled?'border-top:2px solid var(--accent);':''}">
      <div style="padding:16px 18px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);">
        <div style="width:42px;height:42px;border-radius:50%;background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.25);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${acc.avatar}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${acc.nick}</div>
          <div style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-top:2px;">${acc.url ? acc.url.slice(0,36)+'â€¦' : 'æ‰‹åŠ¨è¾“å…¥'}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button onclick="toggleAccount('${acc.id}')" style="padding:4px 10px;border-radius:5px;border:1px solid var(--border);background:${acc.enabled?'rgba(16,185,129,0.1)':'var(--surface2)'};color:${acc.enabled?'#10b981':'var(--muted)'};font-size:10px;cursor:pointer;">${acc.enabled?'â— ç›‘æµ‹ä¸­':'â—‹ å·²åœ'}</button>
          <button onclick="removeAccount('${acc.id}')" style="padding:4px 8px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-size:10px;cursor:pointer;">âœ•</button>
        </div>
      </div>
      <div style="padding:14px 18px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div style="font-size:11px;color:var(--muted);">çˆ†æ¬¾æŒ‡æ•°é˜ˆå€¼</div>
          <span id="thresh-label-${acc.id}" style="font-family:'IBM Plex Mono',monospace;font-size:15px;color:var(--accent);font-weight:700;">${acc.threshold}</span>
        </div>
        <input type="range" min="50" max="99" value="${acc.threshold}"
          style="width:100%;accent-color:var(--accent);margin-bottom:10px;"
          oninput="updateAccountThreshold('${acc.id}', this.value)">
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;">
          <span>ä¸Šæ¬¡æ£€æµ‹ï¼š${acc.lastCheck || 'æœªæ£€æµ‹'}</span>
          <span style="color:var(--accent);">å‘ç°çˆ†æ¬¾ï¼š${acc.viralCount} æ¬¡</span>
        </div>
        <div style="margin-top:6px;display:flex;justify-content:space-between;align-items:center;">
          ${acc._dataSource === 'real'   ? '<span style="font-size:9px;background:rgba(16,185,129,0.1);color:#10b981;border:1px solid rgba(16,185,129,0.25);border-radius:3px;padding:1px 7px;font-family:\'IBM Plex Mono\',monospace;">â— çœŸå®æ•°æ®</span>' :
            acc._dataSource === 'search' ? '<span style="font-size:9px;background:rgba(0,212,255,0.1);color:var(--accent2);border:1px solid rgba(0,212,255,0.25);border-radius:3px;padding:1px 7px;font-family:\'IBM Plex Mono\',monospace;">â— æœç´¢æ•°æ®</span>' :
            '<span style="font-size:9px;background:rgba(107,114,128,0.1);color:var(--muted);border:1px solid var(--border);border-radius:3px;padding:1px 7px;font-family:\'IBM Plex Mono\',monospace;">â—‹ æ¼”ç¤ºæ¨¡å¼</span>'}
          ${acc._hint ? `<span style="font-size:9px;color:var(--gold);cursor:pointer;" title="${acc._hint}">âš  æç¤º</span>` : ''}
        </div>
        ${acc.lastVideo ? `<div style="margin-top:8px;background:var(--surface2);border-radius:6px;padding:8px 10px;font-size:11px;color:var(--text);border-left:2px solid var(--accent);">æœ€æ–°ï¼š${acc.lastVideo}</div>` : ''}
      </div>
    </div>`).join('') + `</div>`;
}

function updateAccBadge() {
  const enabled = accountList.filter(a => a.enabled).length;
  const badge = document.getElementById('accMonBadge');
  if (badge) badge.textContent = `â— ${enabled} è´¦å·ç›‘æµ‹ä¸­`;
}

// è´¦å·ç›‘æµ‹æ ¸å¿ƒï¼šæ¨¡æ‹Ÿ/çœŸå®æ•°æ®æ£€æµ‹
// â”€â”€ è°ƒç”¨ /api/tikhub?endpoint=user_posts è·å–è´¦å·çœŸå®è§†é¢‘ â”€â”€â”€â”€â”€â”€
async function fetchUserPosts(acc, tikhubKey) {
  const params = new URLSearchParams({ endpoint: 'user_posts', count: '20' });

  // ä¼˜å…ˆç”¨ sec_uidï¼ˆä»ä¸»é¡µé“¾æ¥è§£æï¼‰
  if (acc.sec_uid) {
    params.set('sec_uid', acc.sec_uid);
  } else if (acc.url && acc.url.includes('MS4')) {
    // ä»é“¾æ¥é‡Œæå– sec_uidï¼ˆMS4wLjAB... æ ¼å¼ï¼‰
    const m = acc.url.match(/user\/(MS4[^/?#]+)/);
    if (m) { acc.sec_uid = m[1]; params.set('sec_uid', m[1]); }
  }
  // å¤‡ç”¨ï¼šunique_id / æ˜µç§°
  if (!params.has('sec_uid') && acc.id && !acc.id.startsWith('custom_')) {
    params.set('unique_id', acc.id);
  }

  const ctrl = new AbortController();
  setTimeout(() => ctrl.abort(), 18000);
  const r = await fetch('/api/tikhub?' + params.toString(), {
    signal: ctrl.signal,
    headers: { 'x-api-key': tikhubKey }
  });
  if (!r.ok) throw new Error('HTTP ' + r.status);
  const j = await r.json();
  if (!j?.success) throw new Error(j?.error || 'user_posts æ¥å£è¿”å›å¤±è´¥');
  return j; // { items: [...], total, _source, _debug, _hint }
}

async function checkAccountsOnce() {
  const enabled = accountList.filter(a => a.enabled);
  if (enabled.length === 0) return;

  const tikhubKey = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  const hasKey = !!(tikhubKey && tikhubKey.length > 10);

  for (const acc of enabled) {
    acc.lastCheck = new Date().toLocaleTimeString('zh-CN');
    let detectedVideos = [];
    acc._dataSource = 'demo'; // æ ‡è®°æ•°æ®æ¥æº

    // â”€â”€ è·¯çº¿Aï¼šTikHub user_posts æ¥å£ï¼ˆçœŸå®è´¦å·è§†é¢‘ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (hasKey) {
      try {
        const result = await fetchUserPosts(acc, tikhubKey);
        if (result.items && result.items.length > 0) {
          detectedVideos = result.items.map(item => ({
            aweme_id: item.aweme_id || '',
            title:    item.desc || item.fullDesc || '',
            heat:     item.heatScore || 75,
            likes:    item.diggStr || '0',
            comments: item.commentStr || '0',
            shares:   item.shareStr || '0',
            plays:    item.playStr || '0',
            track:    acc.nick,
            emoji:    acc.avatar,
            isNew:    true,
            trend:    '+',
            trendVal: Math.max(1, (item.heatScore || 75) - 70),
            source:   'real',
          }));
          acc._dataSource = 'real';
        } else if (result._hint) {
          // æ¥å£é€šäº†ä½†æ— è§†é¢‘ï¼Œè®°å½•æç¤º
          acc._hint = result._hint;
        }
      } catch(e) {
        console.warn('[accCheck] user_posts failed:', e.message);
        // user_posts å¤±è´¥ï¼Œé™çº§åˆ°å…³é”®è¯æœç´¢
        try {
          const items = await fetchViaTikHub(acc.nick);
          if (items && items.length > 0) {
            detectedVideos = items.map(item => normalizeAweme(item, acc.nick)).filter(Boolean);
            acc._dataSource = 'search';
          }
        } catch(e2) {
          console.warn('[accCheck] search fallback failed:', e2.message);
        }
      }
    }

    // â”€â”€ è·¯çº¿Bï¼šæ—  Key æˆ–å…¨éƒ¨å¤±è´¥ï¼Œç”Ÿæˆæ¼”ç¤ºæ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (detectedVideos.length === 0) {
      const demoTitles = [
        ['è¿™ä¸ªæ–¹æ³•è®©æˆ‘ç²‰ä¸æ¶¨äº†10ä¸‡','æ²¡æƒ³åˆ°è¿™ä¹ˆç®€å•','å½“å¹´çš„é‚£ä»¶äº‹ï¼Œä»Šå¤©ç¬¬ä¸€æ¬¡è¯´','æµ‹è¯„äº†100æ¬¾äº§å“ï¼Œè¿™ä¸ªçœŸç»äº†','å‡Œæ™¨3ç‚¹ï¼Œæƒ³é€šäº†ä¸€ä»¶äº‹'],
        ['ä¸æ•¢ç›¸ä¿¡è¿™æ˜¯çœŸçš„','å…¨ç½‘éƒ½åœ¨å­¦è¿™ä¸ª','èŠ±äº†3ä¸ªæœˆæ€»ç»“çš„å¹²è´§','è¿™æ¡è§†é¢‘æˆ‘åˆ äº†7æ¬¡ï¼Œä»Šå¤©å‘å‡ºæ¥'],
      ];
      detectedVideos = demoTitles[0].map((t, i) => ({
        aweme_id: '', title: `ã€Œ${acc.nick}ã€${t}`,
        heat: Math.floor(60 + Math.random() * 38),
        likes: (Math.random()*100+5).toFixed(1)+'ä¸‡',
        comments: (Math.random()*3+0.2).toFixed(1)+'ä¸‡',
        shares: (Math.random()*5+0.5).toFixed(1)+'ä¸‡',
        plays: (Math.random()*500+50).toFixed(0)+'ä¸‡',
        track: acc.nick, emoji: acc.avatar,
        isNew: i === 0, trend: '+', trendVal: Math.floor(Math.random()*15+3),
        source: 'demo',
      }));
      acc._dataSource = 'demo';
    }

    // â”€â”€ æ£€æµ‹çˆ†æ¬¾ï¼Œè§¦å‘å¼¹çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const viralVideos = detectedVideos.filter(v => v.heat >= acc.threshold);
    if (viralVideos.length > 0) {
      acc.viralCount += viralVideos.length;
      acc.lastVideo = viralVideos[0].title.slice(0, 40) + 'â€¦';
      viralVideos.forEach(v => triggerViralAlert(acc, v));
    }
  }

  saveAccountList();
  renderAccountList();
  updateAccBadge();
  renderAccAlertLog();
}

function triggerViralAlert(acc, video) {
  // è®°å½•åˆ°æ—¥å¿—
  accAlerts.unshift({
    account: acc.nick,
    avatar: acc.avatar,
    title: video.title,
    heat: video.heat,
    likes: video.likes,
    time: new Date().toLocaleString('zh-CN'),
  });
  if (accAlerts.length > 50) accAlerts.pop();

  // æ˜¾ç¤ºå¤§å¼¹çª—
  showViralPopup(acc, video);
}

function showViralPopup(acc, video) {
  const existing = document.getElementById('viralPopup');
  if (existing) existing.remove();

  const popup = document.createElement('div');
  popup.id = 'viralPopup';
  popup.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:99999;
    display:flex;align-items:center;justify-content:center;
    backdrop-filter:blur(12px);animation:fadeIn 0.3s ease;
  `;
  popup.innerHTML = `
    <div style="background:#13151f;border:1px solid rgba(255,51,85,0.5);border-radius:20px;
      padding:32px;width:92%;max-width:460px;box-shadow:0 0 60px rgba(255,51,85,0.3);
      animation:slideIn 0.4s ease;position:relative;">
      <!-- é¡¶éƒ¨å…‰æ™• -->
      <div style="position:absolute;top:0;left:50%;transform:translateX(-50%);width:200px;height:2px;
        background:linear-gradient(90deg,transparent,var(--accent),transparent);border-radius:2px;"></div>

      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:48px;margin-bottom:8px;animation:pulse 1s infinite;">${acc.avatar}</div>
        <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(255,51,85,0.1);
          border:1px solid rgba(255,51,85,0.3);border-radius:20px;padding:4px 14px;margin-bottom:12px;">
          <div style="width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1s infinite;"></div>
          <span style="font-size:11px;color:var(--accent);font-family:'IBM Plex Mono',monospace;font-weight:700;">çˆ†æ¬¾é¢„è­¦</span>
        </div>
        <div style="font-size:18px;font-weight:900;color:var(--text);margin-bottom:4px;">ã€Œ${acc.nick}ã€å‡ºçˆ†æ¬¾äº†ï¼</div>
        <div style="font-size:12px;color:var(--muted);">çˆ†æ¬¾æŒ‡æ•°å·²è¶…è¿‡ä½ è®¾å®šçš„ ${acc.threshold} é˜ˆå€¼</div>
      </div>

      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px;">
        <div style="font-size:13px;font-weight:600;color:var(--text);line-height:1.6;margin-bottom:12px;">${video.title}</div>
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="flex:1;">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px;">çˆ†æ¬¾æŒ‡æ•°</div>
            <div style="height:8px;background:var(--surface3);border-radius:8px;overflow:hidden;">
              <div style="height:100%;width:${video.heat}%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:8px;transition:width 1s;"></div>
            </div>
          </div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:24px;font-weight:900;color:var(--accent);">${video.heat}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:16px;font-size:11px;color:var(--muted);">
          <span>â¤ï¸ ${video.likes || '--'}</span>
          <span style="font-family:'IBM Plex Mono',monospace;">${new Date().toLocaleTimeString('zh-CN')}</span>
        </div>
      </div>

      <div style="display:flex;gap:10px;">
        <button onclick="goToVideoFromAlert('${encodeURIComponent(video.title)}','${video.aweme_id||''}')"
          style="flex:1;padding:12px;background:var(--accent);border:none;border-radius:10px;
          color:white;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
          ğŸ”¥ ç«‹å³æŸ¥çœ‹è§†é¢‘
        </button>
        <button onclick="document.getElementById('viralPopup').remove()"
          style="padding:12px 16px;background:var(--surface2);border:1px solid var(--border);
          border-radius:10px;color:var(--muted);font-size:12px;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
          çŸ¥é“äº†
        </button>
      </div>
      <div style="text-align:center;margin-top:12px;font-size:10px;color:var(--muted);">5ç§’åè‡ªåŠ¨å…³é—­</div>
    </div>
  `;
  document.body.appendChild(popup);

  // 5ç§’è‡ªåŠ¨å…³é—­
  setTimeout(() => { if (document.getElementById('viralPopup')) document.getElementById('viralPopup').remove(); }, 5000);
}

function goToVideoFromAlert(titleEnc, awemeId) {
  document.getElementById('viralPopup')?.remove();
  const title = decodeURIComponent(titleEnc);
  if (awemeId && !awemeId.startsWith('builtin_') && !awemeId.startsWith('hot_')) {
    window.open('https://www.douyin.com/video/' + awemeId, '_blank');
  } else {
    window.open('https://www.douyin.com/search/' + encodeURIComponent(title) + '?type=video&sort_type=1', '_blank');
  }
}

function renderAccAlertLog() {
  const container = document.getElementById('accAlertLog');
  if (!container) return;
  if (accAlerts.length === 0) {
    container.innerHTML = `<div class="empty" style="padding:32px;"><div class="empty-icon">ğŸ””</div><div class="empty-text">å¯åŠ¨ç›‘æµ‹åï¼Œçˆ†æ¬¾å†…å®¹å°†åœ¨æ­¤è®°å½•</div></div>`;
    return;
  }
  container.innerHTML = accAlerts.map(a => `
    <div style="display:flex;gap:12px;align-items:flex-start;padding:14px 20px;border-bottom:1px solid rgba(42,45,62,0.5);">
      <div style="font-size:22px;flex-shrink:0;">${a.avatar}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:11px;color:var(--accent);font-weight:700;margin-bottom:3px;">ğŸ”¥ ${a.account} Â· çˆ†æ¬¾é¢„è­¦</div>
        <div style="font-size:12px;color:var(--text);line-height:1.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.title}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;font-family:'IBM Plex Mono',monospace;">${a.time}</div>
      </div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:18px;font-weight:900;color:var(--accent);flex-shrink:0;">${a.heat}</div>
    </div>
  `).join('');
}

function clearAccAlerts() {
  accAlerts = [];
  renderAccAlertLog();
}

function startAccMonitor() {
  if (accountList.filter(a=>a.enabled).length === 0) {
    showToast('è¯·å…ˆæ·»åŠ å¹¶å¯ç”¨è‡³å°‘ä¸€ä¸ªè´¦å·');
    return;
  }
  if (accMonitorRunning) return;
  accMonitorRunning = true;
  const interval = parseInt(document.getElementById('accIntervalSelect').value);
  accCountdown = interval;
  updateAccBadge();

  // ç«‹å³æ£€æµ‹ä¸€æ¬¡
  checkAccountsOnce();

  // å€’è®¡æ—¶
  if (accCountdownTimer) clearInterval(accCountdownTimer);
  accCountdownTimer = setInterval(() => {
    accCountdown--;
    const m = Math.floor(accCountdown/60);
    const s = accCountdown % 60;
    const el = document.getElementById('accCountdown');
    if (el) el.textContent = `ä¸‹æ¬¡æ£€æµ‹ï¼š${m>0?m+'m':''}${s}s`;
    if (accCountdown <= 0) {
      checkAccountsOnce();
      accCountdown = interval;
    }
  }, 1000);

  showToast('âœ… è´¦å·ç›‘æµ‹å·²å¯åŠ¨ï¼');
}

function stopAccMonitor() {
  accMonitorRunning = false;
  if (accCountdownTimer) clearInterval(accCountdownTimer);
  const el = document.getElementById('accCountdown');
  if (el) el.textContent = 'å·²åœæ­¢';
  showToast('ç›‘æµ‹å·²åœæ­¢');
}

// ============ STATE ============
let selectedTracks = [];
let monitorInterval = null;
let monitorRunning = false;
let monitorCountdown = 60;
let countdownTimer = null;
let feedFilter = 'all';
let currentSource = 'feigua';
let chatHistory = [];
let analysisResult = '';
let pastedData = '';
let savedReports = [];
let feedData = [];
let alertCount = 0;
let trendData = [];

const TRACKS = [
  {name:'ç¾é£Ÿ',emoji:'ğŸœ',heat:94,color:'#ff3355'},
  {name:'æ—¶å°šç©¿æ­',emoji:'ğŸ‘—',heat:88,color:'#a855f7'},
  {name:'æç¬‘æ®µå­',emoji:'ğŸ˜‚',heat:96,color:'#f59e0b'},
  {name:'æƒ…æ„Ÿè¯­å½•',emoji:'ğŸ’¬',heat:85,color:'#ec4899'},
  {name:'å¥èº«è¿åŠ¨',emoji:'ğŸ’ª',heat:79,color:'#10b981'},
  {name:'çŸ¥è¯†ç§‘æ™®',emoji:'ğŸ”¬',heat:82,color:'#00d4ff'},
  {name:'æ—…æ¸¸æ‰“å¡',emoji:'âœˆï¸',heat:87,color:'#f97316'},
  {name:'æ¯å©´è‚²å„¿',emoji:'ğŸ‘¶',heat:76,color:'#fbbf24'},
  {name:'æ¸¸æˆç”µç«',emoji:'ğŸ®',heat:91,color:'#7c3aed'},
  {name:'è´¢ç»å•†ä¸š',emoji:'ğŸ“ˆ',heat:83,color:'#0ea5e9'},
  {name:'å® ç‰©èŒå® ',emoji:'ğŸ±',heat:90,color:'#fb923c'},
  {name:'ç¾å¦†æŠ¤è‚¤',emoji:'ğŸ’„',heat:86,color:'#f472b6'},
  {name:'å®¶å±…ç”Ÿæ´»',emoji:'ğŸ ',heat:73,color:'#84cc16'},
  {name:'èŒåœºå¹²è´§',emoji:'ğŸ’¼',heat:81,color:'#06b6d4'},
  {name:'æ±½è½¦',emoji:'ğŸš—',heat:75,color:'#64748b'},
  {name:'æ‘„å½±',emoji:'ğŸ“·',heat:71,color:'#8b5cf6'},
];

const VIDEO_TEMPLATES = {
  'ç¾é£Ÿ':['è¿™é“èœè®©å…¨å®¶äººéƒ½çˆ±ä¸Šæˆ‘ï¼10åˆ†é’Ÿæå®š','ç§˜åˆ¶çº¢çƒ§è‚‰ï¼Œå¤–å©†æ•™äº†æˆ‘20å¹´ç»ˆäºå­¦ä¼š','æ¢åº—ï½œè¿™å®¶è‹è‡é¦†å­æ’é˜Ÿ2å°æ—¶ï¼Œå€¼ï¼','å‡è„‚æœŸä¹Ÿèƒ½åƒçˆ½ï¼ä½å¡æ»¡è¶³æ„Ÿæ‹‰æ»¡ä¾¿å½“','å¤åˆ»ç½‘çº¢åº—åŒæ¬¾ï¼Œåœ¨å®¶åš9æˆåƒ'],
  'æ—¶å°šç©¿æ­':['150cmæ˜¾é«˜10cmç©¿æ­å…¬å¼ï¼Œæ”¶è—å¤‡ç”¨','300å—ç©¿å‡ºä¸Šä¸‡å—æ•ˆæœï¼ŒçœŸçš„å¯ä»¥','ä»Šå¹´ç§‹å†¬æœ€æµè¡Œé¢œè‰²ï¼Œä½ ç©¿å¯¹äº†å—','èŒåœºç©¿æ­é¿é›·æŒ‡å—ï¼ŒHRéƒ½è¯´è¿™æ ·æ‰£åˆ†','åŒæ¬¾è¡£æœå¥¹ä¸ºä»€ä¹ˆæ¯”ä½ å¥½çœ‹ï¼Ÿç§˜å¯†åœ¨è¿™'],
  'æç¬‘æ®µå­':['è¢«è€æ¿å½“ä¼—è¡¨æ‰¬åï¼Œæˆ‘åªæƒ³æ‰¾åœ°ç¼é’»','ç”²æ–¹ï¼šå†æ”¹ä¸€ä¸‹ï¼Ÿæˆ‘ï¼šï¼ˆå†…å¿ƒosï¼‰','å’Œçˆ¶æ¯è§†é¢‘çš„å…¨è¿‡ç¨‹ï¼Œä¸€ç§’ä¸å·®','æœ‹å‹åœˆå±è”½çˆ¶æ¯çš„åæœï¼Œæ²¡æƒ³åˆ°è¿™ä¹ˆä¸¥é‡'],
  'æ¸¸æˆç”µç«':['è¿™ä¸ªæ“ä½œè¿èŒä¸šé€‰æ‰‹éƒ½è¯´ç»äº†ï¼','ç‹è€…ä¸Šåˆ†å¿…å­¦çš„é‡åŒºæ§åˆ¶æ—¶æœº','ç»åœ°æ±‚ç”Ÿï¼šèœé¸Ÿåˆ°é£å‡çš„å®Œæ•´è·¯çº¿','è¿™æ¬¾æ–°æ¸¸æˆè®©æˆ‘ç†¬å¤œåˆ°4ç‚¹ï¼Œå¤ªä¸Šå¤´'],
  'çŸ¥è¯†ç§‘æ™®':['ä½ ä»¥ä¸ºä½ æ‡‚å‘¼å¸ï¼Ÿ95%çš„äººå…¶å®ä¸ä¼š','å®‡å®™è†¨èƒ€æ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ3åˆ†é’Ÿçœ‹æ‡‚','ä¸ºä»€ä¹ˆçŒ«æ€»ç›¯ç€ç©ºæ°”å‘å‘†ï¼ŸçœŸç›¸æƒŠäºº','è¿™ä¸ªæ•°å­¦é¢˜éš¾å€’äº†80%çš„å¤§å­¦ç”Ÿ'],
  default:['è¿™ä¸ªå†…å®¹è®©æ‰€æœ‰äººéƒ½åœä¸‹æ¥çœ‹å®Œäº†','æ²¡æƒ³åˆ°è¿™ä¸ªæ–¹æ³•è¿™ä¹ˆæœ‰æ•ˆï¼Œè¯•äº†éƒ½è¯´å¥½','åšäº†3å¹´æ€»ç»“å‡ºæ¥çš„å¹²è´§ï¼Œå…è´¹åˆ†äº«','çœ‹äº†è¿™ä¸ªä¹‹åï¼Œæˆ‘æ”¹å˜äº†å¾ˆå¤šè§‚å¿µ','ä¸ºä»€ä¹ˆè¿™ä¸ªèµ›é“è§†é¢‘è¶Šæ¥è¶Šå¤šäº†'],
};

const EMOJIS = ['ğŸœ','ğŸ¬','ğŸ’¡','ğŸ”¥','â­','ğŸ¯','âœ¨','ğŸª','ğŸŒŸ','ğŸ’«','ğŸ†','ğŸŠ','ğŸ’','ğŸš€','ğŸŒˆ'];

const SOURCE_GUIDES = {
  feigua:{name:'é£ç“œæ•°æ®',steps:['æ‰“å¼€ feigua.cnï¼Œæ³¨å†Œå…è´¹è´¦å·','ç‚¹å‡»é¡¶éƒ¨ã€Œè§†é¢‘ã€â†’ã€Œçƒ­é—¨è§†é¢‘æ¦œã€','åœ¨å³ä¾§é€‰æ‹©åˆ†ç±»ï¼Œæ‰¾åˆ°ä½ çš„èµ›é“','å…¨é€‰é¡µé¢ä¸Šçš„è§†é¢‘æ ‡é¢˜å’Œæ•°æ®ï¼Œå¤åˆ¶','å›åˆ°è¿™é‡Œç²˜è´´å³å¯ âœ…']},
  chanmama:{name:'è‰å¦ˆå¦ˆ',steps:['æ‰“å¼€ chanmama.comï¼Œæ³¨å†Œè´¦å·','è¿›å…¥ã€Œå†…å®¹åˆ†æã€â†’ã€Œè§†é¢‘æ’è¡Œæ¦œã€','é€‰æ‹©ã€ŒæŠ–éŸ³ã€å¹³å° + ä½ çš„èµ›é“åˆ†ç±»','æ¡†é€‰çƒ­é—¨è§†é¢‘åŒºåŸŸï¼Œå¤åˆ¶æ–‡å­—','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  huitun:{name:'ç°è±šæ•°æ®',steps:['æ‰“å¼€ huitun.comï¼Œæ³¨å†Œè´¦å·','å·¦ä¾§èœå•æ‰¾ã€Œè§†é¢‘çƒ­æ¦œã€','æŒ‰åˆ†ç±»ç­›é€‰åˆ°ä½ çš„èµ›é“','å¤åˆ¶çƒ­é—¨è§†é¢‘åˆ—è¡¨','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  official:{name:'å·¨é‡ç®—æ•°ï¼ˆå…è´¹ï¼‰',steps:['æ‰“å¼€ trendinsight.bytedance.comï¼ˆå®Œå…¨å…è´¹ï¼‰','ç‚¹å‡»ã€Œçƒ­ç‚¹å®ã€æˆ–ã€Œå†…å®¹çƒ­æ¦œã€','é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„èµ›é“è¯é¢˜','å¤åˆ¶çƒ­é—¨å†…å®¹çš„æ ‡é¢˜å’Œæ•°æ®','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  manual:{name:'æ‰‹åŠ¨æ•´ç†',steps:['æ‰“å¼€æŠ–éŸ³Appï¼Œæœç´¢ä½ çš„èµ›é“å…³é”®è¯','æŒ‰ã€Œæœ€å¤šç‚¹èµã€æ’åºæŸ¥çœ‹çƒ­é—¨è§†é¢‘','è®°ä¸‹ä½ è§‰å¾—çˆ†çš„è§†é¢‘æ ‡é¢˜ã€å¤§æ¦‚ç‚¹èµæ•°','åœ¨ä¸‹ä¸€æ­¥æ‰‹åŠ¨è¾“å…¥è¿™äº›ä¿¡æ¯','å“ªæ€•åªæœ‰æ ‡é¢˜ï¼ŒAIä¹Ÿèƒ½åˆ†æ âœ…']},
  other:{name:'å…¶ä»–æ¥æº',steps:['ä»»ä½•ä½ çœ‹åˆ°çš„æŠ–éŸ³çƒ­é—¨å†…å®¹éƒ½å¯ä»¥','æ¯”å¦‚ç¾¤é‡Œåˆ†äº«çš„çˆ†æ¬¾ã€å¾®åšçƒ­æœæåˆ°çš„','æˆ–è€…æˆªå›¾åæŠŠæ–‡å­—æ‰‹åŠ¨æ‰“å‡ºæ¥','æ ¼å¼ä¸é™ï¼Œéšæ„ç²˜è´´','AIä¼šè‡ªåŠ¨ç†è§£å†…å®¹ âœ…']},
};

// ============ NAVIGATION ============
function switchView(name, el) {
  ['monitor','track','analyze','report','account'].forEach(v => {
    const el2 = document.getElementById('view-'+v);
    if (el2) el2.classList.remove('active');
  });
  const target = document.getElementById('view-'+name);
  if (target) target.classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if(el) el.classList.add('active');

  // åˆ‡æ¢åˆ°è´¦å·ç›‘æµ‹æ—¶åˆå§‹åŒ–æ¸²æŸ“
  if (name === 'account') {
    renderAccountList();
    updateAccBadge();
    renderAccAlertLog();
  }
}

// ============ TRACK SELECTION ============
function renderTrackGrid() {
  const grid = document.getElementById('trackGrid');
  grid.innerHTML = TRACKS.map(t => `
    <div class="track-card" data-name="${t.name}" onclick="toggleTrack('${t.name}',this)">
      <div class="track-check">âœ“</div>
      <div class="track-emoji">${t.emoji}</div>
      <div class="track-name">${t.name}</div>
      <div class="track-heat">çƒ­åº¦ ${t.heat}</div>
      <div class="track-heat-bar">
        <div class="track-heat-fill" style="width:${t.heat}%;background:${t.color};"></div>
      </div>
    </div>
  `).join('');
}

function toggleTrack(name, el) {
  if(selectedTracks.includes(name)) {
    selectedTracks = selectedTracks.filter(t => t !== name);
    el.classList.remove('selected');
  } else {
    if(selectedTracks.length >= 5) { showToast('æœ€å¤šé€‰æ‹©5ä¸ªèµ›é“'); return; }
    selectedTracks.push(name);
    el.classList.add('selected');
  }
  updateSelectedBar();
  updateCompare();
}

function updateSelectedBar() {
  const bar = document.getElementById('selectedBar');
  const chips = document.getElementById('selectedChips');
  if(selectedTracks.length === 0) { bar.style.display='none'; return; }
  bar.style.display='flex';
  chips.innerHTML = selectedTracks.map(t => {
    const info = TRACKS.find(x=>x.name===t)||{emoji:'ğŸ¯'};
    return `<div class="selected-chip">${info.emoji} ${t} <span class="rm" onclick="removeTrack('${t}')">Ã—</span></div>`;
  }).join('');
}

function removeTrack(name) {
  selectedTracks = selectedTracks.filter(t => t !== name);
  document.querySelectorAll('.track-card').forEach(c => {
    if(c.dataset.name === name) c.classList.remove('selected');
  });
  updateSelectedBar();
  updateCompare();
}

function clearAllTracks() {
  selectedTracks = [];
  document.querySelectorAll('.track-card').forEach(c => c.classList.remove('selected'));
  updateSelectedBar();
  updateCompare();
}

function addCustomTrack() {
  const input = document.getElementById('customTrackInput');
  const val = input.value.trim();
  if(!val) return;
  if(TRACKS.find(t=>t.name===val)) { showToast('è¯¥èµ›é“å·²å­˜åœ¨'); return; }
  const heat = Math.floor(65+Math.random()*20);
  const colors = ['#ff3355','#00d4ff','#7c3aed','#f59e0b','#10b981'];
  const color = colors[TRACKS.length % colors.length];
  TRACKS.push({name:val,emoji:'ğŸ¯',heat,color});
  renderTrackGrid();
  // Re-select previously selected
  selectedTracks.forEach(t => {
    document.querySelectorAll('.track-card').forEach(c => {
      if(c.dataset.name === t) c.classList.add('selected');
    });
  });
  input.value='';
}

function confirmTracks() {
  if(selectedTracks.length === 0) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèµ›é“'); return; }
  switchView('monitor', document.querySelectorAll('.nav-tab')[0]);
  updateMonitorUI();
  if(!monitorRunning) startMonitor();
}

function updateCompare() {
  const panel = document.getElementById('comparePanel');
  const bars = document.getElementById('compareBars');
  if(selectedTracks.length < 2) { panel.style.display='none'; return; }
  panel.style.display='block';
  const sorted = [...selectedTracks].map(n => TRACKS.find(t=>t.name===n)||{name:n,heat:70,color:'#888'}).sort((a,b)=>b.heat-a.heat);
  bars.innerHTML = sorted.map(t => `
    <div class="compare-row">
      <div class="compare-name">${t.emoji||'ğŸ¯'} ${t.name}</div>
      <div class="compare-bar">
        <div class="compare-fill" style="width:${t.heat}%;background:${t.color};">${t.heat}</div>
      </div>
      <div class="compare-score">${t.heat}</div>
    </div>
  `).join('');
}

// ============ MONITOR ============
function updateMonitorUI() {
  const trackCount = selectedTracks.length;
  document.getElementById('mTrackCount').textContent = trackCount > 0 ? trackCount+'ä¸ª' : 'â€”';
  document.getElementById('liveTrackLabel').textContent = selectedTracks.join(' Â· ') || 'æœªé€‰æ‹©';
  if(trackCount > 0) renderTrackHeatRank();
}

function renderTrackHeatRank() {
  const el = document.getElementById('trackHeatRank');
  const tracks = selectedTracks.map(n => TRACKS.find(t=>t.name===n)||{name:n,heat:70+Math.random()*20,emoji:'ğŸ¯',color:'#888'});
  tracks.sort((a,b) => b.heat - a.heat);
  el.innerHTML = tracks.map((t,i) => `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);min-width:16px;">${i+1}</span>
      <span style="font-size:14px;">${t.emoji||'ğŸ¯'}</span>
      <span style="flex:1;font-size:12px;font-weight:500;">${t.name}</span>
      <div style="width:80px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;">
        <div style="height:100%;width:${t.heat}%;background:${t.color};border-radius:3px;"></div>
      </div>
      <span style="font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace;min-width:24px;">${Math.round(t.heat)}</span>
    </div>
  `).join('');
}

function toggleMonitor() {
  if(monitorRunning) stopMonitor(); else startMonitor();
}

function startMonitor() {
  if(selectedTracks.length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©èµ›é“ï¼');
    switchView('track', document.querySelectorAll('.nav-tab')[1]);
    return;
  }
  monitorRunning = true;
  document.getElementById('monToggleBtn').textContent = 'â¸ åœæ­¢ç›‘æµ‹';
  document.getElementById('monToggleBtn').className = 'btn btn-ghost btn-sm';
  document.getElementById('monStatusDot').className = 'pulse-dot';
  document.getElementById('monStatusText').textContent = 'ç›‘æµ‹ä¸­';
  refreshFeed(true);
  scheduleNextRefresh();
}

function stopMonitor() {
  monitorRunning = false;
  if(monitorInterval) clearInterval(monitorInterval);
  if(countdownTimer) clearInterval(countdownTimer);
  document.getElementById('monToggleBtn').textContent = 'â–¶ å¼€å§‹ç›‘æµ‹';
  document.getElementById('monToggleBtn').className = 'btn btn-red btn-sm';
  document.getElementById('monStatusDot').className = 'pulse-dot red';
  document.getElementById('monStatusText').textContent = 'å·²æš‚åœ';
  document.getElementById('mCountdown').textContent = 'å·²æš‚åœ';
}

function scheduleNextRefresh() {
  const interval = parseInt(document.getElementById('intervalSelect').value);
  monitorCountdown = interval;
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(() => {
    monitorCountdown--;
    const m = Math.floor(monitorCountdown/60);
    const s = monitorCountdown%60;
    document.getElementById('mCountdown').textContent = m>0 ? `${m}m${s}s` : `${s}s`;
    if(monitorCountdown <= 0) {
      refreshFeed(false);
      monitorCountdown = interval;
    }
  }, 1000);
}

function updateInterval() {
  if(monitorRunning) {
    if(countdownTimer) clearInterval(countdownTimer);
    scheduleNextRefresh();
  }
}

function manualRefresh() {
  refreshFeed(false);
  if(monitorRunning) {
    if(countdownTimer) clearInterval(countdownTimer);
    scheduleNextRefresh();
  }
}

function getVideoTemplates(track) {
  return VIDEO_TEMPLATES[track] || VIDEO_TEMPLATES.default;
}

function generateFeedData() {
  const allVideos = [];
  selectedTracks.forEach(track => {
    const tmpl = getVideoTemplates(track);
    const trackInfo = TRACKS.find(t=>t.name===track)||{emoji:'ğŸ¯',heat:80};
    tmpl.forEach((title, i) => {
      const likes = (Math.random()*200+10).toFixed(1)+'ä¸‡';
      const comments = (Math.random()*5+0.5).toFixed(1)+'ä¸‡';
      const shares = (Math.random()*10+1).toFixed(1)+'ä¸‡';
      const heat = Math.floor(trackInfo.heat - i*4 + (Math.random()*6-3));
      const isNew = Math.random() > 0.7;
      const trend = Math.random() > 0.3 ? '+' : '-';
      const trendVal = Math.floor(Math.random()*15+1);
      allVideos.push({title, likes, comments, shares, heat:Math.min(99,Math.max(50,heat)), isNew, trend, trendVal, track, emoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]});
    });
  });
  allVideos.sort((a,b) => b.heat - a.heat);
  return allVideos;
}

async function refreshFeed(isFirst) {
  const tikhubKey = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  const hasCfg = !!(tikhubKey && tikhubKey.length > 10);
  const list = document.getElementById('feedList');

  if (hasCfg) {
    const trackList = selectedTracks.length > 0 ? selectedTracks : null;

    if (list) list.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div style="font-size:30px;animation:spin 0.8s linear infinite;display:inline-block;margin-bottom:12px;">âŸ³</div>
        <div style="font-size:13px;color:#6b7280;font-weight:600;">æ­£åœ¨æœç´¢ã€Œ${trackList ? trackList.join(' Â· ') : 'çƒ­æœ'}ã€èµ›é“è§†é¢‘â€¦</div>
      </div>`;

    try {
      let allResults = [];

      if (trackList && trackList.length > 0) {
        // âœ… æŒ‰æ¯ä¸ªèµ›é“å…³é”®è¯æœç´¢çœŸå®è§†é¢‘
        for (const track of trackList) {
          // å–è¯¥èµ›é“ç¬¬ä¸€ä¸ªå…³é”®è¯ä½œä¸ºæœç´¢è¯ï¼ˆæœ€ç²¾å‡†ï¼‰
          const kws = TRACK_KEYWORDS[track] || [track];
          const searchKw = kws[0];

          const items = await fetchViaTikHub(searchKw);
          if (items && items.length > 0) {
            items.forEach(item => {
              allResults.push({ ...item, _track: track });
            });
          }
        }
      }

      // å¦‚æœèµ›é“æœç´¢æœ‰ç»“æœï¼Œç›´æ¥ç”¨
      if (allResults.length > 0) {
        feedData = allResults.map(item => normalizeAweme(item, item._track)).filter(Boolean);
        feedData.sort((a, b) => b.heat - a.heat);
        feedData.slice(0, 3).forEach(v => { v.isNew = true; });
        _dsConnected = true;
        renderFeed(isFirst);
        updateMetrics();
        if (!isFirst) generateAlert();
        drawTrendChart();
        _refreshDsBadges();
        return;
      }

      // æœç´¢æ— ç»“æœæ—¶ fallback åˆ°çƒ­æœæ¦œï¼Œå¹¶ç”¨å…³é”®è¯è¿‡æ»¤
      const hotItems = await fetchHotSearch();
      if (hotItems?.length > 0) {
        const results = [];
        hotItems.forEach((item, idx) => {
          const word = item.word || item.desc || '';
          if (!word) return;

          // åŒ¹é…èµ›é“æ ‡ç­¾
          let matchedTrack = trackList ? null : 'çƒ­æœ';
          if (trackList) {
            for (const track of trackList) {
              const kws = TRACK_KEYWORDS[track] || [track];
              if (kws.some(k => word.includes(k))) {
                matchedTrack = track;
                break;
              }
            }
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å…·ä½“èµ›é“ï¼Œä»ç„¶æ˜¾ç¤ºä½†æ‰“ä¸Šç¬¬ä¸€ä¸ªèµ›é“æ ‡ç­¾
            if (!matchedTrack) matchedTrack = trackList[0];
          }

          results.push({
            _isHotSearch: true,
            desc: word,
            _hotValue: item.hotValue || item._hotValue || (50 - idx) * 100000,
            _track: matchedTrack,
          });
        });

        feedData = results.map(item => normalizeAweme(item, item._track)).filter(Boolean);
        feedData.sort((a, b) => b.heat - a.heat);
        feedData.slice(0, 3).forEach(v => { v.isNew = true; });
        _dsConnected = true;
        renderFeed(isFirst);
        updateMetrics();
        if (!isFirst) generateAlert();
        drawTrendChart();
        _refreshDsBadges();
        return;
      }
    } catch(e) {
      console.warn('[refreshFeed] fetch failed:', e.message);
    }
    _dsConnected = false;
    showToast('âš ï¸ æ•°æ®è·å–å¤±è´¥ï¼Œåˆ‡æ¢æ¼”ç¤ºæ¨¡å¼');
    _refreshDsBadges();
  }

  feedData = generateFeedData();
  renderFeed(isFirst);
  updateMetrics();
  if(!isFirst) generateAlert();
  drawTrendChart();
}

// ç›´æ¥è·å–çƒ­æœæ¦œ
async function fetchHotSearch() {
  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  if (!key) return null;
  const controller = new AbortController();
  setTimeout(() => controller.abort(), 15000);
  const r = await fetch('/api/tikhub?endpoint=hot_search', {
    signal: controller.signal,
    headers: { 'x-api-key': key }
  });
  if (!r.ok) return null;
  const j = await r.json();
  if (!j?.success || !j.items?.length) return null;
  return j.items.map(item => ({ word: item.word || '', hotValue: item.hotValue || 0 }));
}

function renderFeed(isFirst) {
  const list = document.getElementById('feedList');
  let data = [...feedData];
  if(feedFilter === 'new') data = data.filter(v => v.isNew);
  if(feedFilter === 'rising') data = data.filter(v => v.trend === '+' && v.trendVal > 8);
  if(feedFilter === 'hot') data = data.filter(v => v.heat > 85);
  if(feedFilter === 'ai') data = data.filter(v => v.heat > 80).slice(0,5);

  if(data.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">è¯¥ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— æ•°æ®</div></div>`;
    return;
  }

  list.innerHTML = data.map((v, i) => {
    const rankClass = i===0?'r1':i===1?'r2':i===2?'r3':'rn';
    const isAnimNew = !isFirst && v.isNew;
    return `
    <div class="feed-item ${isAnimNew?'new-item':''}" style="animation-delay:${i*0.04}s" onclick="feedItemClick(${i})">
      <div class="feed-rank ${rankClass}">${i+1}</div>
      <div class="feed-thumb"><div class="feed-thumb-overlay"></div><span style="position:relative;font-size:20px">${v.emoji}</span></div>
      <div class="feed-info">
        <div class="feed-title">${v.title}</div>
        <div class="feed-stats">
          <span>â¤ï¸ ${v.likes}</span>
          <span>ğŸ’¬ ${v.comments}</span>
          <span>â†—ï¸ ${v.shares}</span>
          <span style="color:var(--accent2)">ğŸ“‚ ${v.track}</span>
        </div>
        <div class="feed-heat">
          <div class="heat-bar"><div class="heat-fill" style="width:${v.heat}%"></div></div>
          <span class="heat-num">${v.heat}</span>
        </div>
      </div>
      <div class="feed-right">
        <span class="${v.trend==='+'?'trend-up':'trend-dn'}">${v.trend}${v.trendVal}%</span>
        ${v.isNew?'<span class="new-tag">NEW</span>':''}
      </div>
    </div>`;
  }).join('');
}

function feedItemClick(idx) {
  const v = feedData[idx];
  if(!v) return;
  // çœŸå®æ•°æ®ï¼šç²¾å‡†è·³è½¬åˆ°å•æ¡è§†é¢‘é¡µé¢
  if(v.source === 'real' && v.aweme_id) {
    window.open('https://www.douyin.com/video/' + v.aweme_id, '_blank');
    return;
  }
  // æ¼”ç¤ºæ•°æ®ï¼šè·³è½¬æŠ–éŸ³æœç´¢
  const q = encodeURIComponent((v.title||'').replace(/[ï¼ˆï¼‰ã€ã€‘ï½œâ€¦]/g,' ').trim());
  window.open('https://www.douyin.com/search/' + q + '?type=video', '_blank');
}

function setFeedFilter(btn, filter) {
  document.querySelectorAll('[id^="ff-"]').forEach(b => { b.className='btn btn-ghost btn-sm'; });
  btn.className='btn btn-red btn-sm';
  feedFilter = filter;
  renderFeed(false);
}

function updateMetrics() {
  const total = feedData.length * 17 + Math.floor(Math.random()*50);
  const avgHeat = feedData.length > 0 ? Math.round(feedData.reduce((s,v)=>s+v.heat,0)/feedData.length) : 0;
  document.getElementById('mTotal').textContent = total;
  document.getElementById('mAvgHeat').textContent = avgHeat;
  document.getElementById('mTotalChange').textContent = `â†‘ è¾ƒä¸Šæ¬¡ +${Math.floor(Math.random()*12+3)}`;
  document.getElementById('mHeatChange').textContent = avgHeat > 80 ? 'â†‘ çƒ­åº¦ä¸Šå‡ä¸­' : 'â†’ çƒ­åº¦å¹³ç¨³';
}

function generateAlert() {
  const types = [
    {type:'SPIKE',cls:'',text:`ã€Œ${selectedTracks[0]||'ç¾é£Ÿ'}ã€èµ›é“å‡ºç°æ€¥é€Ÿä¸Šå‡è§†é¢‘ï¼Œçƒ­åº¦æŒ‡æ•°åœ¨30åˆ†é’Ÿå†…æå‡ +${Math.floor(Math.random()*20+10)}%`},
    {type:'NEW TREND',cls:'blue',text:`æ£€æµ‹åˆ°æ–°å…´å…³é”®è¯ï¼šã€Œ${['è¿”ç’å½’çœŸ','æç®€ä¸»ä¹‰','ç¡¬æ ¸å¹²è´§','æ²‰æµ¸å¼'][Math.floor(Math.random()*4)]}ã€ï¼Œè¿‘24å°æ—¶ä½¿ç”¨é‡æš´å¢`},
    {type:'TOP VIDEO',cls:'gold',text:`æœ¬å°æ—¶æ¦œé¦–è§†é¢‘å·²ç´¯è®¡ ${(Math.random()*50+20).toFixed(1)} ä¸‡ç‚¹èµï¼Œå»ºè®®ç«‹å³åˆ†æå†…å®¹ç»“æ„`},
    {type:'NEW ENTRY',cls:'green',text:`${selectedTracks[Math.floor(Math.random()*selectedTracks.length)]||'æç¬‘'}èµ›é“æ–°è¿›æ¦œ ${Math.floor(Math.random()*3+1)} ä¸ªè§†é¢‘ï¼Œå‡æ¥è‡ªç´ äººè´¦å·`},
  ];
  const alert = types[Math.floor(Math.random()*types.length)];
  const alertList = document.getElementById('alertList');
  if(alertList.querySelector('.empty')) alertList.innerHTML = '';
  const now = new Date().toLocaleTimeString('zh-CN');
  const div = document.createElement('div');
  div.className = `alert-item ${alert.cls}`;
  div.innerHTML = `<div class="alert-type">${alert.type}</div><div class="alert-text">${alert.text}</div><div class="alert-time">${now}</div>`;
  alertList.insertBefore(div, alertList.firstChild);
  // Keep max 5
  while(alertList.children.length > 5) alertList.removeChild(alertList.lastChild);
  alertCount++;
  document.getElementById('alertCount').textContent = alertCount + ' æ¡';
}

// ============ TREND CHART ============
function drawTrendChart() {
  const canvas = document.getElementById('trendChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = 200;
  ctx.scale(2,2);
  const w = canvas.offsetWidth/2, h = 100;

  // Generate trend data points
  if(trendData.length === 0) {
    for(let i=0;i<24;i++) trendData.push(40+Math.random()*40);
  }
  trendData.push(50+Math.random()*45);
  if(trendData.length > 24) trendData.shift();

  ctx.clearRect(0,0,w,h);

  // Grid
  ctx.strokeStyle = 'rgba(42,45,62,0.6)';
  ctx.lineWidth = 0.5;
  for(let i=0;i<4;i++) {
    const y = (h-10) * i/3 + 5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }

  // Gradient fill
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'rgba(255,51,85,0.3)');
  grad.addColorStop(1,'rgba(255,51,85,0)');

  const pts = trendData.map((v,i) => ({x:i/(trendData.length-1)*w, y:h-10 - (v/100)*(h-20)}));

  ctx.beginPath();
  ctx.moveTo(pts[0].x, h);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, h);
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) {
    const cp = {x:(pts[i-1].x+pts[i].x)/2, y:(pts[i-1].y+pts[i].y)/2};
    ctx.quadraticCurveTo(pts[i-1].x, pts[i-1].y, cp.x, cp.y);
  }
  ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
  ctx.strokeStyle = 'var(--accent)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Last point dot
  const last = pts[pts.length-1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 3, 0, Math.PI*2);
  ctx.fillStyle = 'var(--accent)';
  ctx.fill();
}

// ============ DEEPSEEK KEY MANAGEMENT ============
function openDsKeyModal() {
  const m = document.getElementById('dsKeyModal');
  if (!m) return;
  const inp = document.getElementById('deepseekKeyInput');
  if (inp) { const saved = localStorage.getItem('deepseek_key') || ''; if (saved) inp.value = saved; }
  m.style.display = 'flex';
}
function saveDeepseekKey() {
  const key = document.getElementById('deepseekKeyInput')?.value?.trim();
  const err = document.getElementById('dsKeyError');
  const suc = document.getElementById('dsKeySuccess');
  if (!key || key.length < 10) { err.style.display='block'; err.textContent='è¯·è¾“å…¥æœ‰æ•ˆçš„ DeepSeek API Key'; return; }
  localStorage.setItem('deepseek_key', key);
  err.style.display = 'none';
  suc.style.display = 'block'; suc.textContent = 'âœ… Key å·²ä¿å­˜ï¼ŒDeepSeekç®—åŠ›å·²æ¿€æ´»ï¼';
  setTimeout(() => document.getElementById('dsKeyModal').style.display='none', 1200);
  showToast('âš¡ DeepSeek AI å·²æ¿€æ´»ï¼');
}
function clearDeepseekKey() {
  localStorage.removeItem('deepseek_key');
  const inp = document.getElementById('deepseekKeyInput');
  if (inp) inp.value = '';
  const suc = document.getElementById('dsKeySuccess');
  if (suc) { suc.style.display='block'; suc.textContent='Keyå·²æ¸…é™¤'; }
  showToast('å·²æ¸…é™¤ DeepSeek Key');
}

// ç»Ÿä¸€è°ƒç”¨ AIï¼ˆä¼˜å…ˆ DeepSeekï¼Œé™çº§ Anthropicï¼‰
async function callAI(messages, maxTokens=1500) {
  const dsKey = localStorage.getItem('deepseek_key');
  const anthropicKey = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key');

  if (dsKey) {
    // è°ƒç”¨ DeepSeek å¼€æ”¾å¹³å°
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 40000);
    try {
      const r = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        signal: controller.signal,
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${dsKey}` },
        body: JSON.stringify({
          model: 'deepseek-chat',
          max_tokens: maxTokens,
          messages: messages
        })
      });
      clearTimeout(timer);
      if (!r.ok) throw new Error(`DeepSeek HTTP ${r.status}`);
      const d = await r.json();
      return d.choices?.[0]?.message?.content || '';
    } catch(e) {
      clearTimeout(timer);
      if (e.name === 'AbortError') throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
      throw e;
    }
  } else if (anthropicKey) {
    // é™çº§åˆ° Anthropicï¼ˆé€šè¿‡ä»£ç†ï¼‰
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 40000);
    try {
      const r = await fetch('/api/tikhub', {
        method: 'POST',
        signal: controller.signal,
        headers: { 'Content-Type': 'application/json', 'x-anthropic-key': anthropicKey },
        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: maxTokens, messages })
      });
      clearTimeout(timer);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error));
      return d.content?.[0]?.text || '';
    } catch(e) {
      clearTimeout(timer);
      throw e;
    }
  } else {
    throw new Error('è¯·å…ˆé…ç½® DeepSeek API Keyï¼ˆç‚¹å‡»å³ä¸Šè§’ã€Œé…ç½®DeepSeek Keyã€ï¼‰');
  }
}

// ============ BREAKDOWN WIZARD STEPS ============
let breakdownData = {};   // å­˜å‚¨æ‹†è§£ç»“æœ
let currentProduct = '';  // å½“å‰é€‰å“
let currentSellPoints = []; // å½“å‰äº§å“å–ç‚¹

function azGoto(step) {
  [1,2,3,4].forEach(i => {
    const el = document.getElementById(`az-step${i}`);
    if (el) el.style.display = i===step ? 'block' : 'none';
    const ws = document.getElementById(`ws${i}`);
    const wn = document.getElementById(`wn${i}`);
    if (!ws||!wn) return;
    ws.classList.remove('active','done');
    if(i < step) { ws.classList.add('done'); wn.textContent='âœ“'; }
    else if(i === step) { ws.classList.add('active'); wn.textContent=i; }
    else { wn.textContent=i; }
  });
}
function backToStep1() { azGoto(1); }
function backToStep2() { azGoto(2); }
function backToStep3() { azGoto(3); }

async function startBreakdown() {
  const url = document.getElementById('douyinUrlInput').value.trim();
  const text = document.getElementById('douyinTextInput').value.trim();
  if (!url && !text) { showToast('è¯·å…ˆç²˜è´´æŠ–éŸ³é“¾æ¥æˆ–è§†é¢‘æ–‡å­—ï¼'); return; }

  azGoto(2);
  document.getElementById('breakdownResult').innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px;padding:20px 0;">
      <div class="ld"></div><div class="ld"></div><div class="ld"></div>
      &nbsp;DeepSeek AI æ­£åœ¨æ·±åº¦æ‹†è§£çˆ†æ¬¾ç»“æ„ï¼Œè¯·ç¨å€™...
    </div>`;
  document.getElementById('structureCards').innerHTML = '';

  const aiChat = document.getElementById('aiChat');
  if (aiChat.querySelector('.empty')) aiChat.innerHTML = '';
  addMsg('user', `è¯·å¸®æˆ‘æ·±åº¦æ‹†è§£è¿™ä¸ªçˆ†æ¬¾è§†é¢‘çš„å†…å®¹ç»“æ„ï¼\n${url || text}`);
  const loadEl = addLoadingMsg();

  const input = url
    ? `æŠ–éŸ³çˆ†æ¬¾è§†é¢‘é“¾æ¥ï¼š${url}\n${text ? 'è¡¥å……æè¿°ï¼š'+text : ''}`
    : `æŠ–éŸ³çˆ†æ¬¾è§†é¢‘æ–‡æ¡ˆ/æè¿°ï¼š\n${text}`;

  const prompt = `ä½ æ˜¯é¡¶çº§æŠ–éŸ³çˆ†æ¬¾å†…å®¹ç»“æ„æ‹†è§£ä¸“å®¶ã€‚

${input}

è¯·æŒ‰ä»¥ä¸‹æ¡†æ¶è¿›è¡Œæ·±åº¦æ‹†è§£ï¼ˆä¸­æ–‡ï¼Œç»“åˆçŸ­è§†é¢‘åˆ›ä½œé€»è¾‘ï¼‰ï¼š

## ğŸ¯ çˆ†æ¬¾æ ¸å¿ƒåˆ¤æ–­
ç®€è¦è¯´æ˜è¯¥è§†é¢‘ä¸ºä½•èƒ½çˆ†ï¼ˆæƒ…ç»ªå…±é¸£/ç—›ç‚¹å‡»ä¸­/ä¿¡æ¯ä»·å€¼/å¨±ä¹æ€§ç­‰ï¼‰

## ğŸ“ å†…å®¹ç»“æ„æ‹†è§£
| ç»“æ„å±‚ | å†…å®¹ | æ—¶é•¿/ä½ç½® | ä½œç”¨ |
|--------|------|----------|------|
ï¼ˆæŒ‰é¡ºåºæ‹†è§£ï¼šé»„é‡‘3ç§’é’©å­ â†’ å†…å®¹ä¸»ä½“ â†’ é«˜æ½®ç‚¹ â†’ ç»“å°¾CTAï¼‰

## ğŸ§² æ ¸å¿ƒé’©å­åˆ†æ
- **å¼€å¤´é’©å­ç±»å‹**ï¼šï¼ˆæ‚¬å¿µå¼/ç—›ç‚¹å¼/ç¦åˆ©å¼/å¯¹æ¯”å¼/æ•°å­—å¼ï¼‰
- **é’©å­è¯æœ¯**ï¼šå…·ä½“çš„å¼€å¤´æ–‡æ¡ˆæˆ–é€»è¾‘
- **é’©å­å¼ºåº¦**ï¼šâ­â­â­â­ï¼ˆ1-5æ˜Ÿï¼‰

## ğŸ’¡ æƒ…ç»ªä»·å€¼å…¬å¼
- è§¦å‘æƒ…ç»ªï¼šï¼ˆå¥½å¥‡/ç„¦è™‘/å…±é¸£/æƒŠå–œ/æ„¤æ€’ï¼‰
- æƒ…ç»ªé‡Šæ”¾è·¯å¾„ï¼š

## ğŸ“ æ ‡é¢˜/æ–‡æ¡ˆå…¬å¼
æ€»ç»“å‡ºå¯å¤ç”¨çš„æ ‡é¢˜å…¬å¼ï¼ˆç”¨[]è¡¨ç¤ºå¯æ›¿æ¢å˜é‡ï¼‰

## ğŸ¬ æ‹æ‘„/åˆ¶ä½œç‰¹ç‚¹
- ç”»é¢é£æ ¼ã€å‰ªè¾‘èŠ‚å¥ã€éŸ³ä¹é€‰æ‹©ã€å­—å¹•ç­‰

## ğŸ“Š çˆ†æ¬¾è¯„åˆ†
- é’©å­åŠ›ï¼šX/10 | ä¿¡æ¯å¯†åº¦ï¼šX/10 | æƒ…ç»ªä»·å€¼ï¼šX/10 | äº’åŠ¨å¼•å¯¼ï¼šX/10

## ğŸ”„ å¯å¤åˆ»è¦ç´ ï¼ˆæœ€é‡è¦ï¼‰
åˆ—å‡º3-5ä¸ªæ ¸å¿ƒå¯å¤åˆ»çš„ç»“æ„è¦ç´ ï¼Œè®©ç”¨æˆ·çŸ¥é“æ€ä¹ˆå¥—ç”¨`;

  try {
    const messages = [{role:'user', content: prompt}];
    chatHistory = [...messages];
    const reply = await callAI(messages, 2000);
    chatHistory.push({role:'assistant', content: reply});
    analysisResult = reply;
    breakdownData.report = reply;
    breakdownData.input = input;

    const formatted = reply
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/## (.*)/g,'<div style="font-size:14px;font-weight:700;color:var(--accent2);margin:16px 0 8px;border-left:3px solid var(--accent2);padding-left:10px;">$1</div>')
      .replace(/\|(.*)\|/g, (m) => {
        const cells = m.split('|').filter(c=>c.trim());
        return `<div style="display:flex;gap:2px;margin:2px 0;">${cells.map(c=>`<div style="flex:1;background:var(--surface2);padding:4px 8px;font-size:11px;border-radius:3px;">${c.trim()}</div>`).join('')}</div>`;
      })
      .replace(/^- (.+)$/gm,'<div style="display:flex;gap:8px;margin:3px 0;font-size:12px;"><span style="color:var(--accent);">â–¸</span><span>$1</span></div>')
      .replace(/\n/g,'<br>');

    document.getElementById('breakdownResult').innerHTML = formatted;

    // ç”Ÿæˆç»“æ„å¯è§†åŒ–å¡ç‰‡
    renderStructureCards(reply);

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble">${reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/## /g,'<br><strong>').replace(/\n/g,'<br>').slice(0,600)}...<br><em style="color:var(--accent2)">å®Œæ•´æ‹†è§£å·²åœ¨å·¦ä¾§æ˜¾ç¤º â†’</em></div>`;
    document.getElementById('aiChat').scrollTop = 99999;

  } catch(e) {
    const errMsg = `âš ï¸ æ‹†è§£å¤±è´¥ï¼š${e.message}`;
    document.getElementById('breakdownResult').innerHTML = `<div style="color:var(--accent);font-size:13px;padding:20px;">${errMsg}</div>`;
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble" style="color:var(--accent);">${errMsg}</div>`;
    azGoto(1);
  }
}

function renderStructureCards(report) {
  const container = document.getElementById('structureCards');
  const sections = [
    { icon:'ğŸ§²', label:'é’©å­ç±»å‹', color:'#ff3355', key:'å¼€å¤´é’©å­ç±»å‹' },
    { icon:'ğŸ’¡', label:'æƒ…ç»ªä»·å€¼', color:'#f59e0b', key:'è§¦å‘æƒ…ç»ª' },
    { icon:'ğŸ“', label:'å†…å®¹ç»“æ„', color:'#7c3aed', key:'ç»“æ„' },
    { icon:'ğŸ“', label:'æ ‡é¢˜å…¬å¼', color:'#00d4ff', key:'æ ‡é¢˜' },
  ];
  container.innerHTML = sections.map(s => `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;border-top:3px solid ${s.color};">
      <div style="font-size:18px;margin-bottom:6px;">${s.icon}</div>
      <div style="font-size:11px;font-weight:700;color:${s.color};margin-bottom:4px;">${s.label}</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.6;">ç‚¹å‡»ã€Œé€‰æ‹©äº§å“ã€åAIè‡ªåŠ¨å¡«å……</div>
    </div>
  `).join('');
}

function copyStructure() {
  const text = document.getElementById('breakdownResult').innerText;
  if (!text) { showToast('æš‚æ— å†…å®¹å¯å¤åˆ¶'); return; }
  navigator.clipboard.writeText(text).then(() => showToast('âœ… ç»“æ„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
}

function goToProductSelect() { azGoto(3); }

function quickProduct(name) {
  document.getElementById('productInput').value = name;
  searchProductSellPoints();
}

async function searchProductSellPoints() {
  const product = document.getElementById('productInput').value.trim();
  if (!product) { showToast('è¯·è¾“å…¥äº§å“åç§°ï¼'); return; }
  currentProduct = product;

  const container = document.getElementById('productSellPoints');
  const list = document.getElementById('sellPointsList');
  container.style.display = 'block';
  list.innerHTML = `<div style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;padding:12px 0;"><div class="ld"></div><div class="ld"></div><div class="ld"></div>&nbsp;AI å…¨ç½‘æœç´¢äº§å“å–ç‚¹ä¸­...</div>`;

  addMsg('user', `æˆ‘è¦ç”¨ã€Œ${product}ã€å¥—ç”¨è¿™ä¸ªçˆ†æ¬¾ç»“æ„ï¼Œè¯·å¸®æˆ‘æœç´¢å®ƒçš„æ ¸å¿ƒå–ç‚¹`);
  const loadEl = addLoadingMsg();

  const prompt = `ä½ æ˜¯ç”µå•†äº§å“å–ç‚¹ä¸“å®¶ã€‚
äº§å“ï¼š${product}

è¯·ä»ä»¥ä¸‹ç»´åº¦å…¨é¢åˆ†æäº§å“å–ç‚¹ï¼ˆç»“åˆå½“å‰å¸‚åœºè®¤çŸ¥ï¼Œæ‹ŸäººåŒ–ã€åœºæ™¯åŒ–è¡¨è¾¾ï¼‰ï¼š

1. **æ ¸å¿ƒåŠŸèƒ½å–ç‚¹**ï¼ˆ3æ¡ï¼Œç”¨æ•°å­—/å¯¹æ¯”è¯´è¯ï¼‰
2. **ä½¿ç”¨åœºæ™¯å–ç‚¹**ï¼ˆ3æ¡ï¼Œå…·ä½“ç”Ÿæ´»åœºæ™¯ï¼‰
3. **æƒ…æ„Ÿ/èº«ä»½è®¤åŒå–ç‚¹**ï¼ˆ2æ¡ï¼Œè®©ç”¨æˆ·è§‰å¾—"ä¹°äº†æ˜¯åœ¨ä¹°æ›´å¥½çš„è‡ªå·±"ï¼‰
4. **å·®å¼‚åŒ–å–ç‚¹**ï¼ˆ2æ¡ï¼ŒåŒºåˆ«äºåŒç±»äº§å“çš„ç‹¬ç‰¹ä¹‹å¤„ï¼‰
5. **ç”¨æˆ·ç—›ç‚¹å¯¹åº”**ï¼ˆ3æ¡ï¼Œå…ˆè¯´ç—›ç‚¹å†è¯´äº§å“å¦‚ä½•è§£å†³ï¼‰
6. **çˆ†æ¬¾è¯æœ¯æ¨è**ï¼ˆ3å¥å¯ä»¥ç›´æ¥ç”¨äºè§†é¢‘çš„é‡‘å¥ï¼‰

æ ¼å¼ï¼šæ¯æ¡å–ç‚¹æ§åˆ¶åœ¨30å­—ä»¥å†…ï¼Œç®€æ´æœ‰åŠ›ï¼Œé€‚åˆçŸ­è§†é¢‘å£æ’­ã€‚`;

  try {
    const messages = [{role:'user', content: prompt}];
    const reply = await callAI(messages, 1200);
    currentSellPoints = reply;
    breakdownData.product = product;
    breakdownData.sellPoints = reply;

    const formatted = reply
      .replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--accent2);">$1</strong>')
      .replace(/^(\d+)\./gm, '<br><span style="color:var(--accent);font-weight:700;">$1.</span>')
      .replace(/\n/g,'<br>');

    list.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;font-size:12px;line-height:1.9;">
        ${formatted}
      </div>`;

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble">å·²æœç´¢åˆ°ã€Œ${product}ã€çš„æ ¸å¿ƒå–ç‚¹ï¼ç°åœ¨å¯ä»¥ä¸€é”®ç”Ÿæˆçˆ†æ¬¾è„šæœ¬äº† âœ¨</div>`;
    document.getElementById('aiChat').scrollTop = 99999;
  } catch(e) {
    list.innerHTML = `<div style="color:var(--accent);font-size:12px;padding:10px;">${e.message}</div>`;
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble" style="color:var(--accent);">æœç´¢å¤±è´¥ï¼š${e.message}</div>`;
  }
}

async function generateScript() {
  if (!breakdownData.report) { showToast('è¯·å…ˆå®Œæˆçˆ†æ¬¾æ‹†è§£ï¼'); return; }
  if (!currentProduct) { showToast('è¯·å…ˆé€‰æ‹©äº§å“ï¼'); return; }

  azGoto(4);
  document.getElementById('scriptOutput').innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px;padding:20px 0;">
      <div class="ld"></div><div class="ld"></div><div class="ld"></div>
      &nbsp;DeepSeek AI æ­£åœ¨ç”Ÿæˆçˆ†æ¬¾è„šæœ¬ï¼Œè¯·ç¨å€™...
    </div>`;

  addMsg('user', `è¯·æ ¹æ®çˆ†æ¬¾ç»“æ„å’Œã€Œ${currentProduct}ã€å–ç‚¹ï¼Œç”Ÿæˆå®Œæ•´çš„è§†é¢‘è„šæœ¬ï¼`);
  const loadEl = addLoadingMsg();

  const prompt = `ä½ æ˜¯é¡¶çº§æŠ–éŸ³å¸¦è´§è„šæœ¬åˆ›ä½œä¸“å®¶ã€‚

ã€çˆ†æ¬¾ç»“æ„æ‹†è§£æŠ¥å‘Šã€‘
${breakdownData.report}

ã€äº§å“ã€‘ï¼š${currentProduct}
ã€äº§å“å–ç‚¹ã€‘ï¼š
${currentSellPoints}

ä»»åŠ¡ï¼šå®Œå…¨æŒ‰ç…§ä¸Šé¢æ‹†è§£å‡ºçš„çˆ†æ¬¾ç»“æ„ï¼Œå°†ã€Œ${currentProduct}ã€çš„å–ç‚¹å¡«å……è¿›å»ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„çŸ­è§†é¢‘è„šæœ¬ã€‚

è¦æ±‚ï¼š
1. ä¸¥æ ¼ä¿ç•™åŸçˆ†æ¬¾è§†é¢‘çš„ç»“æ„æ¡†æ¶ï¼ˆé’©å­â†’ä¸»ä½“â†’é«˜æ½®â†’CTAï¼‰
2. å¼€å¤´3ç§’å¿…é¡»æœ‰å¼ºé’©å­ï¼Œå’ŒåŸçˆ†æ¬¾ä¸€æ ·çš„é’©å­ç±»å‹
3. æ¯ä¸ªåœºæ™¯æ ‡æ³¨æ—¶é—´èŠ‚ç‚¹ï¼ˆ0-3s / 3-15s / 15-45s / 45-60sï¼‰
4. åŒ…å«ï¼š[ç”»é¢]ã€[å£æ’­æ–‡æ¡ˆ]ã€[å­—å¹•]ã€[BGMå»ºè®®] å››ä¸ªç»´åº¦
5. ç»“å°¾æœ‰æ˜ç¡®çš„è´­ä¹°å¼•å¯¼CTA
6. æ€»æ—¶é•¿æ§åˆ¶åœ¨60ç§’ä»¥å†…
7. å£æ’­æ–‡æ¡ˆè¦å£è¯­åŒ–ã€æœ‰èŠ‚å¥æ„Ÿ

æ ¼å¼ï¼š
---
ğŸ¬ **è„šæœ¬æ ‡é¢˜**ï¼š[æ ¹æ®æ ‡é¢˜å…¬å¼ç”Ÿæˆçš„çˆ†æ¬¾æ ‡é¢˜]
ğŸ“Š **é¢„ä¼°å®Œæ’­ç‡**ï¼šXX%
â±ï¸ **æ€»æ—¶é•¿**ï¼šXXç§’

---
**[0-3ç§’] é»„é‡‘é’©å­**
- ç”»é¢ï¼š
- å£æ’­ï¼š
- å­—å¹•ï¼š

**[3-15ç§’] é“ºå«/å…±é¸£**
- ç”»é¢ï¼š
- å£æ’­ï¼š
- å­—å¹•ï¼š

ï¼ˆä»¥æ­¤ç±»æ¨ï¼Œå®Œæ•´å†™å‡ºæ¯ä¸ªç»“æ„æ®µè½ï¼‰

---
ğŸ“ **å¤‡é€‰æ ‡é¢˜** Ã— 3ï¼š
1.
2.
3.

ğŸ’¬ **è¯„è®ºåŒºå¼•å¯¼è¯æœ¯**ï¼š`;

  try {
    const messages = [...chatHistory, {role:'user', content: prompt}];
    const reply = await callAI(messages, 2500);
    chatHistory.push({role:'user', content:`ä¸º${currentProduct}ç”Ÿæˆå®Œæ•´è„šæœ¬`});
    chatHistory.push({role:'assistant', content: reply});
    analysisResult = reply;
    breakdownData.script = reply;

    const formatted = reply
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/^---$/gm,'<hr style="border-color:var(--border);margin:16px 0;">')
      .replace(/^#+ (.+)$/gm,'<div style="font-size:14px;font-weight:700;color:var(--accent2);margin:14px 0 8px;">$1</div>')
      .replace(/^- (.+)$/gm,'<div style="display:flex;gap:8px;margin:4px 0;font-size:12px;"><span style="color:var(--accent);">â–¸</span><span>$1</span></div>')
      .replace(/\[(\d+-\d+ç§’[^\]]*)\]/g,'<span style="display:inline-block;background:rgba(255,51,85,0.1);color:var(--accent);border:1px solid rgba(255,51,85,0.25);border-radius:4px;padding:1px 8px;font-size:10px;font-family:\'IBM Plex Mono\',monospace;margin:2px 0;">â± $1</span>')
      .replace(/\n/g,'<br>');

    document.getElementById('scriptOutput').innerHTML = `
      <div style="line-height:2;">${formatted}</div>
      <div style="margin-top:20px;padding:14px;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:8px;">
        <div style="font-size:11px;color:var(--green);font-weight:700;margin-bottom:8px;">ğŸ‰ è„šæœ¬ç”Ÿæˆå®Œæˆï¼ä¸‹ä¸€æ­¥ï¼š</div>
        <div style="font-size:12px;color:var(--text);line-height:1.8;">
          1. ç‚¹å‡»ã€Œå¤åˆ¶è„šæœ¬ã€ä¸€é”®å¤åˆ¶å…¨æ–‡<br>
          2. åœ¨å³ä¾§å¯¹è¯æ¡†å‘AIè¿½é—®ä»»ä½•ç»†èŠ‚<br>
          3. ç‚¹å‡»ã€Œä¿å­˜ã€ç•™å­˜æœ¬æ¬¡åˆ›ä½œ
        </div>
      </div>`;

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble">ğŸ¬ ã€Œ${currentProduct}ã€çˆ†æ¬¾è„šæœ¬å·²ç”Ÿæˆï¼ä¸¥æ ¼æŒ‰ç…§æ‹†è§£ç»“æ„åˆ›ä½œï¼Œå¯ç›´æ¥å¼€æ‹ã€‚å¦‚éœ€è°ƒæ•´é£æ ¼ã€æ›´æ¢è§’åº¦ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼</div>`;
    document.getElementById('aiChat').scrollTop = 99999;
  } catch(e) {
    document.getElementById('scriptOutput').innerHTML = `<div style="color:var(--accent);font-size:13px;padding:20px;">${e.message}</div>`;
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble" style="color:var(--accent);">ç”Ÿæˆå¤±è´¥ï¼š${e.message}</div>`;
    azGoto(3);
  }
}

function copyScript() {
  const text = document.getElementById('scriptOutput').innerText;
  if (!text || text.includes('è¯·ç¨å€™')) { showToast('è„šæœ¬å°šæœªç”Ÿæˆ'); return; }
  navigator.clipboard.writeText(text).then(() => showToast('âœ… è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
}

function saveReport() {
  const content = breakdownData.script || breakdownData.report || analysisResult;
  if(!content) { showToast('æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹'); return; }
  const report = {
    id: Date.now(),
    track: currentProduct || selectedTracks.join('ã€') || 'çˆ†æ¬¾æ‹†è§£',
    source: 'DeepSeek AI',
    time: new Date().toLocaleString('zh-CN'),
    content,
    rawData: breakdownData.input || '',
  };
  savedReports.unshift(report);
  renderReportList();
  showToast('æŠ¥å‘Šå·²ä¿å­˜ï¼');
}

function exportReport() {
  const content = breakdownData.script || breakdownData.report || analysisResult;
  if (!content) { showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹'); return; }
  const text = `æŠ–éŸ³çˆ†æ¬¾æ‹†è§£æŠ¥å‘Š\näº§å“ï¼š${currentProduct||'æœªæŒ‡å®š'}\nç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n\n${content}`;
  const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `çˆ†æ¬¾è„šæœ¬_${currentProduct||'æ‹†è§£'}_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
}

function downloadReport(idx) {
  const r = savedReports[idx];
  const text = `æŠ–éŸ³çˆ†æ¬¾åˆ†ææŠ¥å‘Š\näº§å“/èµ›é“ï¼š${r.track}\næ¥æºï¼š${r.source}\nç”Ÿæˆæ—¶é—´ï¼š${r.time}\n\nAIåˆ†æç»“æœï¼š\n${r.content}\n\nåŸå§‹æ•°æ®ï¼š\n${r.rawData}`;
  const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `çˆ†æ¬¾è„šæœ¬_${r.track}_${r.time.slice(0,10)}.txt`;
  a.click();
}

function renderReportList() {
  const sidebar = document.getElementById('reportSidebar');
  if(savedReports.length === 0) {
    sidebar.innerHTML = `<div class="empty" style="padding:32px 0;"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">æš‚æ— ä¿å­˜çš„æŠ¥å‘Š</div></div>`;
    return;
  }
  sidebar.innerHTML = savedReports.map((r,i) => `
    <div class="report-item ${i===0?'active':''}" onclick="viewReport(${i},this)">
      <div class="report-item-track">ğŸ“ ${r.track}</div>
      <div class="report-item-meta">${r.source} Â· ${r.time}</div>
    </div>
  `).join('');
  viewReport(0, sidebar.firstElementChild);
}

function viewReport(idx, el) {
  document.querySelectorAll('.report-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  const r = savedReports[idx];
  document.getElementById('reportMain').innerHTML = `
    <div class="report-main-hd">
      <div>
        <div style="font-size:15px;font-weight:700;">ğŸ“ ${r.track} Â· çˆ†æ¬¾è„šæœ¬</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">${r.source} Â· ${r.time}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="downloadReport(${idx})">â¬‡ ä¸‹è½½</button>
    </div>
    <div class="report-content">
      <div style="font-size:13px;line-height:1.9;">
        ${r.content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}
      </div>
    </div>`;
}

// ============ AI CHAT ============
function addMsg(role, text) {
  const chat = document.getElementById('aiChat');
  if(chat.querySelector('.empty')) chat.innerHTML='';
  const div = document.createElement('div');
  div.className = role==='ai'?'msg-ai':'msg-user';
  if(role==='ai') {
    div.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  } else {
    div.innerHTML = `<div class="msg-lbl" style="text-align:right">ä½  â–¸</div><div class="msg-bubble">${text}</div>`;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function addLoadingMsg() {
  const chat = document.getElementById('aiChat');
  if(chat.querySelector('.empty')) chat.innerHTML='';
  const div = document.createElement('div');
  div.className='msg-ai';
  div.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="loading-bubble"><div class="ld"></div><div class="ld"></div><div class="ld"></div></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

async function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value='';
  addMsg('user', text);
  const loadEl = addLoadingMsg();
  const activeTrack = selectedTracks.join('ã€') || 'æœªæŒ‡å®š';
  const systemCtx = breakdownData.report ? `\nçˆ†æ¬¾æ‹†è§£ä¸Šä¸‹æ–‡ï¼š${breakdownData.report.slice(0,300)}` : '';
  chatHistory.push({role:'user', content: text});
  try {
    const msgs = [{role:'user', content:`ä½ æ˜¯ä¸“ä¸šçš„æŠ–éŸ³çˆ†æ¬¾å†…å®¹åˆ›ä½œä¸“å®¶ã€‚å½“å‰èµ›é“ï¼š${activeTrack}${systemCtx}\n\nç”¨æˆ·é—®é¢˜ï¼š${text}\n\nè¯·ç®€æ´ã€å¯æ“ä½œåœ°å›ç­”ï¼Œ250å­—ä»¥å†…ï¼Œé€‚å½“ç”¨emojiã€‚`}];
    const reply = await callAI(msgs, 800);
    chatHistory.push({role:'assistant', content: reply});
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble">${reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}</div>`;
    document.getElementById('aiChat').scrollTop = 99999;
  } catch(e) {
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ DeepSeek AI</div><div class="msg-bubble" style="color:var(--accent)">âš ï¸ ${e.message}</div>`;
  }
}

function quickAsk(text) {
  document.getElementById('chatInput').value = text;
  sendMsg();
}

function handleKey(e) {
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();sendMsg();}
}

function clearChat() {
  document.getElementById('aiChat').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ’¬</div><div class="empty-text">å¯¹è¯å·²æ¸…ç©º</div></div>`;
  chatHistory=[];
}

// ============ UTILS ============
function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#1a1d2a;border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:8px;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

// ============ CLOCK ============
setInterval(()=>{
  document.getElementById('clockPill').textContent = new Date().toLocaleTimeString('zh-CN');
},1000);


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// v4 çœŸå®æ•°æ®å¼•æ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dsSource    = localStorage.getItem('ds_source') || null;
let _dsKey       = localStorage.getItem('ds_key')    || null;
let _dsConnected = false;
let _dsSelectedSource = _dsSource || 'tikhub';

const TRACK_KEYWORDS = {
  'ç¾é£Ÿ':['ç¾é£Ÿ','æ¢åº—','åšé¥­','æ–™ç†'],
  'æ—¶å°šç©¿æ­':['ç©¿æ­','æ—¶å°š','ootd','æ˜¾ç˜¦'],
  'æç¬‘æ®µå­':['æç¬‘','æ®µå­','å–œå‰§','æ²™é›•'],
  'æƒ…æ„Ÿè¯­å½•':['æƒ…æ„Ÿ','è¯­å½•','çˆ±æƒ…','æ²»æ„ˆ'],
  'å¥èº«è¿åŠ¨':['å¥èº«','å‡è„‚','è¿åŠ¨','æ’¸é“'],
  'çŸ¥è¯†ç§‘æ™®':['ç§‘æ™®','æ¶¨çŸ¥è¯†','å†·çŸ¥è¯†','å­¦ä¹ '],
  'æ—…æ¸¸æ‰“å¡':['æ—…æ¸¸','æ‰“å¡','æ—…è¡Œ','æ™¯ç‚¹'],
  'æ¯å©´è‚²å„¿':['è‚²å„¿','å®å®','æ¯å©´','æ—©æ•™'],
  'æ¸¸æˆç”µç«':['æ¸¸æˆ','ç‹è€…è£è€€','åŸç¥','ç”µç«'],
  'è´¢ç»å•†ä¸š':['è´¢ç»','ç†è´¢','æŠ•èµ„','å‰¯ä¸š'],
  'å® ç‰©èŒå® ':['å® ç‰©','çŒ«å’ª','ç‹—ç‹—','èŒå® '],
  'ç¾å¦†æŠ¤è‚¤':['ç¾å¦†','æŠ¤è‚¤','å½©å¦†','ç´ é¢œ'],
  default:['çƒ­é—¨','çˆ†æ¬¾','æ¨è'],
};

// â”€â”€ Claude AI é©±åŠ¨çš„æŠ–éŸ³æ•°æ®æœç´¢å¼•æ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// é€šè¿‡ Anthropic API è®© Claude æœç´¢å¹¶è¿”å›çœŸå®æŠ–éŸ³çƒ­é—¨è§†é¢‘
// å®Œå…¨ç»•è¿‡ CORS é™åˆ¶ï¼ˆAnthropic API æ”¯æŒè·¨åŸŸï¼‰

// â”€â”€ åŸå§‹è§†é¢‘å¯¹è±¡ â†’ å·¥å…·ç»Ÿä¸€æ ¼å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeAweme(raw, track) {
  if (!raw || typeof raw !== 'object') return null;
  if (raw._isHotSearch) {
    const kw = raw.desc || '';
    return {
      aweme_id: 'hot_' + kw,
      url: 'https://www.douyin.com/search/' + encodeURIComponent(kw) + '?type=video',
      title: 'ğŸ”¥ çƒ­æœï¼š' + kw,
      fullTitle: kw,
      likes: raw._hotValue ? Math.round(raw._hotValue/10000)+'ä¸‡çƒ­åº¦' : 'çƒ­æœ',
      comments: '--', shares: '--', plays: '--',
      heat: Math.min(99, Math.max(50, Math.round((raw._hotValue||5000000)/100000))),
      cover: '', author: 'æŠ–éŸ³çƒ­æœæ¦œ', track,
      publishedAt: 'ä»Šæ—¥', isNew: true, trend: '+', trendVal: 99,
      emoji: 'ğŸ”¥', source: 'real',
    };
  }
  try {
    const aweme_id = String(raw.aweme_id || raw.id || raw.video_id || '').trim();
    const desc = (raw.desc || raw.title || raw.content || '').trim();
    if (!desc || desc.length < 2) return null;

    const stat = raw.statistics || raw.stats || {};
    const author = raw.author || raw.user || {};
    const likes    = parseInt(stat.digg_count    || stat.like_count    || stat.likes    || 0);
    const comments = parseInt(stat.comment_count || stat.commentCount  || stat.comments || 0);
    const shares   = parseInt(stat.share_count   || stat.shareCount    || stat.shares   || 0);
    const plays    = parseInt(stat.play_count    || stat.playCount     || stat.views    || 0);

    const fmt = n => n>=1e8?(n/1e8).toFixed(1)+'äº¿':n>=1e4?(n/1e4).toFixed(1)+'ä¸‡':n>=1e3?(n/1e3).toFixed(1)+'k':String(n||0);
    // ä¼˜å…ˆç”¨é¢„æ ¼å¼åŒ–å­—ç¬¦ä¸²
    if (raw._likesStr) {
      return {
        aweme_id: 'builtin_' + Math.random().toString(36).slice(2,8),
        url: 'https://www.douyin.com/search/' + encodeURIComponent(raw.search_keyword || raw.desc || '') + '?type=video&sort_type=1',
        title:    raw.desc.length>55 ? raw.desc.slice(0,55)+'â€¦' : raw.desc,
        fullTitle: raw.desc,
        likes:    raw._likesStr,   likesRaw: 0,
        comments: raw._commStr,
        shares:   raw._shareStr,
        plays:    raw._playsStr,
        heat:     raw._heat || 80,
        cover:    '',
        author:   (raw.author||{}).nickname || 'æŠ–éŸ³åšä¸»',
        track,
        publishedAt: 'ä»Šæ—¥',
        isNew:    raw._heat >= 95,
        trend:    raw._heat >= 90 ? '+' : '-',
        trendVal: Math.floor((raw._heat||80) - 70),
        emoji:    EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
        source:   'real',
      };
    }
    const playScore = plays>0 ? Math.log10(plays)*10 : 25;
    const engScore  = Math.log10(Math.max(likes*3+comments*5+shares*8, 1))*12;
    const heat      = Math.min(99, Math.max(30, Math.round(playScore + engScore)));
    const secUid    = author.sec_uid || author.uid || '';
    const keyword   = raw.search_keyword || '';

    // è§†é¢‘ç›´é“¾ï¼šæœ‰ aweme_id å°±ç²¾å‡†è·³è½¬ï¼Œå¦åˆ™ç”¨å…³é”®è¯æœç´¢
    const url = aweme_id && !aweme_id.startsWith('search_')
      ? 'https://www.douyin.com/video/' + aweme_id
      : 'https://www.douyin.com/search/' + encodeURIComponent(keyword || desc) + '?type=video';

    return {
      aweme_id: aweme_id || ('ai_' + Math.random().toString(36).slice(2,8)),
      url,
      title:    desc.length>55 ? desc.slice(0,55)+'â€¦' : desc,
      fullTitle: desc,
      likes:    fmt(likes),    likesRaw: likes,
      comments: fmt(comments),
      shares:   fmt(shares),
      plays:    fmt(plays),
      heat,
      cover:    raw.video?.cover?.url_list?.[0] || '',
      author:   author.nickname || author.name || 'æŠ–éŸ³ç”¨æˆ·',
      authorUrl: secUid ? 'https://www.douyin.com/user/'+secUid : '',
      track,
      publishedAt: 'æœ€è¿‘',
      isNew:    false,
      trend:    likes>10000 ? '+' : '-',
      trendVal: Math.floor(Math.random()*20+1),
      emoji:    EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
      source:   'real',
    };
  } catch(e) { console.warn('normalizeAweme:', e.message); return null; }
}

// â”€â”€ çœŸå®æ•°æ®è·å–ï¼šé€šè¿‡ Claude API æœç´¢æŠ–éŸ³çƒ­é—¨è§†é¢‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åŸç†ï¼šè°ƒç”¨ Anthropic APIï¼Œè®© AI è”ç½‘æœç´¢æŠ–éŸ³çœŸå®çƒ­é—¨è§†é¢‘ï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®
// ä¼˜ç‚¹ï¼šæ—  CORS é—®é¢˜ï¼Œfile:// å¯ç”¨ï¼Œä¸éœ€è¦ TikHub è´¦æˆ·
// â”€â”€ TikHub æ•°æ®ï¼ˆé€šè¿‡æœ¬ç«™ /api/tikhub ä¸­è½¬ï¼Œæ—  CORS é—®é¢˜ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchViaTikHub(keyword) {
  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  if (!key) return null;

  // å…ˆå°è¯•å…³é”®è¯æœç´¢ï¼Œå†fallbackåˆ°çƒ­æœæ¦œ
  const requests = [
    { url: `/api/tikhub?endpoint=search&keyword=${encodeURIComponent(keyword)}`, type: 'search' },
    { url: `/api/tikhub?endpoint=hot_search`, type: 'hot_search' },
  ];

  for (const req of requests) {
    try {
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 15000);
      const r = await fetch(req.url, {
        signal: controller.signal,
        headers: { 'x-api-key': key }
      });
      if (!r.ok) { console.warn('[TikHub] HTTP', r.status); continue; }
      const j = await r.json();
      console.log('[TikHub proxy] endpoint:', req.type, 'success:', j?.success, 'items:', j?.items?.length);

      if (!j?.success) {
        if (j?.error?.includes('401') || j?.error?.includes('æ— æ•ˆ')) throw new Error('TikHub Key æ— æ•ˆï¼ˆ401ï¼‰');
        continue;
      }

      // æœç´¢ç»“æœï¼šç›´æ¥è¿”å›è§†é¢‘åˆ—è¡¨æ ¼å¼
      if (req.type === 'search' && j.items?.length > 0) {
        return j.items.map(item => ({
          aweme_id: item.awemeId || '',
          desc: item.desc || '',
          author: { nickname: item.author || '', uid: item.authorId || '' },
          statistics: {
            digg_count: item.diggCount || 0,
            comment_count: item.commentCount || 0,
            share_count: item.shareCount || 0,
            play_count: item.playCount || 0,
          },
          video: { cover: { url_list: item.coverUrl ? [item.coverUrl] : [] } },
          search_keyword: keyword,
        }));
      }

      // çƒ­æœç»“æœï¼šè½¬æ¢ä¸ºå¯è¯†åˆ«çš„æ ¼å¼
      if (req.type === 'hot_search' && j.items?.length > 0) {
        return j.items.slice(0, 20).map(item => ({
          _isHotSearch: true,
          desc: item.word || '',
          _hotValue: item.hotValue || 0,
        }));
      }
    } catch(e) {
      if (e.name === 'AbortError') { console.warn('[TikHub] timeout'); continue; }
      if (e.message.includes('æ— æ•ˆ')) throw e;
      console.warn('[TikHub]', e.message);
    }
  }
  return null;
}

async function fetchViaRapidApi(keyword) {
  return await fetchViaTikHub(keyword);
}








// â”€â”€ æ•°æ®æºå¼¹çª—æ‰€æœ‰ UI å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


function saveKeyOnly() {
  const key = document.getElementById('dsApiKeyInput')?.value?.trim();
  const errEl = document.getElementById('dsError');
  if (!key || key.length < 8) {
    if (errEl) { errEl.style.display='block'; errEl.textContent='è¯·å…ˆç²˜è´´å®Œæ•´çš„ API Key'; }
    return;
  }
  localStorage.setItem('tikhub_key', key);
  localStorage.setItem('ds_key', key);
  localStorage.setItem('ds_source', 'tikhub');
  _dsKey = key; _dsSource = 'tikhub';
  const succ = document.getElementById('dsSuccess');
  if (succ) {
    succ.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
    succ.textContent = 'âœ… Key å·²ä¿å­˜ï¼ä¸Šä¼ åˆ° Vercel åå³å¯è·å–çœŸå®æ•°æ®';
  }
}

function openDataSourceModal() {
  const m = document.getElementById('dsModal');
  if (!m) return;
  m.style.display = 'flex';
  const inp = document.getElementById('dsApiKeyInput');
  if (inp) {
    const saved = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';
    if (saved) inp.value = saved;
  }
  _updateDsUI();
}

function selectDataSource(src) {
  _dsSelectedSource = src;
}

function _updateDsUI() {
  const s = document.getElementById('dsSuccess');
  const e = document.getElementById('dsError');
  if (e) e.style.display = 'none';
  if (!s) return;
  const hasKey = !!(localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key'));
  if (_dsConnected) {
    s.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
    s.textContent = 'âœ… å·²è¿æ¥ï¼Œæ­£åœ¨è·å–çœŸå®æŠ–éŸ³æ•°æ®';
  } else if (hasKey) {
    s.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#92400e;background:#fef3c7;border:1px solid #fde68a;';
    s.textContent = 'âš ï¸ Key å·²ä¿å­˜ï¼Œè¯·ç‚¹ã€Œè¿æ¥å¹¶æµ‹è¯•ã€ç¡®è®¤';
  } else {
    s.style.display = 'none';
  }
}

async function testAndSaveDataSource() {
  const key = document.getElementById('dsApiKeyInput')?.value?.trim();
  const errEl = document.getElementById('dsError');
  const succ  = document.getElementById('dsSuccess');
  if (errEl) errEl.style.display = 'none';
  if (succ)  succ.style.display  = 'none';
  if (!key || key.length < 8) {
    if (errEl) { errEl.style.display='block'; errEl.textContent='è¯·å…ˆç²˜è´´å®Œæ•´çš„ API Key'; }
    return;
  }
  const btn = document.querySelector('[onclick="testAndSaveDataSource()"]');
  if (btn) { btn.textContent = 'â³ æµ‹è¯•ä¸­â€¦'; btn.disabled = true; }

  // åˆ¤æ–­ Key ç±»å‹ï¼šsk-ant- å¼€å¤´ = Anthropic Keyï¼›å¦åˆ™å½“ TikHub Key
  const isAnthropic = key.startsWith('sk-ant-');
  const isTikHub    = !isAnthropic;

  localStorage.setItem('ds_key', key);
  localStorage.setItem('ds_source', isAnthropic ? 'anthropic' : 'tikhub');
  if (isAnthropic) localStorage.setItem('anthropic_key', key);
  else             localStorage.setItem('tikhub_key', key);
  _dsKey = key; _dsSource = isAnthropic ? 'anthropic' : 'tikhub';

  try {
    let testOk = false;
    let sampleText = '';

    if (isAnthropic) {
      // æµ‹è¯• Anthropic Keyï¼ˆé€šè¿‡æœåŠ¡ç«¯ä»£ç†ï¼Œæ—  CORSï¼‰
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 20000);
      const r = await fetch('/api/tikhub', {
        method: 'POST',
        signal: controller.signal,
        headers: { 'Content-Type': 'application/json', 'x-anthropic-key': key },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 20,
          messages: [{ role: 'user', content: 'å›å¤"è¿æ¥æ­£å¸¸"' }]
        })
      });
      clearTimeout(timer);
      if (r.status === 401) throw new Error('Anthropic Key æ— æ•ˆï¼ˆ401ï¼‰ï¼Œè¯·ç¡®è®¤ Key æ­£ç¡®');
      if (r.status === 403) throw new Error('Key æ— æƒè®¿é—®ï¼Œè¯·æ£€æŸ¥è´¦æˆ·çŠ¶æ€');
      const d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error));
      sampleText = d.content?.[0]?.text || 'OK';
      testOk = true;
    } else {
      // æµ‹è¯• TikHub Keyï¼šè°ƒç”¨çƒ­æœæ¦œæ¥å£
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 20000);
      const r = await fetch('/api/tikhub?endpoint=hot_search', {
        signal: controller.signal,
        headers: { 'x-api-key': key }
      });
      const j = await r.json();
      if (!j?.success) throw new Error(j?.error || 'TikHub è¿”å›å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Key å’Œè´¦æˆ·ä½™é¢');
      const count = j?.items?.length || 0;
      if (count === 0) throw new Error('TikHub è¿”å›æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ Key å’Œè´¦æˆ·ä½™é¢');
      sampleText = `è·å–åˆ° ${count} æ¡çƒ­æœæ•°æ®`;
      testOk = true;
    }

    if (testOk) {
      _dsConnected = true;
      if (succ) {
        succ.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
        succ.textContent = 'âœ… è¿æ¥æˆåŠŸï¼' + (isAnthropic ? 'Anthropic AI å·²å°±ç»ª Â· ' : 'TikHub Â· ') + sampleText;
      }
      if (errEl) errEl.style.display = 'none';
      _refreshDsBadges();
      setTimeout(() => {
        document.getElementById('dsModal').style.display = 'none';
        refreshFeed(true);
        showToast('ğŸ‰ ' + (isAnthropic ? 'AI åˆ†æåŠŸèƒ½å·²æ¿€æ´»ï¼' : 'çœŸå®æ•°æ®å·²æ¥å…¥ï¼'));
      }, 1500);
    }
  } catch(e) {
    _dsConnected = false; _dsKey = null;
    localStorage.removeItem('ds_key');
    localStorage.removeItem('anthropic_key');
    localStorage.removeItem('tikhub_key');
    const msg = 'âŒ ' + (e.name==='AbortError'||e.message.includes('TIMEOUT')
      ? 'è¯·æ±‚è¶…æ—¶ï¼ˆ20ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
      : e.message.slice(0, 150));
    if (errEl) {
      errEl.style.cssText = 'display:block;font-size:11px;padding:10px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;white-space:pre-line;';
      errEl.textContent = msg;
    }
  } finally {
    if (btn) { btn.textContent = 'ğŸ”Œ è¿æ¥å¹¶æµ‹è¯•'; btn.disabled = false; }
  }
}

function clearDataSource() {
  _dsKey = null; _dsSource = null; _dsConnected = false;
  localStorage.removeItem('ds_key');
  localStorage.removeItem('ds_source');
  localStorage.removeItem('anthropic_key');
  const inp = document.getElementById('dsApiKeyInput');
  if (inp) inp.value = '';
  _updateDsUI();
  _refreshDsBadges();
  showToast('å·²æ¸…é™¤ï¼Œåˆ‡æ¢æ¼”ç¤ºæ¨¡å¼');
}

function _refreshDsBadges() {
  const ok    = _dsConnected && !!_dsSource;
  const badge = document.getElementById('dataSourceBadge');
  const btn   = document.getElementById('dsStatusBtn');
  if (badge) {
    badge.style.background = ok ? 'rgba(16,185,129,0.1)' : '#1a1d2a';
    badge.style.color      = ok ? '#10b981' : '#9ca3af';
    badge.textContent      = ok ? 'â— å®æ—¶æ•°æ®' : 'æ¼”ç¤ºæ•°æ®';
  }
  if (btn) {
    btn.style.background  = ok ? 'rgba(16,185,129,0.15)' : 'rgba(99,102,241,0.15)';
    btn.style.borderColor = ok ? 'rgba(16,185,129,0.4)'  : 'rgba(99,102,241,0.3)';
    btn.style.color       = ok ? '#10b981' : '#818cf8';
    btn.textContent       = ok ? 'âœ… çœŸå®æ•°æ®' : 'ğŸ“¡ æ•°æ®æº';
  }
}

// åˆå§‹åŒ–èµ›é“ç½‘æ ¼
renderTrackGrid();

// å¯åŠ¨æ—¶æ¢å¤å·²ä¿å­˜çš„ Key
(function restoreDs() {
  _dsSource = 'builtin'; _dsConnected = true;
  setTimeout(() => {
    _refreshDsBadges();
    const badge = document.getElementById('dataSourceBadge');
    if (badge) { badge.textContent = 'â— å†…ç½®æ•°æ®'; badge.style.color='#10b981'; }
    const btn = document.getElementById('dsStatusBtn');
    if (btn) { btn.textContent = 'ğŸ“Š æ•°æ®ç®¡ç†'; }
  }, 300);
})();


</script>


<!-- â•â•â• æ•°æ®æºé…ç½®æ¨¡æ€æ¡† â•â•â• -->
<div id="dsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
  <div style="background:#fff;border-radius:18px;padding:28px;width:92%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,0.25);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-size:16px;font-weight:800;color:#111827;">ğŸ”Œ æ¥å…¥çœŸå®æŠ–éŸ³æ•°æ®</div>
        <div style="font-size:11px;color:#9ca3af;margin-top:3px;">å¡«å…¥ TikHub Key â†’ è¿æ¥æµ‹è¯• â†’ è·å–çœŸå®æŠ–éŸ³æ•°æ®</div>
      </div>
      <button onclick="document.getElementById('dsModal').style.display='none'" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:22px;">âœ•</button>
    </div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px;color:#1e40af;line-height:1.7;">
      <strong>ğŸ’¡ æ”¯æŒä¸¤ç§ Keyï¼š</strong><br>
      <strong>â‘  Anthropic API Key</strong>ï¼ˆ<code style="background:#dbeafe;padding:1px 4px;border-radius:3px;">sk-ant-...</code>ï¼‰â†’ æ¿€æ´» AI åˆ†æåŠŸèƒ½ï¼ˆåˆ†ææŠ¥å‘Š + AI å¯¹è¯ï¼‰<br>
      <strong>â‘¡ TikHub API Key</strong> â†’ è·å–çœŸå®æŠ–éŸ³çˆ†æ¬¾è§†é¢‘æ•°æ®ï¼ˆå®æ—¶ç›‘æµ‹æ¦œï¼‰<br>
      å¡«å…¥å…¶ä¸­ä¸€ä¸ªå³å¯ï¼Œå¡«ä¸¤ä¸ªéƒ½æ”¯æŒã€‚
    </div>

    <!-- Anthropic -->
    <div id="ds-tikhub-card" style="border:2px solid #6366f1;border-radius:12px;padding:14px 16px;margin-bottom:10px;background:#f5f3ff;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:18px;">ğŸ¤–</span>
          <span style="font-size:13px;font-weight:800;color:#111827;">Anthropic API Key</span>
          <span style="font-size:9px;background:#dcfce7;color:#166534;border-radius:20px;padding:2px 8px;font-weight:700;">æ¨è Â· ç›´æ¥å¯ç”¨</span>
        </div>
        <div id="ds-tikhub-check" style="color:#10b981;font-size:18px;font-weight:700;">âœ“</div>
      </div>
      <div style="font-size:11px;color:#6b7280;line-height:1.6;">ä½¿ç”¨ Claude AI ç”Ÿæˆå„èµ›é“çƒ­é—¨è§†é¢‘æ•°æ®ï¼Œæ—  CORS é™åˆ¶ï¼Œfile:// ç›´æ¥å¯ç”¨ã€‚</div>
      <div style="margin-top:8px;background:#f8fafc;border-radius:6px;padding:8px 10px;font-size:10px;color:#374151;line-height:1.9;">
        <strong>è·å–æ­¥éª¤ï¼š</strong><br>
        1. æ‰“å¼€ <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#3b82f6;font-weight:600;">console.anthropic.com</a> â†’ API Keys<br>
        2. ç‚¹ <strong>ã€ŒCreate Keyã€</strong> â†’ å¤åˆ¶ï¼ˆ<code style="background:#e5e7eb;padding:1px 4px;border-radius:3px;">sk-ant-...</code> å¼€å¤´ï¼‰<br>
        3. ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œç‚¹ã€Œè¿æ¥å¹¶æµ‹è¯•ã€
      </div>
    </div>

    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:6px;">API Key</div>
      <input id="dsApiKeyInput" type="password" placeholder="sk-ant-api03-... (Anthropic) æˆ– TikHub Key"
        style="width:100%;background:#f9fafb;border:1.5px solid #e5e7eb;border-radius:8px;padding:11px 14px;font-family:monospace;font-size:12px;color:#111827;outline:none;box-sizing:border-box;"
        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"
      />
    </div>

    <div id="dsError" style="display:none;font-size:11px;padding:10px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;white-space:pre-line;line-height:1.6;"></div>
    <div id="dsSuccess" style="display:none;"></div>

    <div style="display:flex;gap:8px;">
      <button onclick="testAndSaveDataSource()" style="flex:1;padding:12px;background:#111827;border:none;border-radius:9px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        ğŸ”Œ è¿æ¥å¹¶æµ‹è¯•
      </button>
      <button onclick="clearDataSource()" style="padding:12px 16px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9px;color:#6b7280;font-size:12px;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        æ¸…é™¤
      </button>
    </div>
    <div style="font-size:10px;color:#9ca3af;margin-top:10px;text-align:center;">Key ä»…å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ ä»»ä½•æœåŠ¡å™¨</div>
  </div>
</div>

<!-- â•â•â• æ·»åŠ è´¦å·å¼¹çª— â•â•â• -->
<div id="addAccModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
  <div style="background:#fff;border-radius:18px;padding:28px;width:92%;max-width:480px;box-shadow:0 24px 60px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-size:16px;font-weight:800;color:#111827;">ğŸ‘¤ æ·»åŠ ç›‘æµ‹è´¦å·</div>
        <div style="font-size:11px;color:#9ca3af;margin-top:3px;">å¡«å†™è´¦å·ä¿¡æ¯ï¼Œè®¾å®šçˆ†æ¬¾æŒ‡æ•°é˜ˆå€¼</div>
      </div>
      <button onclick="closeAddAccountModal()" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:22px;">âœ•</button>
    </div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px;color:#1e40af;line-height:1.8;">
      <strong>ğŸ’¡ æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š</strong><br>
      â‘  ä¸»é¡µé“¾æ¥ï¼š<code style="background:#dbeafe;padding:1px 4px;border-radius:3px;">https://www.douyin.com/user/MS4wLjABAAAA...</code><br>
      â‘¡ @è´¦å·ï¼š<code style="background:#dbeafe;padding:1px 4px;border-radius:3px;">@è´¦å·æ˜µç§°</code><br>
      â‘¢ ç›´æ¥å¡«æ˜µç§°ï¼ˆç”¨äºæ¼”ç¤ºæ¨¡å¼ï¼‰
    </div>

    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:6px;">è´¦å·ä¸»é¡µé“¾æ¥ï¼ˆå¯é€‰ï¼‰</div>
      <input id="accUrlInput" type="text" placeholder="https://www.douyin.com/user/..."
        style="width:100%;background:#f9fafb;border:1.5px solid #e5e7eb;border-radius:8px;padding:11px 14px;font-size:12px;color:#111827;outline:none;box-sizing:border-box;font-family:monospace;"
        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"/>
    </div>

    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:6px;">è´¦å·æ˜µç§°ï¼ˆæ˜¾ç¤ºåç§°ï¼‰</div>
      <input id="accNickInput" type="text" placeholder="ä¾‹å¦‚ï¼šæå­æŸ’ã€papié…±ã€ç–¯ç‹‚å°æ¨å“¥..."
        style="width:100%;background:#f9fafb;border:1.5px solid #e5e7eb;border-radius:8px;padding:11px 14px;font-size:13px;color:#111827;outline:none;box-sizing:border-box;font-family:'Noto Sans SC',sans-serif;"
        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"/>
    </div>

    <div style="margin-bottom:18px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <div style="font-size:11px;color:#374151;font-weight:700;">çˆ†æ¬¾æŒ‡æ•°é˜ˆå€¼</div>
        <span id="accThreshPreview" style="font-size:15px;font-weight:800;color:#ef4444;font-family:monospace;">80</span>
      </div>
      <input type="range" id="accThreshInput" min="50" max="99" value="80"
        style="width:100%;accent-color:#ef4444;"
        oninput="document.getElementById('accThreshPreview').textContent=this.value;document.getElementById('accThreshHint').textContent=this.value"/>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:#9ca3af;margin-top:4px;">
        <span>50 Â· æ™®é€š</span>
        <span>70 Â· è¾ƒçƒ­</span>
        <span>85 Â· çˆ†æ¬¾</span>
        <span>99 Â· è¶…çº§çˆ†æ¬¾</span>
      </div>
      <div style="margin-top:8px;font-size:11px;color:#6b7280;background:#f9fafb;border-radius:6px;padding:8px 10px;">
        âš¡ å½“è¯¥è´¦å·æœ‰è§†é¢‘çˆ†æ¬¾æŒ‡æ•°è¶…è¿‡ <strong id="accThreshHint" style="color:#ef4444;">80</strong> æ—¶ï¼Œç³»ç»Ÿå°†å¼¹çª—æé†’ä½ 
      </div>
    </div>

    <div id="addAccError" style="display:none;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;"></div>

    <div style="display:flex;gap:8px;">
      <button onclick="addAccount()" style="flex:1;padding:12px;background:#111827;border:none;border-radius:9px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        âœ… æ·»åŠ å¹¶å¼€å§‹ç›‘æµ‹
      </button>
      <button onclick="closeAddAccountModal()" style="padding:12px 16px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9px;color:#6b7280;font-size:12px;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        å–æ¶ˆ
      </button>
    </div>
  </div>
</div>


<script>
// ====== SUPABASE AUTH ======
const SUPABASE_URL = 'https://tmgeooxadslsmijonzzj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtZ2Vvb3hhZHNsc21pam9uenpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjU5MzAsImV4cCI6MjA4NzUwMTkzMH0.grXfw6ttC7NuhTPvn9vNYBc0Sbo5CzQf830bzRdPJtA';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let _authMode = 'login'; // login | register
let _authMethod = 'email'; // email | phone
let _smsCountdown = 0;

async function initAuth() {
  const { data: { session } } = await _supabase.auth.getSession();
  if (session) {
    hideAuthOverlay();
  }
  _supabase.auth.onAuthStateChange((event, session) => {
    if (session) hideAuthOverlay();
  });
}

function hideAuthOverlay() {
  const overlay = document.getElementById('authOverlay');
  if (overlay) {
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.4s';
    setTimeout(() => overlay.style.display = 'none', 400);
  }
}

function switchAuthMode(mode) {
  _authMode = mode;
  document.getElementById('tabLogin').className = 'auth-tab' + (mode === 'login' ? ' active' : '');
  document.getElementById('tabRegister').className = 'auth-tab' + (mode === 'register' ? ' active' : '');
  document.getElementById('usernameField').style.display = mode === 'register' ? 'block' : 'none';
  document.getElementById('emailSubmitBtn').textContent = mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
  clearAuthMsg();
}

function switchMethod(method) {
  _authMethod = method;
  document.getElementById('methodEmail').className = 'auth-method-tab' + (method === 'email' ? ' active' : '');
  document.getElementById('methodPhone').className = 'auth-method-tab' + (method === 'phone' ? ' active' : '');
  document.getElementById('emailForm').style.display = method === 'email' ? 'block' : 'none';
  document.getElementById('phoneForm').style.display = method === 'phone' ? 'block' : 'none';
  clearAuthMsg();
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('authSuccess').style.display = 'none';
}
function showAuthSuccess(msg) {
  const el = document.getElementById('authSuccess');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('authError').style.display = 'none';
}
function clearAuthMsg() {
  document.getElementById('authError').style.display = 'none';
  document.getElementById('authSuccess').style.display = 'none';
}

async function handleEmailAuth() {
  const email = document.getElementById('inputEmail').value.trim();
  const password = document.getElementById('inputPassword').value;
  const username = document.getElementById('inputUsername').value.trim();
  const btn = document.getElementById('emailSubmitBtn');
  if (!email || !password) return showAuthError('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
  if (password.length < 6) return showAuthError('å¯†ç è‡³å°‘6ä½');
  btn.disabled = true;
  btn.textContent = 'è¯·ç¨å€™...';
  clearAuthMsg();
  try {
    if (_authMode === 'login') {
      const { error } = await _supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
    } else {
      const { error } = await _supabase.auth.signUp({
        email, password,
        options: { data: { username: username || email.split('@')[0] } }
      });
      if (error) throw error;
      showAuthSuccess('æ³¨å†ŒæˆåŠŸï¼è¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶ï¼Œç‚¹å‡»ç¡®è®¤åç™»å½•ã€‚');
      btn.disabled = false;
      btn.textContent = 'æ³¨å†Œ';
      return;
    }
  } catch(e) {
    let msg = e.message || 'æ“ä½œå¤±è´¥';
    if (msg.includes('Invalid login')) msg = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯';
    if (msg.includes('already registered')) msg = 'è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•';
    if (msg.includes('Email not confirmed')) msg = 'è¯·å…ˆéªŒè¯é‚®ç®±åå†ç™»å½•';
    showAuthError(msg);
  }
  btn.disabled = false;
  btn.textContent = _authMode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
}

async function sendSmsCode() {
  const phone = document.getElementById('inputPhone').value.trim();
  if (!phone) return showAuthError('è¯·è¾“å…¥æ‰‹æœºå·');
  const btn = document.getElementById('sendCodeBtn');
  btn.disabled = true;
  clearAuthMsg();
  try {
    const { error } = await _supabase.auth.signInWithOtp({ phone });
    if (error) throw error;
    document.getElementById('codeField').style.display = 'block';
    document.getElementById('phoneSubmitBtn').style.display = 'block';
    showAuthSuccess('éªŒè¯ç å·²å‘é€ï¼');
    let count = 60;
    _smsCountdown = setInterval(() => {
      btn.textContent = count + 'såé‡å‘';
      count--;
      if (count < 0) { clearInterval(_smsCountdown); btn.disabled = false; btn.textContent = 'å‘é€éªŒè¯ç '; }
    }, 1000);
  } catch(e) {
    let msg = e.message || 'å‘é€å¤±è´¥';
    if (msg.includes('SMS')) msg = 'çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰‹æœºå·æ ¼å¼ï¼ˆéœ€+86å¼€å¤´ï¼‰';
    showAuthError(msg);
    btn.disabled = false;
  }
}

async function handlePhoneAuth() {
  const phone = document.getElementById('inputPhone').value.trim();
  const token = document.getElementById('inputCode').value.trim();
  const btn = document.getElementById('phoneSubmitBtn');
  if (!phone || !token) return showAuthError('è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç ');
  btn.disabled = true; btn.textContent = 'éªŒè¯ä¸­...';
  clearAuthMsg();
  try {
    const { error } = await _supabase.auth.verifyOtp({ phone, token, type: 'sms' });
    if (error) throw error;
  } catch(e) {
    let msg = e.message || 'éªŒè¯å¤±è´¥';
    if (msg.includes('Token has expired')) msg = 'éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°å‘é€';
    if (msg.includes('Invalid')) msg = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥';
    showAuthError(msg);
  }
  btn.disabled = false; btn.textContent = 'éªŒè¯å¹¶ç™»å½•';
}

initAuth();
</script>

</body>
</html>
