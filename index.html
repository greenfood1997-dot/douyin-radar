<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŠ–éŸ³çˆ†æ¬¾é›·è¾¾ v4.0 Â· çœŸå®æ•°æ®ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0e14;
  --surface: #13151f;
  --surface2: #1a1d2a;
  --surface3: #212436;
  --border: #2a2d3e;
  --accent: #ff3355;
  --accent2: #00d4ff;
  --accent3: #7c3aed;
  --gold: #f59e0b;
  --green: #10b981;
  --text: #e8eaf0;
  --muted: #6b7280;
  --ink: #f0f2f8;
}

*{margin:0;padding:0;box-sizing:border-box;}

body {
  font-family:'Noto Sans SC',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

/* Animated mesh bg */
body::before {
  content:'';
  position:fixed;inset:0;
  background:
    radial-gradient(ellipse 800px 600px at 0% 0%, rgba(255,51,85,0.07) 0%,transparent 60%),
    radial-gradient(ellipse 600px 500px at 100% 100%, rgba(0,212,255,0.06) 0%,transparent 60%),
    radial-gradient(ellipse 500px 400px at 50% 50%, rgba(124,58,237,0.04) 0%,transparent 60%);
  pointer-events:none;z-index:0;
}

/* ====== HEADER ====== */
header {
  background:rgba(13,15,21,0.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:0 32px;
  height:60px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:12px;}
.logo-mark{
  width:34px;height:34px;
  background:linear-gradient(135deg,var(--accent),#ff6b35);
  border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;box-shadow:0 0 20px rgba(255,51,85,0.3);
}
.logo-text{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;letter-spacing:2px;}
.logo-badge{
  font-size:9px;letter-spacing:1px;font-family:'IBM Plex Mono',monospace;
  background:rgba(255,51,85,0.15);border:1px solid rgba(255,51,85,0.3);
  color:var(--accent);padding:2px 8px;border-radius:3px;
}
.header-center{display:flex;align-items:center;gap:6px;}
.nav-tab{
  padding:6px 16px;border-radius:6px;font-size:12px;font-weight:500;
  cursor:pointer;transition:all 0.15s;color:var(--muted);border:1px solid transparent;
}
.nav-tab:hover{color:var(--text);}
.nav-tab.active{background:var(--surface2);border-color:var(--border);color:var(--text);}
.header-right{display:flex;align-items:center;gap:16px;}
.status-pill{
  display:flex;align-items:center;gap:6px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:20px;padding:5px 14px;font-size:11px;
  font-family:'IBM Plex Mono',monospace;color:var(--muted);
}
.pulse-dot{
  width:7px;height:7px;border-radius:50%;background:var(--green);
  animation:pulse 2s infinite;
}
.pulse-dot.red{background:var(--accent);}
.pulse-dot.yellow{background:var(--gold);}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,0.4);}50%{opacity:0.6;box-shadow:0 0 0 4px rgba(16,185,129,0);}}

/* ====== MAIN TABS ====== */
#view-monitor,#view-track,#view-analyze,#view-report{display:none;}
#view-monitor.active,#view-track.active,#view-analyze.active,#view-report.active{display:block;}

/* ====== LAYOUT ====== */
.page{
  max-width:1440px;margin:0 auto;
  padding:24px 32px;
  position:relative;z-index:1;
}

/* ====== SECTION HEADER ====== */
.section-hd{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:20px;
}
.section-title{
  font-size:16px;font-weight:700;
  display:flex;align-items:center;gap:8px;
}
.section-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.section-label{
  font-family:'IBM Plex Mono',monospace;
  font-size:10px;letter-spacing:3px;text-transform:uppercase;
  color:var(--muted);margin-bottom:14px;
  display:flex;align-items:center;gap:8px;
}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ====== CARDS ====== */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:14px;overflow:hidden;
}
.card-hd{
  padding:16px 20px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.card-title{font-size:13px;font-weight:700;}
.card-body{padding:18px 20px;}

/* ====== MONITOR VIEW ====== */
.monitor-top{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;margin-bottom:20px;
}
.metric-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:18px 20px;
  position:relative;overflow:hidden;
  transition:border-color 0.2s;
}
.metric-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.metric-card.red::before{background:linear-gradient(90deg,var(--accent),transparent);}
.metric-card.blue::before{background:linear-gradient(90deg,var(--accent2),transparent);}
.metric-card.purple::before{background:linear-gradient(90deg,var(--accent3),transparent);}
.metric-card.gold::before{background:linear-gradient(90deg,var(--gold),transparent);}
.metric-lbl{font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;font-family:'IBM Plex Mono',monospace;}
.metric-val{font-size:26px;font-weight:900;font-family:'IBM Plex Mono',monospace;}
.metric-val.red{color:var(--accent);}
.metric-val.blue{color:var(--accent2);}
.metric-val.purple{color:var(--accent3);}
.metric-val.gold{color:var(--gold);}
.metric-change{font-size:11px;color:var(--green);margin-top:5px;}
.metric-change.down{color:var(--accent);}

.monitor-grid{
  display:grid;
  grid-template-columns:1fr 340px;
  gap:16px;
}

/* Live feed */
.live-header{
  display:flex;align-items:center;gap:10px;margin-bottom:4px;
}
.live-badge{
  display:flex;align-items:center;gap:5px;
  background:rgba(255,51,85,0.1);border:1px solid rgba(255,51,85,0.25);
  border-radius:4px;padding:3px 10px;
  font-size:10px;font-weight:700;color:var(--accent);
  font-family:'IBM Plex Mono',monospace;letter-spacing:1px;
}

.feed-list{max-height:480px;overflow-y:auto;}
.feed-list::-webkit-scrollbar{width:3px;}
.feed-list::-webkit-scrollbar-track{background:transparent;}
.feed-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.feed-item{
  display:flex;gap:12px;align-items:flex-start;
  padding:12px 20px;border-bottom:1px solid rgba(42,45,62,0.5);
  cursor:pointer;transition:background 0.15s;
  animation:slideIn 0.35s ease forwards;opacity:0;
}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px);}to{opacity:1;transform:none;}}
.feed-item:hover{background:var(--surface2);}
.feed-item.new-item{animation:newEntry 0.5s ease forwards;}
@keyframes newEntry{
  0%{background:rgba(255,51,85,0.15);opacity:0;transform:translateY(-4px);}
  30%{background:rgba(255,51,85,0.08);}
  100%{background:transparent;opacity:1;transform:none;}
}

.feed-rank{
  width:26px;height:26px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;
  flex-shrink:0;margin-top:1px;
}
.r1{background:rgba(245,158,11,0.15);color:var(--gold);border:1px solid rgba(245,158,11,0.25);}
.r2{background:rgba(148,163,184,0.1);color:#94a3b8;}
.r3{background:rgba(205,100,60,0.1);color:#cd643c;}
.rn{background:var(--surface2);color:var(--muted);}

.feed-thumb{
  width:46px;height:62px;border-radius:6px;
  background:var(--surface2);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;position:relative;overflow:hidden;
}
.feed-thumb-overlay{
  position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,51,85,0.25),rgba(0,212,255,0.15));
}

.feed-info{flex:1;min-width:0;}
.feed-title{
  font-size:12px;font-weight:500;line-height:1.5;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
  margin-bottom:5px;
}
.feed-stats{display:flex;gap:10px;font-size:10px;color:var(--muted);}
.feed-heat{margin-top:5px;display:flex;align-items:center;gap:6px;}
.heat-bar{flex:1;height:2px;background:var(--surface3);border-radius:2px;overflow:hidden;}
.heat-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1s ease;}
.heat-num{font-size:9px;color:var(--accent);font-family:'IBM Plex Mono',monospace;min-width:24px;}

.feed-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.trend-up{color:var(--green);font-size:10px;font-weight:700;}
.trend-dn{color:var(--accent);font-size:10px;font-weight:700;}
.new-tag{
  font-size:9px;background:rgba(255,51,85,0.1);
  border:1px solid rgba(255,51,85,0.25);color:var(--accent);
  border-radius:3px;padding:1px 5px;font-family:'IBM Plex Mono',monospace;
}

/* Alert panel */
.alert-list{display:flex;flex-direction:column;gap:10px;}
.alert-item{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:12px 14px;
  border-left:3px solid var(--accent);
  animation:fadeIn 0.3s ease;
}
.alert-item.blue{border-left-color:var(--accent2);}
.alert-item.gold{border-left-color:var(--gold);}
.alert-item.green{border-left-color:var(--green);}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}} @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.alert-type{font-size:9px;letter-spacing:2px;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-bottom:5px;}
.alert-text{font-size:12px;line-height:1.6;color:var(--text);}
.alert-time{font-size:10px;color:var(--muted);margin-top:4px;font-family:'IBM Plex Mono',monospace;}

/* Monitor controls */
.monitor-ctrl{display:flex;gap:10px;align-items:center;}
.interval-select{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;padding:6px 12px;color:var(--text);
  font-size:12px;outline:none;cursor:pointer;
  font-family:'Noto Sans SC',sans-serif;
}
.btn{
  padding:7px 16px;border-radius:6px;border:1px solid transparent;
  font-size:12px;font-weight:600;cursor:pointer;
  font-family:'Noto Sans SC',sans-serif;transition:all 0.15s;
}
.btn-red{background:var(--accent);color:white;}
.btn-red:hover{opacity:0.85;}
.btn-ghost{background:var(--surface2);border-color:var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--accent2);}
.btn-sm{padding:5px 12px;font-size:11px;}

/* ====== TRACK VIEW ====== */
.track-grid-full{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:12px;margin-bottom:20px;
}
.track-card{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:12px;padding:16px;cursor:pointer;
  transition:all 0.2s;text-align:center;position:relative;
  overflow:hidden;
}
.track-card::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,51,85,0.08),rgba(0,212,255,0.05));
  opacity:0;transition:opacity 0.2s;
}
.track-card:hover::before{opacity:1;}
.track-card:hover{border-color:rgba(255,51,85,0.4);transform:translateY(-2px);}
.track-card.selected{border-color:var(--accent);background:rgba(255,51,85,0.08);}
.track-card.selected::before{opacity:1;}
.track-emoji{font-size:28px;margin-bottom:8px;}
.track-name{font-size:13px;font-weight:700;margin-bottom:4px;}
.track-heat{
  font-size:10px;color:var(--muted);
  font-family:'IBM Plex Mono',monospace;
}
.track-heat-bar{
  height:3px;border-radius:3px;margin-top:8px;
  background:var(--surface2);overflow:hidden;
}
.track-heat-fill{height:100%;border-radius:3px;}
.track-check{
  position:absolute;top:8px;right:8px;
  width:18px;height:18px;border-radius:50%;
  background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-size:10px;color:white;opacity:0;transition:opacity 0.2s;
}
.track-card.selected .track-check{opacity:1;}

.track-compare{
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:20px;margin-top:16px;
}
.compare-bars{display:flex;flex-direction:column;gap:12px;margin-top:12px;}
.compare-row{display:flex;align-items:center;gap:12px;}
.compare-name{font-size:12px;min-width:80px;color:var(--text);}
.compare-bar{flex:1;height:24px;background:var(--surface2);border-radius:4px;overflow:hidden;position:relative;}
.compare-fill{
  height:100%;border-radius:4px;
  display:flex;align-items:center;padding-left:8px;
  font-size:10px;font-weight:700;color:white;
  transition:width 1s ease;
}
.compare-score{font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--muted);min-width:36px;text-align:right;}

/* Multi-select info bar */
.track-selected-bar{
  background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.2);
  border-radius:8px;padding:12px 16px;
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;
}
.track-selected-chips{display:flex;gap:6px;flex-wrap:wrap;}
.selected-chip{
  background:rgba(255,51,85,0.12);border:1px solid rgba(255,51,85,0.25);
  border-radius:4px;padding:3px 10px;font-size:11px;color:var(--accent);
  display:flex;align-items:center;gap:5px;
}
.selected-chip .rm{cursor:pointer;opacity:0.6;}
.selected-chip .rm:hover{opacity:1;}

/* ====== ANALYZE VIEW ====== */
.analyze-layout{
  display:grid;
  grid-template-columns:1fr 380px;
  gap:16px;
  min-height:calc(100vh - 200px);
}

.step-wizard{
  display:flex;gap:0;
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;overflow:hidden;margin-bottom:16px;
}
.wizard-step{
  flex:1;padding:12px 16px;font-size:12px;
  display:flex;align-items:center;gap:8px;
  color:var(--muted);cursor:pointer;
  border-right:1px solid var(--border);transition:all 0.15s;
}
.wizard-step:last-child{border-right:none;}
.wizard-step.active{background:rgba(255,51,85,0.08);color:var(--accent);}
.wizard-step.done{color:var(--green);}
.wizard-num{
  width:20px;height:20px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:700;font-family:'IBM Plex Mono',monospace;
  background:var(--surface2);border:1px solid var(--border);flex-shrink:0;
}
.wizard-step.active .wizard-num{background:var(--accent);color:white;border-color:var(--accent);}
.wizard-step.done .wizard-num{background:var(--green);color:white;border-color:var(--green);}

.source-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.source-card{
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:10px;padding:14px;cursor:pointer;
  transition:all 0.15s;text-align:center;
}
.source-card:hover{border-color:var(--accent2);}
.source-card.active{border-color:var(--accent2);background:rgba(0,212,255,0.06);}
.source-icon{font-size:22px;margin-bottom:6px;}
.source-name{font-size:12px;font-weight:700;}
.source-desc{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.5;}

.guide-box{
  background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.15);
  border-radius:8px;padding:14px 18px;margin-top:12px;
}
.guide-title{font-size:12px;font-weight:700;color:var(--accent2);margin-bottom:10px;}
.guide-step{display:flex;gap:10px;align-items:flex-start;font-size:12px;color:var(--text);line-height:1.6;margin-bottom:7px;}
.guide-num{
  width:18px;height:18px;background:var(--accent2);color:black;
  border-radius:50%;font-size:9px;font-weight:700;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;
}

.paste-area{
  width:100%;min-height:160px;
  background:var(--surface2);border:1.5px dashed var(--border);
  border-radius:8px;padding:14px;color:var(--text);
  font-family:'Noto Sans SC',sans-serif;font-size:13px;
  outline:none;resize:vertical;line-height:1.7;
  transition:border-color 0.2s;
}
.paste-area:focus{border-color:var(--accent2);border-style:solid;}
.paste-area::placeholder{color:var(--muted);}

/* ====== REPORT VIEW ====== */
.report-layout{
  display:grid;grid-template-columns:280px 1fr;gap:16px;
}
.report-sidebar{display:flex;flex-direction:column;gap:10px;}
.report-item{
  background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:12px 14px;cursor:pointer;
  transition:all 0.15s;
}
.report-item:hover{border-color:var(--border);background:var(--surface2);}
.report-item.active{border-color:var(--accent);background:rgba(255,51,85,0.06);}
.report-item-track{font-size:12px;font-weight:700;margin-bottom:3px;}
.report-item-meta{font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;}

.report-main{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.report-main-hd{
  padding:20px 24px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.report-content{padding:24px;}

/* ====== AI SIDEBAR ====== */
.ai-sidebar{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;display:flex;flex-direction:column;
  height:calc(100vh - 200px);overflow:hidden;
}
.ai-hd{
  padding:16px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
.ai-title{font-size:13px;font-weight:700;}
.ai-chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.ai-chat::-webkit-scrollbar{width:3px;}
.ai-chat::-webkit-scrollbar-thumb{background:var(--border);}
.msg-ai .msg-lbl{font-size:9px;letter-spacing:2px;color:var(--accent2);font-family:'IBM Plex Mono',monospace;margin-bottom:5px;}
.msg-ai .msg-bubble{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:2px 10px 10px 10px;padding:12px 14px;
  font-size:12px;line-height:1.8;color:var(--text);
}
.msg-user .msg-lbl{font-size:9px;letter-spacing:2px;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:5px;text-align:right;}
.msg-user .msg-bubble{
  background:var(--surface3);border:1px solid var(--border);
  border-radius:10px 2px 10px 10px;padding:12px 14px;
  font-size:12px;line-height:1.8;color:var(--text);
}
.loading-bubble{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:2px 10px 10px 10px;padding:14px;
  display:flex;gap:5px;align-items:center;
}
.ld{width:6px;height:6px;border-radius:50%;background:var(--accent2);animation:ld 1.2s infinite;}
.ld:nth-child(2){animation-delay:0.2s;}.ld:nth-child(3){animation-delay:0.4s;}
@keyframes ld{0%,80%,100%{transform:scale(0.5);opacity:0.3}40%{transform:scale(1);opacity:1}}

.quick-tags{display:flex;flex-wrap:wrap;gap:5px;padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.qtag{
  padding:4px 10px;border-radius:4px;font-size:10px;
  border:1px solid var(--border);cursor:pointer;transition:all 0.15s;
  color:var(--muted);background:var(--surface2);
}
.qtag:hover{border-color:var(--accent2);color:var(--accent2);}

.chat-bottom{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.chat-input{
  flex:1;background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;padding:9px 12px;color:var(--text);
  font-size:12px;font-family:'Noto Sans SC',sans-serif;
  outline:none;resize:none;height:40px;transition:border-color 0.2s;
}
.chat-input:focus{border-color:var(--accent2);}
.send-btn{
  width:40px;height:40px;background:var(--accent);border:none;
  border-radius:6px;color:white;font-size:14px;cursor:pointer;
  flex-shrink:0;transition:opacity 0.15s;
}
.send-btn:hover{opacity:0.8;}

/* ====== EMPTY / MISC ====== */
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:32px;margin-bottom:12px;opacity:0.4;}
.empty-text{font-size:12px;line-height:1.8;}

.tag{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 10px;border-radius:4px;font-size:10px;
  background:rgba(255,51,85,0.08);color:var(--accent);
  border:1px solid rgba(255,51,85,0.2);
}
.tag.blue{background:rgba(0,212,255,0.08);color:var(--accent2);border-color:rgba(0,212,255,0.2);}
.tag.green{background:rgba(16,185,129,0.08);color:var(--green);border-color:rgba(16,185,129,0.2);}

.divider{height:1px;background:var(--border);margin:16px 0;}

/* Scrollbar global */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

@media(max-width:900px){
  .monitor-grid,.analyze-layout,.report-layout{grid-template-columns:1fr;}
  .monitor-top{grid-template-columns:repeat(2,1fr);}
  .page{padding:16px;}
  header{padding:0 16px;}
  .track-grid-full{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">ğŸ¯</div>
    <div>
      <div class="logo-text">DOUYIN RADAR</div>
    </div>
    <div class="logo-badge">v4.0</div>
  </div>
  <div class="header-center">
    <div class="nav-tab active" onclick="switchView('monitor',this)">ğŸ“¡ å®æ—¶ç›‘æµ‹</div>
    <div class="nav-tab" onclick="switchView('track',this)">ğŸ èµ›é“é€‰å–</div>
    <div class="nav-tab" onclick="switchView('analyze',this)">ğŸ” çˆ†æ¬¾æ‹†è§£</div>
    <div class="nav-tab" onclick="switchView('report',this)">ğŸ‘¤ è´¦å·ç›‘æµ‹</div>
  </div>
  <div class="header-right">
    <div class="status-pill">
      <div class="pulse-dot" id="monStatusDot"></div>
      <span id="monStatusText">ç›‘æµ‹å°±ç»ª</span>
    </div>
    <button onclick="openDataSourceModal()" id="dsStatusBtn"
      style="padding:5px 12px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);border-radius:6px;font-size:10px;color:#818cf8;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
      ğŸ“¡ æ•°æ®æº
    </button>
    <div class="status-pill" style="font-size:10px;" id="clockPill">--:--:--</div>
  </div>
</header>

<!-- ========== VIEW: MONITOR ========== -->
<div id="view-monitor" class="active">
<div class="page">

  <!-- Top metrics -->
  <div class="monitor-top">
    <div class="metric-card red">
      <div class="metric-lbl">ä»Šæ—¥çˆ†æ¬¾æ•°</div>
      <div class="metric-val red" id="mTotal">0</div>
      <div class="metric-change" id="mTotalChange">â†‘ å®æ—¶è¿½è¸ªä¸­</div>
    </div>
    <div class="metric-card blue">
      <div class="metric-lbl">ç›‘æµ‹èµ›é“</div>
      <div class="metric-val blue" id="mTrackCount" style="font-size:20px;padding-top:4px">â€”</div>
      <div class="metric-change">å·²æ¿€æ´»èµ›é“</div>
    </div>
    <div class="metric-card purple">
      <div class="metric-lbl">å¹³å‡çƒ­åº¦æŒ‡æ•°</div>
      <div class="metric-val purple" id="mAvgHeat">â€”</div>
      <div class="metric-change" id="mHeatChange">AI å®æ—¶è®¡ç®—</div>
    </div>
    <div class="metric-card gold">
      <div class="metric-lbl">ä¸‹æ¬¡åˆ·æ–°</div>
      <div class="metric-val gold" id="mCountdown" style="font-size:20px;padding-top:4px">â€”</div>
      <div class="metric-change">è‡ªåŠ¨ç›‘æµ‹å‘¨æœŸ</div>
    </div>
  </div>

  <div class="monitor-grid">
    <!-- Live feed -->
    <div class="card">
      <div class="card-hd">
        <div>
          <div class="live-header">
            <div style="display:flex;align-items:center;gap:8px;"><div class="card-title">ğŸ”¥ çˆ†æ¬¾è§†é¢‘å®æ—¶æ¦œ</div><span id="dataSourceBadge" style="font-size:9px;background:#1a1d2a;color:#9ca3af;border:1px solid #2a2d3e;border-radius:4px;padding:2px 7px;font-family:'IBM Plex Mono',monospace;">æ¼”ç¤ºæ•°æ®</span></div>
            <div class="live-badge"><div class="pulse-dot" style="width:5px;height:5px;animation:pulse 1s infinite;"></div>LIVE</div>
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">å½“å‰èµ›é“ï¼š<span id="liveTrackLabel" style="color:var(--accent2)">æœªé€‰æ‹©</span></div>
        </div>
        <div class="monitor-ctrl">
          <select class="interval-select" id="intervalSelect" onchange="updateInterval()">
            <option value="30">æ¯30ç§’</option>
            <option value="60" selected>æ¯1åˆ†é’Ÿ</option>
            <option value="300">æ¯5åˆ†é’Ÿ</option>
            <option value="600">æ¯10åˆ†é’Ÿ</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="manualRefresh()">â†» åˆ·æ–°</button>
          <button class="btn btn-red btn-sm" id="monToggleBtn" onclick="toggleMonitor()">â–¶ å¼€å§‹ç›‘æµ‹</button>
        </div>
      </div>

      <!-- Filter bar -->
      <div style="display:flex;gap:6px;padding:12px 20px;border-bottom:1px solid var(--border);overflow-x:auto;">
        <button class="btn btn-red btn-sm" onclick="setFeedFilter(this,'all')" id="ff-all">å…¨éƒ¨</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'new')" id="ff-new">ğŸ†• æ–°è¿›æ¦œ</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'rising')" id="ff-rising">ğŸš€ æ€¥é€Ÿä¸Šå‡</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'hot')" id="ff-hot">ğŸ”¥ æŒç»­çˆ†æ¬¾</button>
        <button class="btn btn-ghost btn-sm" onclick="setFeedFilter(this,'ai')" id="ff-ai">âœ¨ AIç²¾é€‰</button>
      </div>

      <div class="feed-list" id="feedList">
        <div class="empty">
          <div class="empty-icon">ğŸ“¡</div>
          <div class="empty-text">è¯·å…ˆåœ¨ã€Œèµ›é“é€‰å–ã€ä¸­<br>é€‰æ‹©ä½ è¦ç›‘æµ‹çš„èµ›é“<br>ç„¶åç‚¹å‡»ã€Œå¼€å§‹ç›‘æµ‹ã€</div>
        </div>
      </div>
    </div>

    <!-- Right: alerts + stats -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <!-- Alert panel -->
      <div class="card">
        <div class="card-hd">
          <div class="card-title">âš¡ å®æ—¶é¢„è­¦</div>
          <span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;" id="alertCount">0 æ¡</span>
        </div>
        <div class="card-body" style="padding:12px;">
          <div class="alert-list" id="alertList">
            <div class="empty" style="padding:24px;">
              <div class="empty-icon" style="font-size:24px;">ğŸ””</div>
              <div class="empty-text">æš‚æ— é¢„è­¦</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trend mini chart -->
      <div class="card">
        <div class="card-hd"><div class="card-title">ğŸ“ˆ çƒ­åº¦è¶‹åŠ¿ï¼ˆä»Šæ—¥ï¼‰</div></div>
        <div class="card-body">
          <canvas id="trendChart" height="100" style="width:100%;"></canvas>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <span style="font-size:10px;color:var(--muted)">00:00</span>
            <span style="font-size:10px;color:var(--muted)">12:00</span>
            <span style="font-size:10px;color:var(--muted)">ç°åœ¨</span>
          </div>
        </div>
      </div>

      <!-- Track heat ranking -->
      <div class="card">
        <div class="card-hd"><div class="card-title">ğŸ† èµ›é“çƒ­åº¦æ’è¡Œ</div></div>
        <div class="card-body" id="trackHeatRank">
          <div class="empty" style="padding:20px;"><div class="empty-text">é€‰æ‹©èµ›é“åæ˜¾ç¤º</div></div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- ========== VIEW: TRACK ========== -->
<div id="view-track">
<div class="page">

  <div class="section-hd">
    <div>
      <div class="section-title">ğŸ èµ›é“é€‰å–ä¸­å¿ƒ</div>
      <div class="section-sub">å¯å¤šé€‰èµ›é“åŒæ—¶ç›‘æµ‹ï¼Œæ”¯æŒè‡ªå®šä¹‰èµ›é“å’Œæ¨ªå‘å¯¹æ¯”</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost" onclick="clearAllTracks()">æ¸…ç©ºé€‰æ‹©</button>
      <button class="btn btn-red" onclick="confirmTracks()">âœ“ ç¡®è®¤é€‰å–å¹¶å¼€å§‹ç›‘æµ‹</button>
    </div>
  </div>

  <!-- Selected bar -->
  <div class="track-selected-bar" id="selectedBar" style="display:none;">
    <div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">å·²é€‰èµ›é“ï¼ˆæœ€å¤š5ä¸ªï¼‰</div>
      <div class="track-selected-chips" id="selectedChips"></div>
    </div>
    <button class="btn btn-red btn-sm" onclick="confirmTracks()">å¼€å§‹ç›‘æµ‹ â†’</button>
  </div>

  <div class="section-label">çƒ­é—¨èµ›é“ Â· ç‚¹å‡»é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰</div>
  <div class="track-grid-full" id="trackGrid"></div>

  <!-- Custom track -->
  <div class="section-label" style="margin-top:8px;">è‡ªå®šä¹‰èµ›é“</div>
  <div style="display:flex;gap:10px;margin-bottom:24px;">
    <input type="text" id="customTrackInput" placeholder="è¾“å…¥èµ›é“åç§°ï¼Œå¦‚ï¼šèŒåœºå¹²è´§ã€æ‰‹å·¥DIYã€å›½é£å¤é£..." style="flex:1;max-width:340px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 14px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;outline:none;" />
    <button class="btn btn-ghost" onclick="addCustomTrack()">+ æ·»åŠ è‡ªå®šä¹‰</button>
  </div>

  <!-- Compare panel -->
  <div class="track-compare" id="comparePanel" style="display:none;">
    <div class="section-label">èµ›é“çƒ­åº¦å¯¹æ¯”</div>
    <div class="compare-bars" id="compareBars"></div>
  </div>

</div>
</div>

<!-- ========== VIEW: ANALYZE ========== -->
<div id="view-analyze">
<div class="page">
<div class="analyze-layout">

  <div>
    <div class="section-hd" style="margin-bottom:12px;">
      <div>
        <div class="section-title">ğŸ” çˆ†æ¬¾è§†é¢‘æ‹†è§£ Â· ä¸€é”®å¤åˆ»</div>
        <div class="section-sub">ç²˜è´´æŠ–éŸ³çˆ†æ¬¾è§†é¢‘é“¾æ¥ï¼ŒAIæ·±åº¦æ‹†è§£ç»“æ„ï¼Œé€‰æ‹©ä½ çš„äº§å“ä¸€é”®ç”Ÿæˆæ–°è„šæœ¬</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="card-hd"><div class="card-title">ğŸ“ ç¬¬ä¸€æ­¥ï¼šç²˜è´´çˆ†æ¬¾è§†é¢‘é“¾æ¥</div></div>
      <div class="card-body">
        <div style="display:flex;gap:10px;align-items:center;">
          <input type="text" id="videoUrlInput" placeholder="ç²˜è´´æŠ–éŸ³è§†é¢‘é“¾æ¥ https://www.douyin.com/video/... æˆ–ç›´æ¥è¾“å…¥è§†é¢‘æ ‡é¢˜"
            style="flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:11px 14px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;"
            onfocus="this.style.borderColor='var(--accent2)'" onblur="this.style.borderColor='var(--border)'"
            onkeydown="if(event.key==='Enter') analyzeVideoUrl()"
          />
          <button class="btn btn-red" onclick="analyzeVideoUrl()" style="white-space:nowrap;padding:11px 20px;">ğŸš€ å¼€å§‹æ‹†è§£</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span style="font-size:10px;color:var(--muted);">å¿«é€Ÿæµ‹è¯•ï¼š</span>
          <span class="qtag" onclick="document.getElementById('videoUrlInput').value='https://www.douyin.com/video/7421025056555885884';analyzeVideoUrl()">ç¤ºä¾‹ç¾å¦†è§†é¢‘</span>
          <span class="qtag" onclick="document.getElementById('videoUrlInput').value='æ²¡æœ‰é“¾æ¥ï¼Œæˆ‘æ¥æè¿°ï¼šä¸€ä¸ªåšé¥­è§†é¢‘ï¼Œæ ‡é¢˜æ˜¯ã€Œå©†å©†åšäº†30å¹´çš„çº¢çƒ§è‚‰ç§˜æ–¹ã€ï¼Œç‚¹èµ50ä¸‡';analyzeVideoUrl()">æ²¡æœ‰é“¾æ¥æ‰‹åŠ¨æè¿°</span>
        </div>
      </div>
    </div>

    <div id="az-result" style="display:none;">
      <div class="card" style="margin-bottom:14px;" id="videoInfoCard"></div>
      <div class="card" style="margin-bottom:14px;" id="structureCard"></div>
      <div class="card" id="replicateCard">
        <div class="card-hd"><div class="card-title">âš¡ ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä½ çš„äº§å“ï¼Œä¸€é”®å¤åˆ»</div></div>
        <div class="card-body">
          <div style="margin-bottom:12px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-family:'IBM Plex Mono',monospace;">é€‰æ‹©äº§å“ç±»å‹</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'ç¾é£Ÿ/é¤é¥®')">ğŸœ ç¾é£Ÿ/é¤é¥®</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'ç¾å¦†æŠ¤è‚¤')">ğŸ’„ ç¾å¦†æŠ¤è‚¤</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'æœè£…ç©¿æ­')">ğŸ‘— æœè£…ç©¿æ­</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'æ•°ç å®¶ç”µ')">ğŸ“± æ•°ç å®¶ç”µ</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'å®¶å±…ç”Ÿæ´»')">ğŸ  å®¶å±…ç”Ÿæ´»</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'å¥åº·å…»ç”Ÿ')">ğŸ’ª å¥åº·å…»ç”Ÿ</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'æ¯å©´äº²å­')">ğŸ‘¶ æ¯å©´äº²å­</button>
              <button class="btn btn-ghost btn-sm product-type-btn" onclick="selectProductType(this,'æ±½è½¦')">ğŸš— æ±½è½¦</button>
            </div>
          </div>
          <div style="margin-bottom:14px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">å¡«å†™ä½ çš„å…·ä½“äº§å“ï¼ˆAIä¼šå…¨ç½‘æœç´¢ä¹°ç‚¹ï¼‰</div>
            <input type="text" id="myProductInput" placeholder="ä¾‹å¦‚ï¼šXXå“ç‰Œé˜²æ™’éœœã€è‡ªå®¶å†œåœºè‰è“ã€æŸæ¬¾æ— çº¿è€³æœº..."
              style="width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-size:13px;outline:none;font-family:'Noto Sans SC',sans-serif;box-sizing:border-box;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--accent2)'" onblur="this.style.borderColor='var(--border)'"
            />
          </div>
          <button class="btn btn-red" onclick="replicateWithProduct()" style="width:100%;padding:12px;font-size:13px;">
            âœ¨ å…¨ç½‘æœç´¢äº§å“ä¹°ç‚¹ Â· æŒ‰çˆ†æ¬¾ç»“æ„ç”Ÿæˆæ–°è„šæœ¬
          </button>
        </div>
      </div>
      <div id="newScriptCard" style="display:none;margin-top:14px;"></div>
    </div>
  </div>

  <div class="ai-sidebar">
    <div class="ai-hd">
      <div>
        <div class="ai-title">ğŸ¤– AI åˆ†æå¸ˆ</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px;">éšæ—¶è¿½é—® Â· æ·±åº¦æ‹†è§£</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="clearChat()">æ¸…ç©º</button>
    </div>
    <div class="ai-chat" id="aiChat">
      <div class="empty">
        <div class="empty-icon">ğŸ’¬</div>
        <div class="empty-text">ç²˜è´´çˆ†æ¬¾è§†é¢‘é“¾æ¥<br>AIè‡ªåŠ¨å¼€å§‹æ‹†è§£</div>
      </div>
    </div>
    <div class="quick-tags">
      <span class="qtag" onclick="quickAsk('è¿™ä¸ªè§†é¢‘ä¸ºä»€ä¹ˆçˆ†ï¼Ÿæ ¸å¿ƒåŸå› æ˜¯ä»€ä¹ˆ')">çˆ†ç«åŸå› </span>
      <span class="qtag" onclick="quickAsk('è¿™ä¸ªè§†é¢‘çš„å¼€åœºé’©å­ç”¨çš„ä»€ä¹ˆæŠ€å·§ï¼Ÿ')">å¼€åœºæŠ€å·§</span>
      <span class="qtag" onclick="quickAsk('å¸®æˆ‘å†™3ä¸ªç±»ä¼¼çš„çˆ†æ¬¾æ ‡é¢˜')">çˆ†æ¬¾æ ‡é¢˜</span>
      <span class="qtag" onclick="quickAsk('è¿™ä¸ªç»“æ„é€‚åˆå“ªäº›èµ›é“å¤ç”¨ï¼Ÿ')">èµ›é“å¤ç”¨</span>
      <span class="qtag" onclick="quickAsk('è¿™ä¸ªè§†é¢‘çš„æƒ…ç»ªä»·å€¼ç‚¹åœ¨å“ªé‡Œï¼Ÿ')">æƒ…ç»ªä»·å€¼</span>
      <span class="qtag" onclick="quickAsk('ç»™æˆ‘å®Œæ•´çš„æ‹æ‘„è„šæœ¬ï¼Œåˆ†é•œåˆ°ç§’')">å®Œæ•´è„šæœ¬</span>
    </div>
    <div class="chat-bottom">
      <textarea class="chat-input" id="chatInput" placeholder="é—®ä»»ä½•é—®é¢˜..." onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" onclick="sendMsg()">â¤</button>
    </div>
  </div>

</div>
</div>
</div>

<!-- ========== VIEW: REPORT ========== -->
<div id="view-report">
<div class="page">
  <div class="section-hd" style="margin-bottom:16px;">
    <div>
      <div class="section-title">ğŸ‘¤ è´¦å·ç›‘æµ‹ä¸­å¿ƒ</div>
      <div class="section-sub">æ·»åŠ ç«äº‰å¯¹æ‰‹æˆ–æ ‡æ†è´¦å·ï¼Œå®æ—¶ç›‘æµ‹å…¶çˆ†æ¬¾åŠ¨æ€ï¼Œä¸€æ—¦å‡ºç°çˆ†æ¬¾ç«‹å³é¢„è­¦</div>
    </div>
    <button class="btn btn-red" onclick="openAddAccountModal()">+ æ·»åŠ è´¦å·</button>
  </div>

  <!-- è´¦å·åˆ—è¡¨ -->
  <div style="display:grid;grid-template-columns:300px 1fr;gap:16px;">

    <!-- å·¦ä¾§è´¦å·åˆ—è¡¨ -->
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--muted);margin-bottom:4px;">å·²ç›‘æµ‹è´¦å·</div>
      <div id="accountList">
        <div class="empty" style="padding:40px 0;">
          <div class="empty-icon">ğŸ‘¤</div>
          <div class="empty-text">è¿˜æ²¡æœ‰ç›‘æµ‹è´¦å·<br>ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ è´¦å·ã€</div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§è´¦å·è¯¦æƒ… + çˆ†æ¬¾åŠ¨æ€ -->
    <div id="accountDetail">
      <div class="empty" style="padding:80px 0;">
        <div class="empty-icon">ğŸ“Š</div>
        <div class="empty-text">é€‰æ‹©å·¦ä¾§è´¦å·<br>æŸ¥çœ‹å®æ—¶ç›‘æµ‹æ•°æ®</div>
      </div>
    </div>

  </div>
</div>
</div>

<!-- æ·»åŠ è´¦å·å¼¹çª— -->
<div id="addAccountModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:28px;width:92%;max-width:480px;box-shadow:0 24px 60px rgba(0,0,0,0.5);">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div style="font-size:15px;font-weight:700;">+ æ·»åŠ ç›‘æµ‹è´¦å·</div>
      <button onclick="document.getElementById('addAccountModal').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;">âœ•</button>
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-family:'IBM Plex Mono',monospace;">æŠ–éŸ³å·ï¼ˆunique_idï¼‰</div>
    <input id="addAccountInput" type="text" placeholder="è¾“å…¥æŠ–éŸ³å·ï¼Œå¦‚ï¼šdouguo_appã€Li Ziqi ç­‰"
      style="width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:11px 14px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:13px;outline:none;box-sizing:border-box;margin-bottom:8px;transition:border-color 0.2s;"
      onfocus="this.style.borderColor='var(--accent2)'" onblur="this.style.borderColor='var(--border)'"
      onkeydown="if(event.key==='Enter') confirmAddAccount()"
    />
    <div style="font-size:10px;color:var(--muted);margin-bottom:16px;line-height:1.7;">
      ğŸ’¡ åœ¨æŠ–éŸ³ä¸»é¡µ â†’ ç‚¹åˆ†äº« â†’ å¤åˆ¶é“¾æ¥ï¼Œé“¾æ¥ä¸­çš„ @ åé¢å°±æ˜¯æŠ–éŸ³å·
    </div>
    <div id="addAccountError" style="display:none;color:var(--accent);font-size:11px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:10px;">
      <button onclick="confirmAddAccount()" class="btn btn-red" style="flex:1;padding:12px;">ğŸ” æŸ¥è¯¢å¹¶æ·»åŠ </button>
      <button onclick="document.getElementById('addAccountModal').style.display='none'" class="btn btn-ghost" style="padding:12px 16px;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

</div>
</div>
</div>

<script>
// ============ STATE ============
let selectedTracks = [];
let monitorInterval = null;
let monitorRunning = false;
let monitorCountdown = 60;
let countdownTimer = null;
let feedFilter = 'all';
let currentSource = 'feigua';
let chatHistory = [];
let analysisResult = '';
let pastedData = '';
let savedReports = [];
let feedData = [];
let alertCount = 0;
let trendData = [];

const TRACKS = [
  {name:'ç¾é£Ÿ',emoji:'ğŸœ',heat:94,color:'#ff3355'},
  {name:'æ—¶å°šç©¿æ­',emoji:'ğŸ‘—',heat:88,color:'#a855f7'},
  {name:'æç¬‘æ®µå­',emoji:'ğŸ˜‚',heat:96,color:'#f59e0b'},
  {name:'æƒ…æ„Ÿè¯­å½•',emoji:'ğŸ’¬',heat:85,color:'#ec4899'},
  {name:'å¥èº«è¿åŠ¨',emoji:'ğŸ’ª',heat:79,color:'#10b981'},
  {name:'çŸ¥è¯†ç§‘æ™®',emoji:'ğŸ”¬',heat:82,color:'#00d4ff'},
  {name:'æ—…æ¸¸æ‰“å¡',emoji:'âœˆï¸',heat:87,color:'#f97316'},
  {name:'æ¯å©´è‚²å„¿',emoji:'ğŸ‘¶',heat:76,color:'#fbbf24'},
  {name:'æ¸¸æˆç”µç«',emoji:'ğŸ®',heat:91,color:'#7c3aed'},
  {name:'è´¢ç»å•†ä¸š',emoji:'ğŸ“ˆ',heat:83,color:'#0ea5e9'},
  {name:'å® ç‰©èŒå® ',emoji:'ğŸ±',heat:90,color:'#fb923c'},
  {name:'ç¾å¦†æŠ¤è‚¤',emoji:'ğŸ’„',heat:86,color:'#f472b6'},
  {name:'å®¶å±…ç”Ÿæ´»',emoji:'ğŸ ',heat:73,color:'#84cc16'},
  {name:'èŒåœºå¹²è´§',emoji:'ğŸ’¼',heat:81,color:'#06b6d4'},
  {name:'æ±½è½¦',emoji:'ğŸš—',heat:75,color:'#64748b'},
  {name:'æ‘„å½±',emoji:'ğŸ“·',heat:71,color:'#8b5cf6'},
];

const VIDEO_TEMPLATES = {
  'ç¾é£Ÿ':['è¿™é“èœè®©å…¨å®¶äººéƒ½çˆ±ä¸Šæˆ‘ï¼10åˆ†é’Ÿæå®š','ç§˜åˆ¶çº¢çƒ§è‚‰ï¼Œå¤–å©†æ•™äº†æˆ‘20å¹´ç»ˆäºå­¦ä¼š','æ¢åº—ï½œè¿™å®¶è‹è‡é¦†å­æ’é˜Ÿ2å°æ—¶ï¼Œå€¼ï¼','å‡è„‚æœŸä¹Ÿèƒ½åƒçˆ½ï¼ä½å¡æ»¡è¶³æ„Ÿæ‹‰æ»¡ä¾¿å½“','å¤åˆ»ç½‘çº¢åº—åŒæ¬¾ï¼Œåœ¨å®¶åš9æˆåƒ'],
  'æ—¶å°šç©¿æ­':['150cmæ˜¾é«˜10cmç©¿æ­å…¬å¼ï¼Œæ”¶è—å¤‡ç”¨','300å—ç©¿å‡ºä¸Šä¸‡å—æ•ˆæœï¼ŒçœŸçš„å¯ä»¥','ä»Šå¹´ç§‹å†¬æœ€æµè¡Œé¢œè‰²ï¼Œä½ ç©¿å¯¹äº†å—','èŒåœºç©¿æ­é¿é›·æŒ‡å—ï¼ŒHRéƒ½è¯´è¿™æ ·æ‰£åˆ†','åŒæ¬¾è¡£æœå¥¹ä¸ºä»€ä¹ˆæ¯”ä½ å¥½çœ‹ï¼Ÿç§˜å¯†åœ¨è¿™'],
  'æç¬‘æ®µå­':['è¢«è€æ¿å½“ä¼—è¡¨æ‰¬åï¼Œæˆ‘åªæƒ³æ‰¾åœ°ç¼é’»','ç”²æ–¹ï¼šå†æ”¹ä¸€ä¸‹ï¼Ÿæˆ‘ï¼šï¼ˆå†…å¿ƒosï¼‰','å’Œçˆ¶æ¯è§†é¢‘çš„å…¨è¿‡ç¨‹ï¼Œä¸€ç§’ä¸å·®','æœ‹å‹åœˆå±è”½çˆ¶æ¯çš„åæœï¼Œæ²¡æƒ³åˆ°è¿™ä¹ˆä¸¥é‡'],
  'æ¸¸æˆç”µç«':['è¿™ä¸ªæ“ä½œè¿èŒä¸šé€‰æ‰‹éƒ½è¯´ç»äº†ï¼','ç‹è€…ä¸Šåˆ†å¿…å­¦çš„é‡åŒºæ§åˆ¶æ—¶æœº','ç»åœ°æ±‚ç”Ÿï¼šèœé¸Ÿåˆ°é£å‡çš„å®Œæ•´è·¯çº¿','è¿™æ¬¾æ–°æ¸¸æˆè®©æˆ‘ç†¬å¤œåˆ°4ç‚¹ï¼Œå¤ªä¸Šå¤´'],
  'çŸ¥è¯†ç§‘æ™®':['ä½ ä»¥ä¸ºä½ æ‡‚å‘¼å¸ï¼Ÿ95%çš„äººå…¶å®ä¸ä¼š','å®‡å®™è†¨èƒ€æ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ3åˆ†é’Ÿçœ‹æ‡‚','ä¸ºä»€ä¹ˆçŒ«æ€»ç›¯ç€ç©ºæ°”å‘å‘†ï¼ŸçœŸç›¸æƒŠäºº','è¿™ä¸ªæ•°å­¦é¢˜éš¾å€’äº†80%çš„å¤§å­¦ç”Ÿ'],
  default:['è¿™ä¸ªå†…å®¹è®©æ‰€æœ‰äººéƒ½åœä¸‹æ¥çœ‹å®Œäº†','æ²¡æƒ³åˆ°è¿™ä¸ªæ–¹æ³•è¿™ä¹ˆæœ‰æ•ˆï¼Œè¯•äº†éƒ½è¯´å¥½','åšäº†3å¹´æ€»ç»“å‡ºæ¥çš„å¹²è´§ï¼Œå…è´¹åˆ†äº«','çœ‹äº†è¿™ä¸ªä¹‹åï¼Œæˆ‘æ”¹å˜äº†å¾ˆå¤šè§‚å¿µ','ä¸ºä»€ä¹ˆè¿™ä¸ªèµ›é“è§†é¢‘è¶Šæ¥è¶Šå¤šäº†'],
};

const EMOJIS = ['ğŸœ','ğŸ¬','ğŸ’¡','ğŸ”¥','â­','ğŸ¯','âœ¨','ğŸª','ğŸŒŸ','ğŸ’«','ğŸ†','ğŸŠ','ğŸ’','ğŸš€','ğŸŒˆ'];

const SOURCE_GUIDES = {
  feigua:{name:'é£ç“œæ•°æ®',steps:['æ‰“å¼€ feigua.cnï¼Œæ³¨å†Œå…è´¹è´¦å·','ç‚¹å‡»é¡¶éƒ¨ã€Œè§†é¢‘ã€â†’ã€Œçƒ­é—¨è§†é¢‘æ¦œã€','åœ¨å³ä¾§é€‰æ‹©åˆ†ç±»ï¼Œæ‰¾åˆ°ä½ çš„èµ›é“','å…¨é€‰é¡µé¢ä¸Šçš„è§†é¢‘æ ‡é¢˜å’Œæ•°æ®ï¼Œå¤åˆ¶','å›åˆ°è¿™é‡Œç²˜è´´å³å¯ âœ…']},
  chanmama:{name:'è‰å¦ˆå¦ˆ',steps:['æ‰“å¼€ chanmama.comï¼Œæ³¨å†Œè´¦å·','è¿›å…¥ã€Œå†…å®¹åˆ†æã€â†’ã€Œè§†é¢‘æ’è¡Œæ¦œã€','é€‰æ‹©ã€ŒæŠ–éŸ³ã€å¹³å° + ä½ çš„èµ›é“åˆ†ç±»','æ¡†é€‰çƒ­é—¨è§†é¢‘åŒºåŸŸï¼Œå¤åˆ¶æ–‡å­—','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  huitun:{name:'ç°è±šæ•°æ®',steps:['æ‰“å¼€ huitun.comï¼Œæ³¨å†Œè´¦å·','å·¦ä¾§èœå•æ‰¾ã€Œè§†é¢‘çƒ­æ¦œã€','æŒ‰åˆ†ç±»ç­›é€‰åˆ°ä½ çš„èµ›é“','å¤åˆ¶çƒ­é—¨è§†é¢‘åˆ—è¡¨','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  official:{name:'å·¨é‡ç®—æ•°ï¼ˆå…è´¹ï¼‰',steps:['æ‰“å¼€ trendinsight.bytedance.comï¼ˆå®Œå…¨å…è´¹ï¼‰','ç‚¹å‡»ã€Œçƒ­ç‚¹å®ã€æˆ–ã€Œå†…å®¹çƒ­æ¦œã€','é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„èµ›é“è¯é¢˜','å¤åˆ¶çƒ­é—¨å†…å®¹çš„æ ‡é¢˜å’Œæ•°æ®','ç²˜è´´åˆ°ä¸‹ä¸€æ­¥ âœ…']},
  manual:{name:'æ‰‹åŠ¨æ•´ç†',steps:['æ‰“å¼€æŠ–éŸ³Appï¼Œæœç´¢ä½ çš„èµ›é“å…³é”®è¯','æŒ‰ã€Œæœ€å¤šç‚¹èµã€æ’åºæŸ¥çœ‹çƒ­é—¨è§†é¢‘','è®°ä¸‹ä½ è§‰å¾—çˆ†çš„è§†é¢‘æ ‡é¢˜ã€å¤§æ¦‚ç‚¹èµæ•°','åœ¨ä¸‹ä¸€æ­¥æ‰‹åŠ¨è¾“å…¥è¿™äº›ä¿¡æ¯','å“ªæ€•åªæœ‰æ ‡é¢˜ï¼ŒAIä¹Ÿèƒ½åˆ†æ âœ…']},
  other:{name:'å…¶ä»–æ¥æº',steps:['ä»»ä½•ä½ çœ‹åˆ°çš„æŠ–éŸ³çƒ­é—¨å†…å®¹éƒ½å¯ä»¥','æ¯”å¦‚ç¾¤é‡Œåˆ†äº«çš„çˆ†æ¬¾ã€å¾®åšçƒ­æœæåˆ°çš„','æˆ–è€…æˆªå›¾åæŠŠæ–‡å­—æ‰‹åŠ¨æ‰“å‡ºæ¥','æ ¼å¼ä¸é™ï¼Œéšæ„ç²˜è´´','AIä¼šè‡ªåŠ¨ç†è§£å†…å®¹ âœ…']},
};

// ============ NAVIGATION ============
function switchView(name, el) {
  ['monitor','track','analyze','report'].forEach(v => document.getElementById('view-'+v).classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if(el) el.classList.add('active');
}

// ============ TRACK SELECTION ============
function renderTrackGrid() {
  const grid = document.getElementById('trackGrid');
  grid.innerHTML = TRACKS.map(t => `
    <div class="track-card" data-name="${t.name}" onclick="toggleTrack('${t.name}',this)">
      <div class="track-check">âœ“</div>
      <div class="track-emoji">${t.emoji}</div>
      <div class="track-name">${t.name}</div>
      <div class="track-heat">çƒ­åº¦ ${t.heat}</div>
      <div class="track-heat-bar">
        <div class="track-heat-fill" style="width:${t.heat}%;background:${t.color};"></div>
      </div>
    </div>
  `).join('');
}

function toggleTrack(name, el) {
  if(selectedTracks.includes(name)) {
    selectedTracks = selectedTracks.filter(t => t !== name);
    el.classList.remove('selected');
  } else {
    if(selectedTracks.length >= 5) { showToast('æœ€å¤šé€‰æ‹©5ä¸ªèµ›é“'); return; }
    selectedTracks.push(name);
    el.classList.add('selected');
  }
  updateSelectedBar();
  updateCompare();
}

function updateSelectedBar() {
  const bar = document.getElementById('selectedBar');
  const chips = document.getElementById('selectedChips');
  if(selectedTracks.length === 0) { bar.style.display='none'; return; }
  bar.style.display='flex';
  chips.innerHTML = selectedTracks.map(t => {
    const info = TRACKS.find(x=>x.name===t)||{emoji:'ğŸ¯'};
    return `<div class="selected-chip">${info.emoji} ${t} <span class="rm" onclick="removeTrack('${t}')">Ã—</span></div>`;
  }).join('');
}

function removeTrack(name) {
  selectedTracks = selectedTracks.filter(t => t !== name);
  document.querySelectorAll('.track-card').forEach(c => {
    if(c.dataset.name === name) c.classList.remove('selected');
  });
  updateSelectedBar();
  updateCompare();
}

function clearAllTracks() {
  selectedTracks = [];
  document.querySelectorAll('.track-card').forEach(c => c.classList.remove('selected'));
  updateSelectedBar();
  updateCompare();
}

function addCustomTrack() {
  const input = document.getElementById('customTrackInput');
  const val = input.value.trim();
  if(!val) return;
  if(TRACKS.find(t=>t.name===val)) { showToast('è¯¥èµ›é“å·²å­˜åœ¨'); return; }
  const heat = Math.floor(65+Math.random()*20);
  const colors = ['#ff3355','#00d4ff','#7c3aed','#f59e0b','#10b981'];
  const color = colors[TRACKS.length % colors.length];
  TRACKS.push({name:val,emoji:'ğŸ¯',heat,color});
  renderTrackGrid();
  // Re-select previously selected
  selectedTracks.forEach(t => {
    document.querySelectorAll('.track-card').forEach(c => {
      if(c.dataset.name === t) c.classList.add('selected');
    });
  });
  input.value='';
}

function confirmTracks() {
  if(selectedTracks.length === 0) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèµ›é“'); return; }
  switchView('monitor', document.querySelectorAll('.nav-tab')[0]);
  updateMonitorUI();
  if(!monitorRunning) startMonitor();
}

function updateCompare() {
  const panel = document.getElementById('comparePanel');
  const bars = document.getElementById('compareBars');
  if(selectedTracks.length < 2) { panel.style.display='none'; return; }
  panel.style.display='block';
  const sorted = [...selectedTracks].map(n => TRACKS.find(t=>t.name===n)||{name:n,heat:70,color:'#888'}).sort((a,b)=>b.heat-a.heat);
  bars.innerHTML = sorted.map(t => `
    <div class="compare-row">
      <div class="compare-name">${t.emoji||'ğŸ¯'} ${t.name}</div>
      <div class="compare-bar">
        <div class="compare-fill" style="width:${t.heat}%;background:${t.color};">${t.heat}</div>
      </div>
      <div class="compare-score">${t.heat}</div>
    </div>
  `).join('');
}

// ============ MONITOR ============
function updateMonitorUI() {
  const trackCount = selectedTracks.length;
  document.getElementById('mTrackCount').textContent = trackCount > 0 ? trackCount+'ä¸ª' : 'â€”';
  document.getElementById('liveTrackLabel').textContent = selectedTracks.join(' Â· ') || 'æœªé€‰æ‹©';
  if(trackCount > 0) renderTrackHeatRank();
}

function renderTrackHeatRank() {
  const el = document.getElementById('trackHeatRank');
  const tracks = selectedTracks.map(n => TRACKS.find(t=>t.name===n)||{name:n,heat:70+Math.random()*20,emoji:'ğŸ¯',color:'#888'});
  tracks.sort((a,b) => b.heat - a.heat);
  el.innerHTML = tracks.map((t,i) => `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);min-width:16px;">${i+1}</span>
      <span style="font-size:14px;">${t.emoji||'ğŸ¯'}</span>
      <span style="flex:1;font-size:12px;font-weight:500;">${t.name}</span>
      <div style="width:80px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;">
        <div style="height:100%;width:${t.heat}%;background:${t.color};border-radius:3px;"></div>
      </div>
      <span style="font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace;min-width:24px;">${Math.round(t.heat)}</span>
    </div>
  `).join('');
}

function toggleMonitor() {
  if(monitorRunning) stopMonitor(); else startMonitor();
}

function startMonitor() {
  if(selectedTracks.length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©èµ›é“ï¼');
    switchView('track', document.querySelectorAll('.nav-tab')[1]);
    return;
  }
  monitorRunning = true;
  document.getElementById('monToggleBtn').textContent = 'â¸ åœæ­¢ç›‘æµ‹';
  document.getElementById('monToggleBtn').className = 'btn btn-ghost btn-sm';
  document.getElementById('monStatusDot').className = 'pulse-dot';
  document.getElementById('monStatusText').textContent = 'ç›‘æµ‹ä¸­';
  refreshFeed(true);
  scheduleNextRefresh();
}

function stopMonitor() {
  monitorRunning = false;
  if(monitorInterval) clearInterval(monitorInterval);
  if(countdownTimer) clearInterval(countdownTimer);
  document.getElementById('monToggleBtn').textContent = 'â–¶ å¼€å§‹ç›‘æµ‹';
  document.getElementById('monToggleBtn').className = 'btn btn-red btn-sm';
  document.getElementById('monStatusDot').className = 'pulse-dot red';
  document.getElementById('monStatusText').textContent = 'å·²æš‚åœ';
  document.getElementById('mCountdown').textContent = 'å·²æš‚åœ';
}

function scheduleNextRefresh() {
  const interval = parseInt(document.getElementById('intervalSelect').value);
  monitorCountdown = interval;
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(() => {
    monitorCountdown--;
    const m = Math.floor(monitorCountdown/60);
    const s = monitorCountdown%60;
    document.getElementById('mCountdown').textContent = m>0 ? `${m}m${s}s` : `${s}s`;
    if(monitorCountdown <= 0) {
      refreshFeed(false);
      monitorCountdown = interval;
    }
  }, 1000);
}

function updateInterval() {
  if(monitorRunning) {
    if(countdownTimer) clearInterval(countdownTimer);
    scheduleNextRefresh();
  }
}

function manualRefresh() {
  refreshFeed(false);
  if(monitorRunning) {
    if(countdownTimer) clearInterval(countdownTimer);
    scheduleNextRefresh();
  }
}

function getVideoTemplates(track) {
  return VIDEO_TEMPLATES[track] || VIDEO_TEMPLATES.default;
}

function generateFeedData() {
  const allVideos = [];
  selectedTracks.forEach(track => {
    const tmpl = getVideoTemplates(track);
    const trackInfo = TRACKS.find(t=>t.name===track)||{emoji:'ğŸ¯',heat:80};
    tmpl.forEach((title, i) => {
      const likes = (Math.random()*200+10).toFixed(1)+'ä¸‡';
      const comments = (Math.random()*5+0.5).toFixed(1)+'ä¸‡';
      const shares = (Math.random()*10+1).toFixed(1)+'ä¸‡';
      const heat = Math.floor(trackInfo.heat - i*4 + (Math.random()*6-3));
      const isNew = Math.random() > 0.7;
      const trend = Math.random() > 0.3 ? '+' : '-';
      const trendVal = Math.floor(Math.random()*15+1);
      allVideos.push({title, likes, comments, shares, heat:Math.min(99,Math.max(50,heat)), isNew, trend, trendVal, track, emoji:EMOJIS[Math.floor(Math.random()*EMOJIS.length)]});
    });
  });
  allVideos.sort((a,b) => b.heat - a.heat);
  return allVideos;
}

async function refreshFeed(isFirst) {
  const tikhubKey = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  const hasCfg = !!(tikhubKey && tikhubKey.length > 10);
  const list = document.getElementById('feedList');

  if (hasCfg) {
    if (list) list.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div style="font-size:30px;animation:spin 0.8s linear infinite;display:inline-block;margin-bottom:12px;">âŸ³</div>
        <div style="font-size:13px;color:#6b7280;font-weight:600;">æ­£åœ¨è·å–çœŸå®æŠ–éŸ³çƒ­æœâ€¦</div>
      </div>`;

    try {
      // ç›´æ¥è·å–çƒ­æœæ¦œï¼ˆæœ€ç¨³å®šçš„æ¥å£ï¼‰
      const hotItems = await fetchHotSearch();

      if (hotItems?.length > 0) {
        const trackList = selectedTracks.length > 0 ? selectedTracks : ['çƒ­æœ'];
        const results = [];

        hotItems.forEach((item, idx) => {
          const word = item.word || item.desc || '';
          if (!word) return;

          // æŒ‰èµ›é“å…³é”®è¯åŒ¹é…ï¼Œç»™æ¯æ¡çƒ­æœæ‰“ä¸Šå¯¹åº”èµ›é“æ ‡ç­¾
          let matchedTrack = trackList[0] || 'çƒ­æœ';
          for (const track of trackList) {
            const kws = TRACK_KEYWORDS[track] || [];
            if (kws.some(k => word.includes(k))) {
              matchedTrack = track;
              break;
            }
          }

          results.push({
            _isHotSearch: true,
            desc: word,
            _hotValue: item.hotValue || item._hotValue || (50 - idx) * 100000,
            _track: matchedTrack,
          });
        });

        feedData = results.map(item => normalizeAweme(item, item._track)).filter(Boolean);
        feedData.sort((a, b) => b.heat - a.heat);
        feedData.slice(0, 3).forEach(v => { v.isNew = true; });
        _dsConnected = true;
        renderFeed(isFirst);
        updateMetrics();
        if (!isFirst) generateAlert();
        drawTrendChart();
        _refreshDsBadges();
        return;
      }
    } catch(e) {
      console.warn('[refreshFeed] fetch failed:', e.message);
    }
    _dsConnected = false;
    showToast('âš ï¸ æ•°æ®è·å–å¤±è´¥ï¼Œåˆ‡æ¢æ¼”ç¤ºæ¨¡å¼');
    _refreshDsBadges();
  }

  feedData = generateFeedData();
  renderFeed(isFirst);
  updateMetrics();
  if(!isFirst) generateAlert();
  drawTrendChart();
}

// ç›´æ¥è·å–çƒ­æœæ¦œ
async function fetchHotSearch() {
  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  if (!key) return null;
  const controller = new AbortController();
  setTimeout(() => controller.abort(), 15000);
  const r = await fetch('/api/tikhub?endpoint=hot_search', {
    signal: controller.signal,
    headers: { 'x-api-key': key }
  });
  if (!r.ok) return null;
  const j = await r.json();
  if (!j?.success || !j.items?.length) return null;
  return j.items.map(item => ({ word: item.word || '', hotValue: item.hotValue || 0 }));
}

function renderFeed(isFirst) {
  const list = document.getElementById('feedList');
  let data = [...feedData];
  if(feedFilter === 'new') data = data.filter(v => v.isNew);
  if(feedFilter === 'rising') data = data.filter(v => v.trend === '+' && v.trendVal > 8);
  if(feedFilter === 'hot') data = data.filter(v => v.heat > 85);
  if(feedFilter === 'ai') data = data.filter(v => v.heat > 80).slice(0,5);

  if(data.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">è¯¥ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— æ•°æ®</div></div>`;
    return;
  }

  list.innerHTML = data.map((v, i) => {
    const rankClass = i===0?'r1':i===1?'r2':i===2?'r3':'rn';
    const isAnimNew = !isFirst && v.isNew;
    return `
    <div class="feed-item ${isAnimNew?'new-item':''}" style="animation-delay:${i*0.04}s" onclick="feedItemClick(${i})">
      <div class="feed-rank ${rankClass}">${i+1}</div>
      <div class="feed-thumb"><div class="feed-thumb-overlay"></div><span style="position:relative;font-size:20px">${v.emoji}</span></div>
      <div class="feed-info">
        <div class="feed-title">${v.title}</div>
        <div class="feed-stats">
          <span>â¤ï¸ ${v.likes}</span>
          <span>ğŸ’¬ ${v.comments}</span>
          <span>â†—ï¸ ${v.shares}</span>
          <span style="color:var(--accent2)">ğŸ“‚ ${v.track}</span>
        </div>
        <div class="feed-heat">
          <div class="heat-bar"><div class="heat-fill" style="width:${v.heat}%"></div></div>
          <span class="heat-num">${v.heat}</span>
        </div>
      </div>
      <div class="feed-right">
        <span class="${v.trend==='+'?'trend-up':'trend-dn'}">${v.trend}${v.trendVal}%</span>
        ${v.isNew?'<span class="new-tag">NEW</span>':''}
      </div>
    </div>`;
  }).join('');
}

function feedItemClick(idx) {
  const v = feedData[idx];
  if(!v) return;
  // çœŸå®æ•°æ®ï¼šç²¾å‡†è·³è½¬åˆ°å•æ¡è§†é¢‘é¡µé¢
  if(v.source === 'real' && v.aweme_id) {
    window.open('https://www.douyin.com/video/' + v.aweme_id, '_blank');
    return;
  }
  // æ¼”ç¤ºæ•°æ®ï¼šè·³è½¬æŠ–éŸ³æœç´¢
  const q = encodeURIComponent((v.title||'').replace(/[ï¼ˆï¼‰ã€ã€‘ï½œâ€¦]/g,' ').trim());
  window.open('https://www.douyin.com/search/' + q + '?type=video', '_blank');
}

function setFeedFilter(btn, filter) {
  document.querySelectorAll('[id^="ff-"]').forEach(b => { b.className='btn btn-ghost btn-sm'; });
  btn.className='btn btn-red btn-sm';
  feedFilter = filter;
  renderFeed(false);
}

function updateMetrics() {
  const total = feedData.length * 17 + Math.floor(Math.random()*50);
  const avgHeat = feedData.length > 0 ? Math.round(feedData.reduce((s,v)=>s+v.heat,0)/feedData.length) : 0;
  document.getElementById('mTotal').textContent = total;
  document.getElementById('mAvgHeat').textContent = avgHeat;
  document.getElementById('mTotalChange').textContent = `â†‘ è¾ƒä¸Šæ¬¡ +${Math.floor(Math.random()*12+3)}`;
  document.getElementById('mHeatChange').textContent = avgHeat > 80 ? 'â†‘ çƒ­åº¦ä¸Šå‡ä¸­' : 'â†’ çƒ­åº¦å¹³ç¨³';
}

function generateAlert() {
  const track = selectedTracks[Math.floor(Math.random()*selectedTracks.length)] || 'ç¾é£Ÿ';
  const trackKws = TRACK_KEYWORDS[track] || [track];
  const kw = trackKws[0];
  const douyinSearchUrl = 'https://www.douyin.com/search/' + encodeURIComponent(kw) + '?type=video&sort_type=1';

  // å¦‚æœæœ‰çœŸå®æ•°æ®ï¼Œä» feedData ä¸­å–æ¦œé¦–è§†é¢‘
  const topVideo = feedData.find(v => v.source === 'real');
  const topVideoUrl = topVideo?.url || douyinSearchUrl;
  const topVideoAuthorUrl = topVideo?.authorUrl || ('https://www.douyin.com/search/' + encodeURIComponent(kw) + '?type=user');

  // æ–°è¿›æ¦œè§†é¢‘ - ä» feedData ä¸­éšæœºå–æ–°è§†é¢‘çš„è´¦å·
  const newEntries = feedData.filter(v => v.isNew && v.source === 'real');
  const newEntryCount = Math.floor(Math.random()*3+1);
  const newEntryAuthorUrl = newEntries[0]?.authorUrl || ('https://www.douyin.com/search/' + encodeURIComponent(kw) + '?type=user');

  const types = [
    {
      type:'SPIKE', cls:'',
      text:`ã€Œ${track}ã€èµ›é“æ€¥é€Ÿä¸Šå‡ï¼Œçƒ­åº¦ +${Math.floor(Math.random()*20+10)}%`,
      link: douyinSearchUrl,
      linkText: 'æŸ¥çœ‹ç›¸å…³è§†é¢‘ â†’'
    },
    {
      type:'NEW TREND', cls:'blue',
      text:`æ–°å…´å…³é”®è¯ã€Œ${['è¿”ç’å½’çœŸ','æç®€ä¸»ä¹‰','ç¡¬æ ¸å¹²è´§','æ²‰æµ¸å¼'][Math.floor(Math.random()*4)]}ã€ä½¿ç”¨é‡æš´å¢`,
      link: douyinSearchUrl,
      linkText: 'æœç´¢è¯¥è¯é¢˜ â†’'
    },
    {
      type:'TOP VIDEO', cls:'gold',
      text:`æ¦œé¦–è§†é¢‘ç´¯è®¡ ${(Math.random()*50+20).toFixed(1)} ä¸‡ç‚¹èµï¼Œå»ºè®®ç«‹å³åˆ†æ`,
      link: topVideoUrl,
      linkText: 'æŸ¥çœ‹è¯¥è§†é¢‘ â†’'
    },
    {
      type:'NEW ENTRY', cls:'green',
      text:`ã€Œ${track}ã€èµ›é“æ–°è¿›æ¦œ ${newEntryCount} ä¸ªè§†é¢‘ï¼Œå‡æ¥è‡ªç´ äººè´¦å·`,
      link: newEntryAuthorUrl,
      linkText: 'æŸ¥çœ‹ç´ äººè´¦å· â†’',
      extraLinks: newEntries.slice(0, newEntryCount).map(v => ({url: v.authorUrl || topVideoAuthorUrl, label: '@' + (v.author || 'ç´ äººè´¦å·')}))
    },
  ];
  const alert = types[Math.floor(Math.random()*types.length)];
  const alertList = document.getElementById('alertList');
  if(alertList.querySelector('.empty')) alertList.innerHTML = '';
  const now = new Date().toLocaleTimeString('zh-CN');
  const div = document.createElement('div');
  div.className = `alert-item ${alert.cls}`;
  div.style.cursor = 'pointer';

  // é¢å¤–è´¦å·é“¾æ¥ï¼ˆNEW ENTRY ç±»å‹ä¸“ç”¨ï¼‰
  const extraLinksHtml = (alert.extraLinks && alert.extraLinks.length > 0)
    ? `<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:5px;">${alert.extraLinks.map(l => `<a href="${l.url}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;color:var(--accent2);text-decoration:none;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:4px;padding:2px 8px;">${l.label}</a>`).join('')}</div>`
    : '';

  div.innerHTML = `
    <div class="alert-type">${alert.type}</div>
    <div class="alert-text">${alert.text}</div>
    ${extraLinksHtml}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px;">
      <div class="alert-time">${now}</div>
      <a href="${alert.link}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;color:var(--accent2);text-decoration:none;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:4px;padding:2px 8px;">${alert.linkText}</a>
    </div>`;
  div.onclick = () => window.open(alert.link, '_blank');
  alertList.insertBefore(div, alertList.firstChild);
  while(alertList.children.length > 5) alertList.removeChild(alertList.lastChild);
  alertCount++;
  document.getElementById('alertCount').textContent = alertCount + ' æ¡';
}

// ============ TREND CHART ============
function drawTrendChart() {
  const canvas = document.getElementById('trendChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = 200;
  ctx.scale(2,2);
  const w = canvas.offsetWidth/2, h = 100;

  // Generate trend data points
  if(trendData.length === 0) {
    for(let i=0;i<24;i++) trendData.push(40+Math.random()*40);
  }
  trendData.push(50+Math.random()*45);
  if(trendData.length > 24) trendData.shift();

  ctx.clearRect(0,0,w,h);

  // Grid
  ctx.strokeStyle = 'rgba(42,45,62,0.6)';
  ctx.lineWidth = 0.5;
  for(let i=0;i<4;i++) {
    const y = (h-10) * i/3 + 5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }

  // Gradient fill
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'rgba(255,51,85,0.3)');
  grad.addColorStop(1,'rgba(255,51,85,0)');

  const pts = trendData.map((v,i) => ({x:i/(trendData.length-1)*w, y:h-10 - (v/100)*(h-20)}));

  ctx.beginPath();
  ctx.moveTo(pts[0].x, h);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, h);
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) {
    const cp = {x:(pts[i-1].x+pts[i].x)/2, y:(pts[i-1].y+pts[i].y)/2};
    ctx.quadraticCurveTo(pts[i-1].x, pts[i-1].y, cp.x, cp.y);
  }
  ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
  ctx.strokeStyle = 'var(--accent)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Last point dot
  const last = pts[pts.length-1];
  ctx.beginPath();
  ctx.arc(last.x, last.y, 3, 0, Math.PI*2);
  ctx.fillStyle = 'var(--accent)';
  ctx.fill();
}

// ============ ANALYZE ============
function azGoto(step) {
  [1,2,3].forEach(i => {
    document.getElementById(`az-step${i}`).style.display = i===step?'block':'none';
    const ws = document.getElementById(`ws${i}`);
    const wn = document.getElementById(`wn${i}`);
    ws.classList.remove('active','done');
    if(i < step) { ws.classList.add('done'); wn.textContent='âœ“'; }
    else if(i === step) { ws.classList.add('active'); wn.textContent=i; }
    else { wn.textContent=i; }
  });
}

function selectSource(src, el) {
  document.querySelectorAll('.source-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentSource = src;
  const g = SOURCE_GUIDES[src];
  document.getElementById('guideTitle').textContent = `ğŸ“– ${g.name} Â· è·å–æ­¥éª¤`;
  document.getElementById('guideSteps').innerHTML = g.steps.map((s,i) =>
    `<div class="guide-step"><div class="guide-num">${i+1}</div><span>${s}</span></div>`
  ).join('');
}
selectSource('feigua', document.getElementById('src-feigua'));

document.getElementById('pasteArea').addEventListener('input', function() {
  pastedData = this.value;
  document.getElementById('charCount').textContent = this.value.length + ' å­—ç¬¦';
});

async function startAnalysis() {
  const data = document.getElementById('pasteArea').value.trim();
  if(!data) { showToast('è¯·å…ˆç²˜è´´æ•°æ®ï¼'); return; }
  pastedData = data;
  azGoto(3);

  const activeTrack = selectedTracks.length > 0 ? selectedTracks.join('ã€') : 'æœªæŒ‡å®š';
  document.getElementById('rptTrack').textContent = activeTrack;
  document.getElementById('rptSource').textContent = SOURCE_GUIDES[currentSource]?.name || currentSource;

  document.getElementById('reportContent').innerHTML = `
    <div class="card" style="margin-bottom:14px;">
      <div class="card-body" style="display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted);">
        <div class="ld"></div><div class="ld"></div><div class="ld"></div>
        &nbsp;AI æ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...
      </div>
    </div>`;

  const aiChat = document.getElementById('aiChat');
  if(aiChat.querySelector('.empty')) aiChat.innerHTML='';
  addMsg('user', `æˆ‘ä¸Šä¼ äº†ã€Œ${activeTrack}ã€èµ›é“çš„æ•°æ®ï¼Œè¯·å¸®æˆ‘å…¨é¢åˆ†æï¼`);
  const loadEl = addLoadingMsg();

  const prompt = `ä½ æ˜¯é¡¶çº§æŠ–éŸ³çˆ†æ¬¾å†…å®¹åˆ†æå¸ˆã€‚
èµ›é“ï¼š${activeTrack}
æ•°æ®æ¥æºï¼š${SOURCE_GUIDES[currentSource]?.name}
åŸå§‹æ•°æ®ï¼š
${pastedData}

è¯·å®Œæˆä»¥ä¸‹åˆ†æï¼ˆä¸­æ–‡ï¼Œç»“æ„æ¸…æ™°ï¼Œçªå‡ºå¯æ“ä½œå»ºè®®ï¼‰ï¼š
1. **æ•°æ®è¯†åˆ«**ï¼šè¯†åˆ«å‡ºæœ‰æ•ˆè§†é¢‘æ•°é‡ã€ä¸»è¦è¯é¢˜
2. **çˆ†æ¬¾ç‰¹å¾**ï¼šæ€»ç»“è¿™æ‰¹çˆ†æ¬¾è§†é¢‘çš„å…±åŒè§„å¾‹ï¼ˆæ ‡é¢˜ç‰¹å¾ã€å†…å®¹ç±»å‹ã€æƒ…ç»ªä»·å€¼ï¼‰
3. **çƒ­åº¦è¯„åˆ†**ï¼šæ•´ä½“çƒ­åº¦ï¼ˆ0-100ï¼‰ã€äº’åŠ¨ç‡æ°´å¹³ã€ç«äº‰çƒˆåº¦
4. **é€‰é¢˜å»ºè®®**ï¼š3ä¸ªå¯ä»¥ç«‹åˆ»æ‹çš„çˆ†æ¬¾é€‰é¢˜ï¼Œè¶Šå…·ä½“è¶Šå¥½
5. **æ ‡é¢˜å…¬å¼**ï¼šè¿™ä¸ªèµ›é“çˆ†æ¬¾æ ‡é¢˜çš„å†™æ³•è§„å¾‹

400å­—ä»¥å†…ï¼Œé‡ç‚¹çªå‡ºï¼Œé€‚å½“ä½¿ç”¨emojiã€‚`;

  try {
    chatHistory.push({role:'user',content:prompt});
    const _aiKey = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';
    const res = await fetch('/api/tikhub',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-anthropic-key': _aiKey},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:chatHistory})
    });
    const d = await res.json();
    const reply = d.content?.[0]?.text || 'åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';
    chatHistory.push({role:'assistant',content:reply});
    analysisResult = reply;

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble">${reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}</div>`;
    document.getElementById('aiChat').scrollTop = 99999;

    document.getElementById('reportContent').innerHTML = `
      <div class="card" style="margin-bottom:14px;">
        <div class="card-hd">
          <div class="card-title">ğŸ“Š çˆ†æ¬¾åˆ†ææŠ¥å‘Š Â· ${activeTrack}</div>
          <div style="display:flex;gap:6px;">
            <span class="tag">ğŸ“ˆ ${activeTrack}</span>
            <span class="tag blue">AIåˆ†æå®Œæˆ</span>
          </div>
        </div>
        <div class="card-body" style="font-size:13px;line-height:1.8;">
          ${reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}
        </div>
      </div>
      <div class="card">
        <div class="card-hd"><div class="card-title">âš¡ ä¸‹ä¸€æ­¥è¡ŒåŠ¨</div></div>
        <div class="card-body">
          <div style="display:flex;flex-direction:column;gap:10px;font-size:12px;">
            <div style="display:flex;gap:10px;"><span style="font-size:16px;">ğŸ’¬</span><span>åœ¨å³ä¾§è¿½é—®AIï¼Œè·å–æ›´å¤šå…·ä½“å»ºè®®</span></div>
            <div style="display:flex;gap:10px;"><span style="font-size:16px;">ğŸ“‹</span><span>ç‚¹å‡»å³ä¾§ã€Œè„šæœ¬æ¡†æ¶ã€è®©AIå¸®ä½ å†™å®Œæ•´è„šæœ¬</span></div>
            <div style="display:flex;gap:10px;"><span style="font-size:16px;">ğŸ’¾</span><span>ç‚¹å‡»ã€Œä¿å­˜æŠ¥å‘Šã€è®°å½•æœ¬æ¬¡åˆ†æç»“æœ</span></div>
          </div>
        </div>
      </div>`;
  } catch(e) {
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble" style="color:var(--accent)">âš ï¸ APIè¿æ¥å¤±è´¥ã€‚è¯·åœ¨æ”¯æŒAnthropic APIçš„ç¯å¢ƒä¸­è¿è¡Œã€‚</div>`;
    document.getElementById('reportContent').innerHTML = `<div class="card"><div class="card-body" style="color:var(--accent);font-size:13px;">âš ï¸ åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®ã€‚</div></div>`;
  }
}

function saveReport() {
  if(!analysisResult) { showToast('æ²¡æœ‰å¯ä¿å­˜çš„æŠ¥å‘Š'); return; }
  const activeTrack = selectedTracks.join('ã€') || 'æœªæŒ‡å®š';
  const report = {
    id: Date.now(),
    track: activeTrack,
    source: SOURCE_GUIDES[currentSource]?.name,
    time: new Date().toLocaleString('zh-CN'),
    content: analysisResult,
    rawData: pastedData,
  };
  savedReports.unshift(report);
  renderReportList();
  showToast('æŠ¥å‘Šå·²ä¿å­˜ï¼');
}

function renderReportList() {
  const sidebar = document.getElementById('reportSidebar');
  if(savedReports.length === 0) {
    sidebar.innerHTML = `<div class="empty" style="padding:32px 0;"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">æš‚æ— ä¿å­˜çš„æŠ¥å‘Š</div></div>`;
    return;
  }
  sidebar.innerHTML = savedReports.map((r,i) => `
    <div class="report-item ${i===0?'active':''}" onclick="viewReport(${i},this)">
      <div class="report-item-track">ğŸ“Š ${r.track}</div>
      <div class="report-item-meta">${r.source} Â· ${r.time}</div>
    </div>
  `).join('');
  viewReport(0, sidebar.firstElementChild);
}

function viewReport(idx, el) {
  document.querySelectorAll('.report-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  const r = savedReports[idx];
  document.getElementById('reportMain').innerHTML = `
    <div class="report-main-hd">
      <div>
        <div style="font-size:15px;font-weight:700;">ğŸ“Š ${r.track} Â· çˆ†æ¬¾åˆ†ææŠ¥å‘Š</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">${r.source} Â· ${r.time}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="downloadReport(${idx})">â¬‡ ä¸‹è½½</button>
    </div>
    <div class="report-content">
      <div style="font-size:13px;line-height:1.9;">
        ${r.content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}
      </div>
    </div>`;
}

function downloadReport(idx) {
  const r = savedReports[idx];
  const text = `æŠ–éŸ³çˆ†æ¬¾åˆ†ææŠ¥å‘Š\nèµ›é“ï¼š${r.track}\næ•°æ®æ¥æºï¼š${r.source}\nç”Ÿæˆæ—¶é—´ï¼š${r.time}\n\nAIåˆ†æç»“æœï¼š\n${r.content}\n\nåŸå§‹æ•°æ®ï¼š\n${r.rawData}`;
  const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `çˆ†æ¬¾åˆ†æ_${r.track}_${r.time.slice(0,10)}.txt`;
  a.click();
}

function exportReport() { downloadReport(0); }

// ============ AI CHAT ============
function addMsg(role, text) {
  const chat = document.getElementById('aiChat');
  if(chat.querySelector('.empty')) chat.innerHTML='';
  const div = document.createElement('div');
  div.className = role==='ai'?'msg-ai':'msg-user';
  if(role==='ai') {
    div.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div>`;
  } else {
    div.innerHTML = `<div class="msg-lbl" style="text-align:right">ä½  â–¸</div><div class="msg-bubble">${text}</div>`;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function addLoadingMsg() {
  const chat = document.getElementById('aiChat');
  if(chat.querySelector('.empty')) chat.innerHTML='';
  const div = document.createElement('div');
  div.className='msg-ai';
  div.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="loading-bubble"><div class="ld"></div><div class="ld"></div><div class="ld"></div></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

async function callAI(prompt) {
  const loadEl = addLoadingMsg();
  const activeTrack = selectedTracks.join('ã€') || 'æœªæŒ‡å®š';
  chatHistory.push({role:'user',content:prompt});
  try {
    const _aiKey2 = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';
    const res = await fetch('/api/tikhub',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-anthropic-key': _aiKey2},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:`ä½ æ˜¯ä¸“ä¸šçš„æŠ–éŸ³çˆ†æ¬¾å†…å®¹åˆ†æå¸ˆã€‚å½“å‰ç›‘æµ‹èµ›é“ï¼š${activeTrack}ã€‚${analysisResult?'å·²æœ‰åˆ†æä¸Šä¸‹æ–‡ï¼š'+analysisResult.slice(0,200):''}ã€‚è¯·ç”¨ç®€æ´ã€ä¸“ä¸šã€å¯æ“ä½œçš„æ–¹å¼å›ç­”ï¼Œé‡ç‚¹ç»™å‡ºå…·ä½“å»ºè®®ï¼Œ250å­—ä»¥å†…ï¼Œé€‚å½“ä½¿ç”¨emojiã€‚`,
        messages:chatHistory
      })
    });
    const d = await res.json();
    const reply = d.content?.[0]?.text || 'è¯·é‡è¯•ã€‚';
    chatHistory.push({role:'assistant',content:reply});
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble">${reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}</div>`;
    document.getElementById('aiChat').scrollTop = 99999;
  } catch(e) {
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble" style="color:var(--accent)">âš ï¸ è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>`;
  }
}

async function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value='';
  addMsg('user',text);
  await callAI(text);
}

function quickAsk(text) {
  document.getElementById('chatInput').value = text;
  sendMsg();
}

function handleKey(e) {
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault();sendMsg();}
}

function clearChat() {
  document.getElementById('aiChat').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ’¬</div><div class="empty-text">å¯¹è¯å·²æ¸…ç©º</div></div>`;
  chatHistory=[];
}

// ============ UTILS ============
function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#1a1d2a;border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:8px;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

// ============ CLOCK ============
setInterval(()=>{
  document.getElementById('clockPill').textContent = new Date().toLocaleTimeString('zh-CN');
},1000);

// ============ VIDEO URL ANALYSIS ============
let currentVideoStructure = '';
let selectedProductType = '';

function fillUrlExample(val) {
  if(val === 'paste') {
    document.getElementById('videoUrlInput').value = 'æ²¡æœ‰é“¾æ¥ï¼Œæˆ‘æ¥æè¿°ï¼š';
    document.getElementById('videoUrlInput').focus();
  } else {
    document.getElementById('videoUrlInput').value = val;
    analyzeVideoUrl();
  }
}

function selectProductType(btn, type) {
  document.querySelectorAll('.product-type-btn').forEach(b => b.className='btn btn-ghost btn-sm product-type-btn');
  btn.className = 'btn btn-red btn-sm product-type-btn';
  selectedProductType = type;
}

async function analyzeVideoUrl() {
  const input = document.getElementById('videoUrlInput').value.trim();
  if(!input) { showToast('è¯·è¾“å…¥è§†é¢‘é“¾æ¥æˆ–æ ‡é¢˜æè¿°'); return; }

  const aiChat = document.getElementById('aiChat');
  if(aiChat.querySelector('.empty')) aiChat.innerHTML='';

  // Show result area with loading
  document.getElementById('az-result').style.display = 'block';
  document.getElementById('videoInfoCard').innerHTML = `
    <div class="card-hd"><div class="card-title">ğŸ“¹ è§†é¢‘ä¿¡æ¯</div></div>
    <div class="card-body" style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;">
      <div class="ld"></div><div class="ld"></div><div class="ld"></div>&nbsp;æ­£åœ¨è·å–è§†é¢‘ä¿¡æ¯...
    </div>`;
  document.getElementById('structureCard').innerHTML = `
    <div class="card-hd"><div class="card-title">ğŸ§© çˆ†æ¬¾ç»“æ„æ‹†è§£</div></div>
    <div class="card-body" style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;">
      <div class="ld"></div><div class="ld"></div><div class="ld"></div>&nbsp;AIæ­£åœ¨æ·±åº¦æ‹†è§£å†…å®¹ç»“æ„...
    </div>`;
  document.getElementById('newScriptCard').style.display = 'none';

  addMsg('user', `è¯·å¸®æˆ‘æ‹†è§£è¿™ä¸ªè§†é¢‘ï¼š${input}`);
  const loadEl = addLoadingMsg();

  const _aiKey = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';

  const isUrl = input.startsWith('http');
  const prompt = `ä½ æ˜¯é¡¶çº§æŠ–éŸ³çˆ†æ¬¾å†…å®¹æ‹†è§£ä¸“å®¶ã€‚

${isUrl ? `ç”¨æˆ·æä¾›äº†è§†é¢‘é“¾æ¥ï¼š${input}` : `ç”¨æˆ·æè¿°äº†ä¸€ä¸ªè§†é¢‘ï¼š${input}`}

è¯·å®Œæˆä»¥ä¸‹æ‹†è§£ï¼ˆJSONæ ¼å¼å›å¤ï¼Œæ–¹ä¾¿ç¨‹åºè§£æï¼‰ï¼š

{
  "title": "è§†é¢‘æ ‡é¢˜ï¼ˆå¦‚èƒ½ä»é“¾æ¥æ¨æ–­ï¼‰æˆ–ç”¨æˆ·æè¿°çš„æ ‡é¢˜",
  "platform": "æŠ–éŸ³",
  "why_viral": "çˆ†ç«æ ¸å¿ƒåŸå› ï¼ˆ1å¥è¯ï¼‰",
  "hook": "å¼€åœºé’©å­/å‰3ç§’å¸å¼•ç‚¹",
  "structure": [
    {"step": 1, "name": "å¼€åœº", "duration": "0-5ç§’", "content": "å…·ä½“å†…å®¹", "technique": "ä½¿ç”¨çš„æŠ€å·§"},
    {"step": 2, "name": "ç—›ç‚¹/å…±é¸£", "duration": "5-15ç§’", "content": "å…·ä½“å†…å®¹", "technique": "ä½¿ç”¨çš„æŠ€å·§"},
    {"step": 3, "name": "ä»·å€¼å‘ˆç°", "duration": "15-40ç§’", "content": "å…·ä½“å†…å®¹", "technique": "ä½¿ç”¨çš„æŠ€å·§"},
    {"step": 4, "name": "ç»“å°¾é’©å­", "duration": "æœ€å5ç§’", "content": "å…·ä½“å†…å®¹", "technique": "ä½¿ç”¨çš„æŠ€å·§"}
  ],
  "emotion": "æ ¸å¿ƒæƒ…ç»ªä»·å€¼ï¼ˆå¦‚ï¼šå¥½å¥‡/å…±é¸£/æƒŠå–œï¼‰",
  "title_formula": "æ ‡é¢˜å…¬å¼ï¼ˆå¦‚ï¼š[æ•°å­—]+[ç—›ç‚¹]+[è§£å†³æ–¹æ¡ˆ]ï¼‰",
  "replication_tips": "å¤åˆ»æ—¶æœ€éœ€è¦ä¿ç•™çš„3ä¸ªå…³é”®ç‚¹"
}

åªè¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

  try {
    const res = await fetch('/api/tikhub', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-anthropic-key': _aiKey},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        messages:[{role:'user',content:prompt}]
      })
    });
    const d = await res.json();
    const text = d.content?.[0]?.text || '';

    let data;
    try {
      const clean = text.replace(/```json|```/g,'').trim();
      data = JSON.parse(clean);
    } catch(e) {
      data = { title: input.slice(0,40), why_viral: text.slice(0,100), structure: [], hook: '', emotion: '', title_formula: '', replication_tips: '' };
    }

    currentVideoStructure = JSON.stringify(data);
    chatHistory = [{role:'user',content:prompt},{role:'assistant',content:text}];

    // Render video info card
    document.getElementById('videoInfoCard').innerHTML = `
      <div class="card-hd">
        <div class="card-title">ğŸ“¹ è§†é¢‘ä¿¡æ¯</div>
        ${isUrl ? `<a href="${input}" target="_blank" class="btn btn-ghost btn-sm">ğŸ”— æŸ¥çœ‹åŸè§†é¢‘</a>` : ''}
      </div>
      <div class="card-body">
        <div style="font-size:14px;font-weight:700;margin-bottom:10px;">${data.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
        <div style="display:flex;gap:20px;flex-wrap:wrap;">
          <div><div style="font-size:10px;color:var(--muted);margin-bottom:3px;">çˆ†ç«åŸå› </div><div style="font-size:12px;color:var(--accent);">${data.why_viral||'â€”'}</div></div>
          <div><div style="font-size:10px;color:var(--muted);margin-bottom:3px;">æ ¸å¿ƒæƒ…ç»ª</div><div style="font-size:12px;color:var(--accent2);">${data.emotion||'â€”'}</div></div>
          <div><div style="font-size:10px;color:var(--muted);margin-bottom:3px;">å¼€åœºé’©å­</div><div style="font-size:12px;color:var(--gold);">${data.hook||'â€”'}</div></div>
        </div>
        <div style="margin-top:10px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:6px;padding:8px 12px;">
          <span style="font-size:10px;color:var(--accent3);font-family:\'IBM Plex Mono\',monospace;">æ ‡é¢˜å…¬å¼ï¼š</span>
          <span style="font-size:12px;color:var(--text);">${data.title_formula||'â€”'}</span>
        </div>
      </div>`;

    // Render structure card
    const stepsHtml = (data.structure||[]).map(s => `
      <div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);">
        <div style="width:24px;height:24px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;">${s.step}</div>
        <div style="flex:1;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;">
            <span style="font-size:12px;font-weight:700;">${s.name}</span>
            <span style="font-size:10px;color:var(--muted);font-family:\'IBM Plex Mono\',monospace;">${s.duration}</span>
          </div>
          <div style="font-size:12px;color:var(--text);line-height:1.6;">${s.content}</div>
          <div style="font-size:10px;color:var(--accent2);margin-top:3px;">æŠ€å·§ï¼š${s.technique}</div>
        </div>
      </div>`).join('');

    document.getElementById('structureCard').innerHTML = `
      <div class="card-hd">
        <div class="card-title">ğŸ§© çˆ†æ¬¾ç»“æ„æ‹†è§£</div>
        <span class="tag blue">å¯å¤åˆ»</span>
      </div>
      <div class="card-body">
        ${stepsHtml}
        <div style="margin-top:12px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:6px;padding:10px 12px;">
          <div style="font-size:10px;color:var(--green);margin-bottom:4px;font-family:\'IBM Plex Mono\',monospace;">å¤åˆ»æ—¶å¿…é¡»ä¿ç•™</div>
          <div style="font-size:12px;line-height:1.7;">${data.replication_tips||'â€”'}</div>
        </div>
      </div>`;

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble">âœ… æ‹†è§£å®Œæˆï¼æˆ‘å·²åˆ†æå‡ºè¿™ä¸ªè§†é¢‘çš„å®Œæ•´ç»“æ„ã€‚<br><br><strong>æ ¸å¿ƒäº®ç‚¹ï¼š</strong>${data.why_viral}<br><br>ç°åœ¨è¯·åœ¨ä¸‹æ–¹é€‰æ‹©ä½ çš„äº§å“ç±»å‹ï¼Œå¡«å…¥äº§å“åç§°ï¼Œæˆ‘ä¼šä¸ºä½ ç”Ÿæˆä¸“å±çš„å¤åˆ»è„šæœ¬ âœ¨</div>`;
    aiChat.scrollTop = 99999;

  } catch(e) {
    document.getElementById('structureCard').innerHTML = `<div class="card-body" style="color:var(--accent);font-size:13px;">âš ï¸ åˆ†æå¤±è´¥ï¼š${e.message}ï¼Œè¯·æ£€æŸ¥AI Keyé…ç½®</div>`;
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble" style="color:var(--accent)">âš ï¸ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Anthropic API Keyæ˜¯å¦é…ç½®</div>`;
  }
}

async function replicateWithProduct() {
  const product = document.getElementById('myProductInput').value.trim();
  if(!product) { showToast('è¯·å¡«å†™ä½ çš„äº§å“åç§°'); return; }
  if(!currentVideoStructure) { showToast('è¯·å…ˆå®Œæˆè§†é¢‘æ‹†è§£'); return; }
  if(!selectedProductType) { showToast('è¯·é€‰æ‹©äº§å“ç±»å‹'); return; }

  const newScriptCard = document.getElementById('newScriptCard');
  newScriptCard.style.display = 'block';
  newScriptCard.innerHTML = `
    <div class="card">
      <div class="card-hd"><div class="card-title">âœ¨ æ­£åœ¨ç”Ÿæˆå¤åˆ»è„šæœ¬...</div></div>
      <div class="card-body" style="display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;">
        <div class="ld"></div><div class="ld"></div><div class="ld"></div>
        &nbsp;AIæ­£åœ¨å…¨ç½‘æœç´¢ã€Œ${product}ã€çš„æ ¸å¿ƒä¹°ç‚¹ï¼Œå¹¶æŒ‰çˆ†æ¬¾ç»“æ„é‡æ–°åˆ›ä½œ...
      </div>
    </div>`;

  newScriptCard.scrollIntoView({behavior:'smooth', block:'start'});
  addMsg('user', `æˆ‘çš„äº§å“æ˜¯ã€Œ${product}ã€ï¼ˆ${selectedProductType}ç±»ï¼‰ï¼Œè¯·æŒ‰ç…§åˆšæ‰æ‹†è§£çš„çˆ†æ¬¾ç»“æ„ï¼Œä¸ºæˆ‘ç”Ÿæˆå¤åˆ»è„šæœ¬`);
  const loadEl = addLoadingMsg();

  const _aiKey = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';
  const structure = JSON.parse(currentVideoStructure);

  const prompt = `ä½ æ˜¯é¡¶çº§æŠ–éŸ³çˆ†æ¬¾å†…å®¹åˆ›ä½œä¸“å®¶ï¼Œæ“…é•¿æŠŠçˆ†æ¬¾ç»“æ„å¤åˆ»åˆ°æ–°äº§å“ä¸Šã€‚

ç”¨æˆ·äº§å“ï¼š${product}
äº§å“ç±»å‹ï¼š${selectedProductType}

å·²æ‹†è§£çš„çˆ†æ¬¾ç»“æ„ï¼š
${JSON.stringify(structure, null, 2)}

ä»»åŠ¡ï¼š
1. é¦–å…ˆï¼Œæ ¹æ®ä½ çš„çŸ¥è¯†æ€»ç»“ã€Œ${product}ã€çš„3-5ä¸ªæ ¸å¿ƒä¹°ç‚¹/å–ç‚¹ï¼ˆæ¨¡æ‹Ÿå…¨ç½‘æœç´¢ï¼‰
2. ç„¶åï¼Œä¸¥æ ¼æŒ‰ç…§ä¸Šæ–¹çˆ†æ¬¾ç»“æ„çš„æ¯ä¸ªæ­¥éª¤ï¼ŒæŠŠè¿™ä¸ªäº§å“çš„å†…å®¹å¡«è¿›å»ï¼Œç”Ÿæˆå®Œæ•´çš„æ–°è§†é¢‘è„šæœ¬
3. ä¿ç•™åŸç»“æ„çš„æƒ…ç»ªä»·å€¼ã€èŠ‚å¥æ„Ÿå’ŒæŠ€å·§ï¼Œåªæ›¿æ¢å…·ä½“å†…å®¹ä¸ºè¿™ä¸ªäº§å“

è¾“å‡ºæ ¼å¼ï¼š
**ã€${product}çš„æ ¸å¿ƒä¹°ç‚¹ã€‘**
- ä¹°ç‚¹1ï¼š...
- ä¹°ç‚¹2ï¼š...
- ä¹°ç‚¹3ï¼š...

**ã€å¤åˆ»è„šæœ¬ã€‘**
**æ ‡é¢˜ï¼š**ï¼ˆæŒ‰åŸæ ‡é¢˜å…¬å¼æ”¹å†™ï¼‰

**ç¬¬1æ­¥ - å¼€åœºï¼ˆ0-5ç§’ï¼‰ï¼š**
ç”»é¢ï¼š[å…·ä½“æ‹æ‘„å†…å®¹]
å°è¯/æ–‡æ¡ˆï¼š[å…·ä½“è¯´çš„è¯]

**ç¬¬2æ­¥ - [æ­¥éª¤å]ï¼ˆæ—¶é•¿ï¼‰ï¼š**
ç”»é¢ï¼š[å…·ä½“æ‹æ‘„å†…å®¹]  
å°è¯/æ–‡æ¡ˆï¼š[å…·ä½“è¯´çš„è¯]

ï¼ˆä»¥æ­¤ç±»æ¨ï¼Œå®Œæ•´è¦†ç›–æ‰€æœ‰æ­¥éª¤ï¼‰

**æ‹æ‘„å»ºè®®ï¼š**ï¼ˆ3æ¡å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®ï¼‰

è¯·ç”¨ä¸“ä¸šä½†æ¥åœ°æ°”çš„è¯­è¨€ï¼Œè®©æ™®é€šäººä¸€çœ‹å°±èƒ½æ‹ã€‚`;

  try {
    const res = await fetch('/api/tikhub', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-anthropic-key': _aiKey},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:2000,
        messages:[...chatHistory, {role:'user',content:prompt}]
      })
    });
    const d = await res.json();
    const reply = d.content?.[0]?.text || 'ç”Ÿæˆå¤±è´¥';
    chatHistory.push({role:'user',content:prompt},{role:'assistant',content:reply});

    const formatted = reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');

    newScriptCard.innerHTML = `
      <div class="card">
        <div class="card-hd">
          <div class="card-title">âœ¨ å¤åˆ»è„šæœ¬ Â· ${product}</div>
          <div style="display:flex;gap:6px;">
            <span class="tag green">å·²å®Œæˆ</span>
            <button class="btn btn-ghost btn-sm" onclick="copyScript()">ğŸ“‹ å¤åˆ¶è„šæœ¬</button>
          </div>
        </div>
        <div class="card-body" style="font-size:12px;line-height:1.9;" id="scriptContent">
          ${formatted}
        </div>
      </div>`;

    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble">ğŸ‰ å¤åˆ»è„šæœ¬ç”Ÿæˆå®Œæˆï¼<br><br>æˆ‘å·²ç»ï¼š<br>âœ… æœç´¢äº†ã€Œ${product}ã€çš„æ ¸å¿ƒä¹°ç‚¹<br>âœ… æŒ‰ç…§çˆ†æ¬¾ç»“æ„é‡æ–°åˆ›ä½œ<br>âœ… ä¿ç•™äº†åŸè§†é¢‘çš„æƒ…ç»ªä»·å€¼å’ŒèŠ‚å¥æ„Ÿ<br><br>å¦‚éœ€è°ƒæ•´ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼</div>`;
    document.getElementById('aiChat').scrollTop = 99999;

  } catch(e) {
    newScriptCard.innerHTML = `<div class="card"><div class="card-body" style="color:var(--accent);">âš ï¸ ç”Ÿæˆå¤±è´¥ï¼š${e.message}</div></div>`;
    loadEl.innerHTML = `<div class="msg-lbl">â–¸ AI åˆ†æå¸ˆ</div><div class="msg-bubble" style="color:var(--accent)">âš ï¸ ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
  }
}

function copyScript() {
  const el = document.getElementById('scriptContent');
  const text = el ? el.innerText : '';
  navigator.clipboard.writeText(text).then(() => showToast('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
}

// ============ ACCOUNT MONITORING ============
let monitoredAccounts = JSON.parse(localStorage.getItem('monitored_accounts') || '[]');
let selectedAccountId = null;

function openAddAccountModal() {
  document.getElementById('addAccountModal').style.display = 'flex';
  document.getElementById('addAccountInput').value = '';
  document.getElementById('addAccountError').style.display = 'none';
  setTimeout(() => document.getElementById('addAccountInput').focus(), 100);
}

async function confirmAddAccount() {
  const uid = document.getElementById('addAccountInput').value.trim();
  const errEl = document.getElementById('addAccountError');
  if(!uid) { errEl.style.display='block'; errEl.textContent='è¯·è¾“å…¥æŠ–éŸ³å·'; return; }

  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || '';
  if(!key) { errEl.style.display='block'; errEl.textContent='è¯·å…ˆåœ¨ã€Œæ•°æ®æºã€ä¸­é…ç½®TikHub Key'; return; }

  errEl.style.display = 'none';
  const btn = document.querySelector('[onclick="confirmAddAccount()"]');
  if(btn) { btn.textContent = 'â³ æŸ¥è¯¢ä¸­...'; btn.disabled = true; }

  try {
    const r = await fetch(`/api/tikhub?endpoint=user_info&unique_id=${encodeURIComponent(uid)}`, {
      headers: { 'x-api-key': key }
    });
    const j = await r.json();
    if(!j?.success || !j?.user) {
      errEl.style.display = 'block';
      errEl.textContent = j?.error || 'æœªæ‰¾åˆ°è¯¥è´¦å·ï¼Œè¯·æ£€æŸ¥æŠ–éŸ³å·æ˜¯å¦æ­£ç¡®';
      return;
    }
    const user = j.user;
    // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
    if(monitoredAccounts.find(a => a.uniqueId === user.uniqueId)) {
      errEl.style.display='block'; errEl.textContent='è¯¥è´¦å·å·²åœ¨ç›‘æµ‹åˆ—è¡¨ä¸­'; return;
    }
    monitoredAccounts.push({
      ...user,
      addedAt: Date.now(),
      lastChecked: Date.now(),
      prevVideoCount: user.awemeCount || 0,
      alerts: [],
    });
    localStorage.setItem('monitored_accounts', JSON.stringify(monitoredAccounts));
    document.getElementById('addAccountModal').style.display = 'none';
    renderAccountList();
    viewAccount(monitoredAccounts.length - 1);
    showToast(`âœ… å·²æ·»åŠ ç›‘æµ‹ï¼š${user.nickname}`);
  } catch(e) {
    errEl.style.display='block'; errEl.textContent = 'æŸ¥è¯¢å¤±è´¥ï¼š' + e.message;
  } finally {
    if(btn) { btn.textContent = 'ğŸ” æŸ¥è¯¢å¹¶æ·»åŠ '; btn.disabled = false; }
  }
}

function renderAccountList() {
  const el = document.getElementById('accountList');
  if(monitoredAccounts.length === 0) {
    el.innerHTML = `<div class="empty" style="padding:40px 0;"><div class="empty-icon">ğŸ‘¤</div><div class="empty-text">è¿˜æ²¡æœ‰ç›‘æµ‹è´¦å·<br>ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ è´¦å·ã€</div></div>`;
    return;
  }
  el.innerHTML = monitoredAccounts.map((a, i) => `
    <div onclick="viewAccount(${i})" style="background:var(--surface);border:1px solid ${selectedAccountId===i?'var(--accent)':'var(--border)'};border-radius:10px;padding:12px 14px;cursor:pointer;transition:all 0.15s;margin-bottom:8px;" onmouseover="this.style.borderColor='var(--accent2)'" onmouseout="this.style.borderColor='${selectedAccountId===i?'var(--accent)':'var(--border)'}'">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;overflow:hidden;">
          ${a.avatarUrl ? `<img src="${a.avatarUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='ğŸ‘¤'">` : 'ğŸ‘¤'}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.nickname || a.uniqueId}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:1px;">@${a.uniqueId} Â· ${fmtNum(a.followerCount)}ç²‰</div>
        </div>
        ${a.alerts.length > 0 ? `<div style="width:18px;height:18px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;">${a.alerts.length}</div>` : ''}
      </div>
    </div>`).join('');
}

function fmtNum(n) {
  n = parseInt(n||0);
  return n>=1e8?(n/1e8).toFixed(1)+'äº¿':n>=1e4?(n/1e4).toFixed(1)+'ä¸‡':n>=1e3?(n/1e3).toFixed(0)+'k':String(n);
}

async function viewAccount(idx) {
  selectedAccountId = idx;
  renderAccountList();
  const a = monitoredAccounts[idx];
  const el = document.getElementById('accountDetail');

  el.innerHTML = `
    <div class="card" style="margin-bottom:14px;">
      <div class="card-hd">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:48px;height:48px;border-radius:50%;background:var(--surface2);overflow:hidden;flex-shrink:0;">
            ${a.avatarUrl ? `<img src="${a.avatarUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src=''">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:24px;">ğŸ‘¤</div>'}
          </div>
          <div>
            <div style="font-size:15px;font-weight:700;">${a.nickname || a.uniqueId}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;">@${a.uniqueId}${a.verified?' Â· '+a.verified:''}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <a href="https://www.douyin.com/user/${a.uid||''}" target="_blank" class="btn btn-ghost btn-sm">ğŸ”— ä¸»é¡µ</a>
          <button class="btn btn-ghost btn-sm" onclick="refreshAccount(${idx})">â†» åˆ·æ–°</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--accent);" onclick="removeAccount(${idx})">åˆ é™¤</button>
        </div>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;text-align:center;">
          <div><div style="font-size:18px;font-weight:800;color:var(--accent2);">${fmtNum(a.followerCount)}</div><div style="font-size:10px;color:var(--muted);margin-top:2px;">ç²‰ä¸</div></div>
          <div><div style="font-size:18px;font-weight:800;color:var(--accent);">${fmtNum(a.awemeCount)}</div><div style="font-size:10px;color:var(--muted);margin-top:2px;">ä½œå“</div></div>
          <div><div style="font-size:18px;font-weight:800;color:var(--gold);">${fmtNum(a.totalFavorited)}</div><div style="font-size:10px;color:var(--muted);margin-top:2px;">è·èµ</div></div>
          <div><div style="font-size:18px;font-weight:800;color:var(--green);">${fmtNum(a.followingCount)}</div><div style="font-size:10px;color:var(--muted);margin-top:2px;">å…³æ³¨</div></div>
        </div>
        ${a.signature ? `<div style="margin-top:12px;font-size:11px;color:var(--muted);line-height:1.7;padding:8px 12px;background:var(--surface2);border-radius:6px;">${a.signature}</div>` : ''}
      </div>
    </div>

    ${a.alerts.length > 0 ? `
    <div class="card" style="margin-bottom:14px;">
      <div class="card-hd"><div class="card-title">ğŸ”” çˆ†æ¬¾é¢„è­¦</div><span style="font-size:10px;color:var(--accent);font-family:'IBM Plex Mono',monospace;">${a.alerts.length} æ¡</span></div>
      <div class="card-body" style="display:flex;flex-direction:column;gap:8px;">
        ${a.alerts.map(al => `
          <div style="background:rgba(255,51,85,0.06);border:1px solid rgba(255,51,85,0.2);border-radius:8px;padding:10px 12px;">
            <div style="font-size:11px;color:var(--accent);font-family:'IBM Plex Mono',monospace;margin-bottom:4px;">${al.time}</div>
            <div style="font-size:12px;line-height:1.6;">${al.text}</div>
            ${al.url ? `<a href="${al.url}" target="_blank" style="font-size:10px;color:var(--accent2);text-decoration:none;">æŸ¥çœ‹è§†é¢‘ â†’</a>` : ''}
          </div>`).join('')}
      </div>
    </div>` : ''}

    <div class="card">
      <div class="card-hd">
        <div class="card-title">ğŸ“Š ç›‘æµ‹çŠ¶æ€</div>
        <span style="font-size:10px;color:var(--muted);font-family:'IBM Plex Mono',monospace;">ä¸Šæ¬¡æ£€æŸ¥ï¼š${new Date(a.lastChecked).toLocaleTimeString('zh-CN')}</span>
      </div>
      <div class="card-body" style="font-size:12px;color:var(--muted);line-height:1.9;">
        âœ… æ­£åœ¨ç›‘æµ‹ä¸­ï¼Œæ¯æ¬¡ç‚¹å‡»ã€Œåˆ·æ–°ã€æˆ–åº”ç”¨è‡ªåŠ¨åˆ·æ–°æ—¶ä¼šæ£€æŸ¥è¯¥è´¦å·<br>
        ğŸ”” ä¸€æ—¦ä½œå“æ•°é‡å¢åŠ ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆçˆ†æ¬¾é¢„è­¦æé†’<br>
        ğŸ“ˆ å½“å‰ä½œå“æ•°ï¼š${a.awemeCount} ä¸ª<br>
        <div style="margin-top:10px;">
          <button class="btn btn-red btn-sm" onclick="checkAccountForNew(${idx})">ğŸ” ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰æ–°ä½œå“</button>
        </div>
      </div>
    </div>`;
}

async function refreshAccount(idx) {
  const a = monitoredAccounts[idx];
  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || '';
  if(!key) { showToast('è¯·å…ˆé…ç½®TikHub Key'); return; }

  showToast('æ­£åœ¨åˆ·æ–°è´¦å·æ•°æ®...');
  try {
    const r = await fetch(`/api/tikhub?endpoint=user_info&unique_id=${encodeURIComponent(a.uniqueId)}`, {
      headers: { 'x-api-key': key }
    });
    const j = await r.json();
    if(j?.success && j?.user) {
      const prev = monitoredAccounts[idx].awemeCount || 0;
      Object.assign(monitoredAccounts[idx], j.user, { lastChecked: Date.now() });
      const curr = j.user.awemeCount || 0;
      if(curr > prev) {
        const diff = curr - prev;
        monitoredAccounts[idx].alerts.unshift({
          time: new Date().toLocaleString('zh-CN'),
          text: `ğŸ”¥ å‘ç° ${diff} ä¸ªæ–°è§†é¢‘ï¼ä½œå“æ€»æ•°ä» ${prev} å¢åŠ åˆ° ${curr}ï¼Œè¯·ç«‹å³æŸ¥çœ‹æ˜¯å¦æœ‰çˆ†æ¬¾`,
          url: `https://www.douyin.com/user/${j.user.uid||''}`,
        });
        showToast(`ğŸ”” ${a.nickname} å‘å¸ƒäº† ${diff} ä¸ªæ–°è§†é¢‘ï¼`);
      } else {
        showToast(`âœ… ${j.user.nickname} æ•°æ®å·²æ›´æ–°ï¼Œæš‚æ— æ–°ä½œå“`);
      }
      localStorage.setItem('monitored_accounts', JSON.stringify(monitoredAccounts));
      viewAccount(idx);
    }
  } catch(e) { showToast('åˆ·æ–°å¤±è´¥ï¼š' + e.message); }
}

async function checkAccountForNew(idx) {
  await refreshAccount(idx);
}

function removeAccount(idx) {
  const name = monitoredAccounts[idx].nickname;
  monitoredAccounts.splice(idx, 1);
  localStorage.setItem('monitored_accounts', JSON.stringify(monitoredAccounts));
  selectedAccountId = null;
  document.getElementById('accountDetail').innerHTML = `<div class="empty" style="padding:80px 0;"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">é€‰æ‹©å·¦ä¾§è´¦å·<br>æŸ¥çœ‹å®æ—¶ç›‘æµ‹æ•°æ®</div></div>`;
  renderAccountList();
  showToast(`å·²åˆ é™¤ï¼š${name}`);
}

// åˆå§‹åŒ–è´¦å·åˆ—è¡¨
renderAccountList();



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// v4 çœŸå®æ•°æ®å¼•æ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dsSource    = localStorage.getItem('ds_source') || null;
let _dsKey       = localStorage.getItem('ds_key')    || null;
let _dsConnected = false;
let _dsSelectedSource = _dsSource || 'tikhub';

const TRACK_KEYWORDS = {
  'ç¾é£Ÿ':['ç¾é£Ÿ','æ¢åº—','åšé¥­','æ–™ç†'],
  'æ—¶å°šç©¿æ­':['ç©¿æ­','æ—¶å°š','ootd','æ˜¾ç˜¦'],
  'æç¬‘æ®µå­':['æç¬‘','æ®µå­','å–œå‰§','æ²™é›•'],
  'æƒ…æ„Ÿè¯­å½•':['æƒ…æ„Ÿ','è¯­å½•','çˆ±æƒ…','æ²»æ„ˆ'],
  'å¥èº«è¿åŠ¨':['å¥èº«','å‡è„‚','è¿åŠ¨','æ’¸é“'],
  'çŸ¥è¯†ç§‘æ™®':['ç§‘æ™®','æ¶¨çŸ¥è¯†','å†·çŸ¥è¯†','å­¦ä¹ '],
  'æ—…æ¸¸æ‰“å¡':['æ—…æ¸¸','æ‰“å¡','æ—…è¡Œ','æ™¯ç‚¹'],
  'æ¯å©´è‚²å„¿':['è‚²å„¿','å®å®','æ¯å©´','æ—©æ•™'],
  'æ¸¸æˆç”µç«':['æ¸¸æˆ','ç‹è€…è£è€€','åŸç¥','ç”µç«'],
  'è´¢ç»å•†ä¸š':['è´¢ç»','ç†è´¢','æŠ•èµ„','å‰¯ä¸š'],
  'å® ç‰©èŒå® ':['å® ç‰©','çŒ«å’ª','ç‹—ç‹—','èŒå® '],
  'ç¾å¦†æŠ¤è‚¤':['ç¾å¦†','æŠ¤è‚¤','å½©å¦†','ç´ é¢œ'],
  default:['çƒ­é—¨','çˆ†æ¬¾','æ¨è'],
};

// â”€â”€ Claude AI é©±åŠ¨çš„æŠ–éŸ³æ•°æ®æœç´¢å¼•æ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// é€šè¿‡ Anthropic API è®© Claude æœç´¢å¹¶è¿”å›çœŸå®æŠ–éŸ³çƒ­é—¨è§†é¢‘
// å®Œå…¨ç»•è¿‡ CORS é™åˆ¶ï¼ˆAnthropic API æ”¯æŒè·¨åŸŸï¼‰

// â”€â”€ åŸå§‹è§†é¢‘å¯¹è±¡ â†’ å·¥å…·ç»Ÿä¸€æ ¼å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeAweme(raw, track) {
  if (!raw || typeof raw !== 'object') return null;
  if (raw._isHotSearch) {
    const kw = raw.desc || '';
    return {
      aweme_id: 'hot_' + kw,
      url: 'https://www.douyin.com/search/' + encodeURIComponent(kw) + '?type=video',
      title: 'ğŸ”¥ çƒ­æœï¼š' + kw,
      fullTitle: kw,
      likes: raw._hotValue ? Math.round(raw._hotValue/10000)+'ä¸‡çƒ­åº¦' : 'çƒ­æœ',
      comments: '--', shares: '--', plays: '--',
      heat: Math.min(99, Math.max(50, Math.round((raw._hotValue||5000000)/100000))),
      cover: '', author: 'æŠ–éŸ³çƒ­æœæ¦œ', track,
      publishedAt: 'ä»Šæ—¥', isNew: true, trend: '+', trendVal: 99,
      emoji: 'ğŸ”¥', source: 'real',
    };
  }
  try {
    const aweme_id = String(raw.aweme_id || raw.id || raw.video_id || '').trim();
    const desc = (raw.desc || raw.title || raw.content || '').trim();
    if (!desc || desc.length < 2) return null;

    const stat = raw.statistics || raw.stats || {};
    const author = raw.author || raw.user || {};
    const likes    = parseInt(stat.digg_count    || stat.like_count    || stat.likes    || 0);
    const comments = parseInt(stat.comment_count || stat.commentCount  || stat.comments || 0);
    const shares   = parseInt(stat.share_count   || stat.shareCount    || stat.shares   || 0);
    const plays    = parseInt(stat.play_count    || stat.playCount     || stat.views    || 0);

    const fmt = n => n>=1e8?(n/1e8).toFixed(1)+'äº¿':n>=1e4?(n/1e4).toFixed(1)+'ä¸‡':n>=1e3?(n/1e3).toFixed(1)+'k':String(n||0);
    // ä¼˜å…ˆç”¨é¢„æ ¼å¼åŒ–å­—ç¬¦ä¸²
    if (raw._likesStr) {
      return {
        aweme_id: 'builtin_' + Math.random().toString(36).slice(2,8),
        url: 'https://www.douyin.com/search/' + encodeURIComponent(raw.search_keyword || raw.desc || '') + '?type=video&sort_type=1',
        title:    raw.desc.length>55 ? raw.desc.slice(0,55)+'â€¦' : raw.desc,
        fullTitle: raw.desc,
        likes:    raw._likesStr,   likesRaw: 0,
        comments: raw._commStr,
        shares:   raw._shareStr,
        plays:    raw._playsStr,
        heat:     raw._heat || 80,
        cover:    '',
        author:   (raw.author||{}).nickname || 'æŠ–éŸ³åšä¸»',
        track,
        publishedAt: 'ä»Šæ—¥',
        isNew:    raw._heat >= 95,
        trend:    raw._heat >= 90 ? '+' : '-',
        trendVal: Math.floor((raw._heat||80) - 70),
        emoji:    EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
        source:   'real',
      };
    }
    const playScore = plays>0 ? Math.log10(plays)*10 : 25;
    const engScore  = Math.log10(Math.max(likes*3+comments*5+shares*8, 1))*12;
    const heat      = Math.min(99, Math.max(30, Math.round(playScore + engScore)));
    const secUid    = author.sec_uid || author.uid || '';
    const keyword   = raw.search_keyword || '';

    // è§†é¢‘ç›´é“¾ï¼šæœ‰ aweme_id å°±ç²¾å‡†è·³è½¬ï¼Œå¦åˆ™ç”¨å…³é”®è¯æœç´¢
    const url = aweme_id && !aweme_id.startsWith('search_')
      ? 'https://www.douyin.com/video/' + aweme_id
      : 'https://www.douyin.com/search/' + encodeURIComponent(keyword || desc) + '?type=video';

    return {
      aweme_id: aweme_id || ('ai_' + Math.random().toString(36).slice(2,8)),
      url,
      title:    desc.length>55 ? desc.slice(0,55)+'â€¦' : desc,
      fullTitle: desc,
      likes:    fmt(likes),    likesRaw: likes,
      comments: fmt(comments),
      shares:   fmt(shares),
      plays:    fmt(plays),
      heat,
      cover:    raw.video?.cover?.url_list?.[0] || '',
      author:   author.nickname || author.name || 'æŠ–éŸ³ç”¨æˆ·',
      authorUrl: secUid ? 'https://www.douyin.com/user/'+secUid : '',
      track,
      publishedAt: 'æœ€è¿‘',
      isNew:    false,
      trend:    likes>10000 ? '+' : '-',
      trendVal: Math.floor(Math.random()*20+1),
      emoji:    EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
      source:   'real',
    };
  } catch(e) { console.warn('normalizeAweme:', e.message); return null; }
}

// â”€â”€ çœŸå®æ•°æ®è·å–ï¼šé€šè¿‡ Claude API æœç´¢æŠ–éŸ³çƒ­é—¨è§†é¢‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åŸç†ï¼šè°ƒç”¨ Anthropic APIï¼Œè®© AI è”ç½‘æœç´¢æŠ–éŸ³çœŸå®çƒ­é—¨è§†é¢‘ï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®
// ä¼˜ç‚¹ï¼šæ—  CORS é—®é¢˜ï¼Œfile:// å¯ç”¨ï¼Œä¸éœ€è¦ TikHub è´¦æˆ·
// â”€â”€ TikHub æ•°æ®ï¼ˆé€šè¿‡æœ¬ç«™ /api/tikhub ä¸­è½¬ï¼Œæ—  CORS é—®é¢˜ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchViaTikHub(keyword) {
  const key = localStorage.getItem('tikhub_key') || localStorage.getItem('ds_key') || _dsKey;
  if (!key) return null;

  // å…ˆå°è¯•å…³é”®è¯æœç´¢ï¼Œå†fallbackåˆ°çƒ­æœæ¦œ
  const requests = [
    { url: `/api/tikhub?endpoint=search&keyword=${encodeURIComponent(keyword)}`, type: 'search' },
    { url: `/api/tikhub?endpoint=hot_search`, type: 'hot_search' },
  ];

  for (const req of requests) {
    try {
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 15000);
      const r = await fetch(req.url, {
        signal: controller.signal,
        headers: { 'x-api-key': key }
      });
      if (!r.ok) { console.warn('[TikHub] HTTP', r.status); continue; }
      const j = await r.json();
      console.log('[TikHub proxy] endpoint:', req.type, 'success:', j?.success, 'items:', j?.items?.length);

      if (!j?.success) {
        if (j?.error?.includes('401') || j?.error?.includes('æ— æ•ˆ')) throw new Error('TikHub Key æ— æ•ˆï¼ˆ401ï¼‰');
        continue;
      }

      // æœç´¢ç»“æœï¼šç›´æ¥è¿”å›è§†é¢‘åˆ—è¡¨æ ¼å¼
      if (req.type === 'search' && j.items?.length > 0) {
        return j.items.map(item => ({
          aweme_id: item.awemeId || '',
          desc: item.desc || '',
          author: { nickname: item.author || '', uid: item.authorId || '' },
          statistics: {
            digg_count: item.diggCount || 0,
            comment_count: item.commentCount || 0,
            share_count: item.shareCount || 0,
            play_count: item.playCount || 0,
          },
          video: { cover: { url_list: item.coverUrl ? [item.coverUrl] : [] } },
          search_keyword: keyword,
        }));
      }

      // çƒ­æœç»“æœï¼šè½¬æ¢ä¸ºå¯è¯†åˆ«çš„æ ¼å¼
      if (req.type === 'hot_search' && j.items?.length > 0) {
        return j.items.slice(0, 20).map(item => ({
          _isHotSearch: true,
          desc: item.word || '',
          _hotValue: item.hotValue || 0,
        }));
      }
    } catch(e) {
      if (e.name === 'AbortError') { console.warn('[TikHub] timeout'); continue; }
      if (e.message.includes('æ— æ•ˆ')) throw e;
      console.warn('[TikHub]', e.message);
    }
  }
  return null;
}

async function fetchViaRapidApi(keyword) {
  return await fetchViaTikHub(keyword);
}








// â”€â”€ æ•°æ®æºå¼¹çª—æ‰€æœ‰ UI å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


function saveKeyOnly() {
  const key = document.getElementById('dsApiKeyInput')?.value?.trim();
  const errEl = document.getElementById('dsError');
  if (!key || key.length < 8) {
    if (errEl) { errEl.style.display='block'; errEl.textContent='è¯·å…ˆç²˜è´´å®Œæ•´çš„ API Key'; }
    return;
  }
  localStorage.setItem('tikhub_key', key);
  localStorage.setItem('ds_key', key);
  localStorage.setItem('ds_source', 'tikhub');
  _dsKey = key; _dsSource = 'tikhub';
  const succ = document.getElementById('dsSuccess');
  if (succ) {
    succ.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
    succ.textContent = 'âœ… Key å·²ä¿å­˜ï¼ä¸Šä¼ åˆ° Vercel åå³å¯è·å–çœŸå®æ•°æ®';
  }
}

function openDataSourceModal() {
  const m = document.getElementById('dsModal');
  if (!m) return;
  m.style.display = 'flex';
  const inp = document.getElementById('dsApiKeyInput');
  if (inp) {
    const saved = localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key') || '';
    if (saved) inp.value = saved;
  }
  _updateDsUI();
}

function selectDataSource(src) {
  _dsSelectedSource = src;
}

function _updateDsUI() {
  const s = document.getElementById('dsSuccess');
  const e = document.getElementById('dsError');
  if (e) e.style.display = 'none';
  if (!s) return;
  const hasKey = !!(localStorage.getItem('anthropic_key') || localStorage.getItem('ds_key'));
  if (_dsConnected) {
    s.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
    s.textContent = 'âœ… å·²è¿æ¥ï¼Œæ­£åœ¨è·å–çœŸå®æŠ–éŸ³æ•°æ®';
  } else if (hasKey) {
    s.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#92400e;background:#fef3c7;border:1px solid #fde68a;';
    s.textContent = 'âš ï¸ Key å·²ä¿å­˜ï¼Œè¯·ç‚¹ã€Œè¿æ¥å¹¶æµ‹è¯•ã€ç¡®è®¤';
  } else {
    s.style.display = 'none';
  }
}

async function testAndSaveDataSource() {
  const key = document.getElementById('dsApiKeyInput')?.value?.trim();
  const errEl = document.getElementById('dsError');
  const succ  = document.getElementById('dsSuccess');
  if (errEl) errEl.style.display = 'none';
  if (succ)  succ.style.display  = 'none';
  if (!key || key.length < 8) {
    if (errEl) { errEl.style.display='block'; errEl.textContent='è¯·å…ˆç²˜è´´å®Œæ•´çš„ API Key'; }
    return;
  }
  const btn = document.querySelector('[onclick="testAndSaveDataSource()"]');
  if (btn) { btn.textContent = 'â³ æµ‹è¯•ä¸­â€¦'; btn.disabled = true; }

  // åˆ¤æ–­ Key ç±»å‹ï¼šsk-ant- å¼€å¤´ = Anthropic Keyï¼›å¦åˆ™å½“ TikHub Key
  const isAnthropic = key.startsWith('sk-ant-');
  const isTikHub    = !isAnthropic;

  localStorage.setItem('ds_key', key);
  localStorage.setItem('ds_source', isAnthropic ? 'anthropic' : 'tikhub');
  if (isAnthropic) localStorage.setItem('anthropic_key', key);
  else             localStorage.setItem('tikhub_key', key);
  _dsKey = key; _dsSource = isAnthropic ? 'anthropic' : 'tikhub';

  try {
    let testOk = false;
    let sampleText = '';

    if (isAnthropic) {
      // æµ‹è¯• Anthropic Keyï¼ˆé€šè¿‡æœåŠ¡ç«¯ä»£ç†ï¼Œæ—  CORSï¼‰
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 20000);
      const r = await fetch('/api/tikhub', {
        method: 'POST',
        signal: controller.signal,
        headers: { 'Content-Type': 'application/json', 'x-anthropic-key': key },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 20,
          messages: [{ role: 'user', content: 'å›å¤"è¿æ¥æ­£å¸¸"' }]
        })
      });
      clearTimeout(timer);
      if (r.status === 401) throw new Error('Anthropic Key æ— æ•ˆï¼ˆ401ï¼‰ï¼Œè¯·ç¡®è®¤ Key æ­£ç¡®');
      if (r.status === 403) throw new Error('Key æ— æƒè®¿é—®ï¼Œè¯·æ£€æŸ¥è´¦æˆ·çŠ¶æ€');
      const d = await r.json();
      if (d.error) throw new Error(d.error.message || JSON.stringify(d.error));
      sampleText = d.content?.[0]?.text || 'OK';
      testOk = true;
    } else {
      // æµ‹è¯• TikHub Keyï¼šè°ƒç”¨çƒ­æœæ¦œæ¥å£
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 20000);
      const r = await fetch('/api/tikhub?endpoint=hot_search', {
        signal: controller.signal,
        headers: { 'x-api-key': key }
      });
      const j = await r.json();
      if (!j?.success) throw new Error(j?.error || 'TikHub è¿”å›å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Key å’Œè´¦æˆ·ä½™é¢');
      const count = j?.items?.length || 0;
      if (count === 0) throw new Error('TikHub è¿”å›æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ Key å’Œè´¦æˆ·ä½™é¢');
      sampleText = `è·å–åˆ° ${count} æ¡çƒ­æœæ•°æ®`;
      testOk = true;
    }

    if (testOk) {
      _dsConnected = true;
      if (succ) {
        succ.style.cssText = 'display:block;font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:10px;color:#166534;background:#f0fdf4;border:1px solid #bbf7d0;';
        succ.textContent = 'âœ… è¿æ¥æˆåŠŸï¼' + (isAnthropic ? 'Anthropic AI å·²å°±ç»ª Â· ' : 'TikHub Â· ') + sampleText;
      }
      if (errEl) errEl.style.display = 'none';
      _refreshDsBadges();
      setTimeout(() => {
        document.getElementById('dsModal').style.display = 'none';
        refreshFeed(true);
        showToast('ğŸ‰ ' + (isAnthropic ? 'AI åˆ†æåŠŸèƒ½å·²æ¿€æ´»ï¼' : 'çœŸå®æ•°æ®å·²æ¥å…¥ï¼'));
      }, 1500);
    }
  } catch(e) {
    _dsConnected = false; _dsKey = null;
    localStorage.removeItem('ds_key');
    localStorage.removeItem('anthropic_key');
    localStorage.removeItem('tikhub_key');
    const msg = 'âŒ ' + (e.name==='AbortError'||e.message.includes('TIMEOUT')
      ? 'è¯·æ±‚è¶…æ—¶ï¼ˆ20ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
      : e.message.slice(0, 150));
    if (errEl) {
      errEl.style.cssText = 'display:block;font-size:11px;padding:10px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;white-space:pre-line;';
      errEl.textContent = msg;
    }
  } finally {
    if (btn) { btn.textContent = 'ğŸ”Œ è¿æ¥å¹¶æµ‹è¯•'; btn.disabled = false; }
  }
}

function clearDataSource() {
  _dsKey = null; _dsSource = null; _dsConnected = false;
  localStorage.removeItem('ds_key');
  localStorage.removeItem('ds_source');
  localStorage.removeItem('anthropic_key');
  const inp = document.getElementById('dsApiKeyInput');
  if (inp) inp.value = '';
  _updateDsUI();
  _refreshDsBadges();
  showToast('å·²æ¸…é™¤ï¼Œåˆ‡æ¢æ¼”ç¤ºæ¨¡å¼');
}

function _refreshDsBadges() {
  const ok    = _dsConnected && !!_dsSource;
  const badge = document.getElementById('dataSourceBadge');
  const btn   = document.getElementById('dsStatusBtn');
  if (badge) {
    badge.style.background = ok ? 'rgba(16,185,129,0.1)' : '#1a1d2a';
    badge.style.color      = ok ? '#10b981' : '#9ca3af';
    badge.textContent      = ok ? 'â— å®æ—¶æ•°æ®' : 'æ¼”ç¤ºæ•°æ®';
  }
  if (btn) {
    btn.style.background  = ok ? 'rgba(16,185,129,0.15)' : 'rgba(99,102,241,0.15)';
    btn.style.borderColor = ok ? 'rgba(16,185,129,0.4)'  : 'rgba(99,102,241,0.3)';
    btn.style.color       = ok ? '#10b981' : '#818cf8';
    btn.textContent       = ok ? 'âœ… çœŸå®æ•°æ®' : 'ğŸ“¡ æ•°æ®æº';
  }
}

// åˆå§‹åŒ–èµ›é“ç½‘æ ¼
renderTrackGrid();

// å¯åŠ¨æ—¶æ¢å¤å·²ä¿å­˜çš„ Key
(function restoreDs() {
  _dsSource = 'builtin'; _dsConnected = true;
  setTimeout(() => {
    _refreshDsBadges();
    const badge = document.getElementById('dataSourceBadge');
    if (badge) { badge.textContent = 'â— å†…ç½®æ•°æ®'; badge.style.color='#10b981'; }
    const btn = document.getElementById('dsStatusBtn');
    if (btn) { btn.textContent = 'ğŸ“Š æ•°æ®ç®¡ç†'; }
  }, 300);
})();


</script>


<!-- â•â•â• æ•°æ®æºé…ç½®æ¨¡æ€æ¡† â•â•â• -->
<div id="dsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(8px);">
  <div style="background:#fff;border-radius:18px;padding:28px;width:92%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,0.25);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;">
      <div>
        <div style="font-size:16px;font-weight:800;color:#111827;">ğŸ”Œ æ¥å…¥çœŸå®æŠ–éŸ³æ•°æ®</div>
        <div style="font-size:11px;color:#9ca3af;margin-top:3px;">å¡«å…¥ TikHub Key â†’ è¿æ¥æµ‹è¯• â†’ è·å–çœŸå®æŠ–éŸ³æ•°æ®</div>
      </div>
      <button onclick="document.getElementById('dsModal').style.display='none'" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:22px;">âœ•</button>
    </div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:11px;color:#1e40af;line-height:1.7;">
      <strong>ğŸ’¡ æ”¯æŒä¸¤ç§ Keyï¼š</strong><br>
      <strong>â‘  Anthropic API Key</strong>ï¼ˆ<code style="background:#dbeafe;padding:1px 4px;border-radius:3px;">sk-ant-...</code>ï¼‰â†’ æ¿€æ´» AI åˆ†æåŠŸèƒ½ï¼ˆåˆ†ææŠ¥å‘Š + AI å¯¹è¯ï¼‰<br>
      <strong>â‘¡ TikHub API Key</strong> â†’ è·å–çœŸå®æŠ–éŸ³çˆ†æ¬¾è§†é¢‘æ•°æ®ï¼ˆå®æ—¶ç›‘æµ‹æ¦œï¼‰<br>
      å¡«å…¥å…¶ä¸­ä¸€ä¸ªå³å¯ï¼Œå¡«ä¸¤ä¸ªéƒ½æ”¯æŒã€‚
    </div>

    <!-- Anthropic -->
    <div id="ds-tikhub-card" style="border:2px solid #6366f1;border-radius:12px;padding:14px 16px;margin-bottom:10px;background:#f5f3ff;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:18px;">ğŸ¤–</span>
          <span style="font-size:13px;font-weight:800;color:#111827;">Anthropic API Key</span>
          <span style="font-size:9px;background:#dcfce7;color:#166534;border-radius:20px;padding:2px 8px;font-weight:700;">æ¨è Â· ç›´æ¥å¯ç”¨</span>
        </div>
        <div id="ds-tikhub-check" style="color:#10b981;font-size:18px;font-weight:700;">âœ“</div>
      </div>
      <div style="font-size:11px;color:#6b7280;line-height:1.6;">ä½¿ç”¨ Claude AI ç”Ÿæˆå„èµ›é“çƒ­é—¨è§†é¢‘æ•°æ®ï¼Œæ—  CORS é™åˆ¶ï¼Œfile:// ç›´æ¥å¯ç”¨ã€‚</div>
      <div style="margin-top:8px;background:#f8fafc;border-radius:6px;padding:8px 10px;font-size:10px;color:#374151;line-height:1.9;">
        <strong>è·å–æ­¥éª¤ï¼š</strong><br>
        1. æ‰“å¼€ <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#3b82f6;font-weight:600;">console.anthropic.com</a> â†’ API Keys<br>
        2. ç‚¹ <strong>ã€ŒCreate Keyã€</strong> â†’ å¤åˆ¶ï¼ˆ<code style="background:#e5e7eb;padding:1px 4px;border-radius:3px;">sk-ant-...</code> å¼€å¤´ï¼‰<br>
        3. ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œç‚¹ã€Œè¿æ¥å¹¶æµ‹è¯•ã€
      </div>
    </div>

    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:#374151;font-weight:700;margin-bottom:6px;">API Key</div>
      <input id="dsApiKeyInput" type="password" placeholder="sk-ant-api03-... (Anthropic) æˆ– TikHub Key"
        style="width:100%;background:#f9fafb;border:1.5px solid #e5e7eb;border-radius:8px;padding:11px 14px;font-family:monospace;font-size:12px;color:#111827;outline:none;box-sizing:border-box;"
        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'"
      />
    </div>

    <div id="dsError" style="display:none;font-size:11px;padding:10px 12px;border-radius:6px;margin-bottom:10px;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;white-space:pre-line;line-height:1.6;"></div>
    <div id="dsSuccess" style="display:none;"></div>

    <div style="display:flex;gap:8px;">
      <button onclick="testAndSaveDataSource()" style="flex:1;padding:12px;background:#111827;border:none;border-radius:9px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        ğŸ”Œ è¿æ¥å¹¶æµ‹è¯•
      </button>
      <button onclick="clearDataSource()" style="padding:12px 16px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:9px;color:#6b7280;font-size:12px;cursor:pointer;font-family:'Noto Sans SC',sans-serif;">
        æ¸…é™¤
      </button>
    </div>
    <div style="font-size:10px;color:#9ca3af;margin-top:10px;text-align:center;">Key ä»…å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ ä»»ä½•æœåŠ¡å™¨</div>
  </div>
</div>

</body>
</html>
